<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deterministic malaria odin model • hanojoel</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Deterministic malaria odin model">
<meta property="og:description" content="Deterministic implementations of the Imperial College
    malaria transmission model using the pacakge odin.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">hanojoel</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/run_model.html">Run Base Model</a>
    </li>
    <li class="divider">
    <li>
      <a href="CONTRIBUTING.html">Contributing</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/hanojoel">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="contents col-md-9">
<div id="deterministic-r-model" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#deterministic-r-model" class="anchor"></a>deterministic-R-model</h1></div>
<p>This repository contains the R package version of the Imperial College malaria full transmission model.</p>
<div id="learning-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#learning-the-model" class="anchor"></a>Learning the model</h2>
<p>Assuming that you are new to the model, the first step is to read the papers that describe the model to get a good understanding of the theory behind it and how it works. To start with you should read:</p>
<ul>
<li>This <a href="http://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.1000324">Griffin 2010 paper</a> is the original paper explaining the model and shows the kind of work produced by it. Make sure to read the supplementary material, this explains most of the model in detail.</li>
<li>The <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3923296/">Griffin 2014 paper</a> explains further refinements to the model and again the supplementary material is a good place to start to get your head around how the model works.</li>
<li>This <a href="https://parasitesandvectors.biomedcentral.com/articles/10.1186/1756-3305-4-153">White 2011 paper</a> details the larval section of the model, which you will also need to be familiar with.</li>
</ul>
</div>
<div id="using-odin" class="section level2">
<h2 class="hasAnchor">
<a href="#using-odin" class="anchor"></a>Using Odin</h2>
<p>To run the model forward in time we need to solve a system of differential equations, we will do this using the R package that Rich Fitzjohn made called <a href="https://github.com/richfitz/odin">Odin</a>. The Odin package lets us write down the differential equations in a domain-specific language that is similar to R, it then converts the model that we have written down into C code and uses a numerical method to get an approximation of the solutions to the system of differential equations.</p>
<ul>
<li>
<a href="https://github.com/richfitz/odin#installation">Install the Odin package</a> and <a href="https://richfitz.github.io/odin/vignettes/odin.html">read the vignettes</a> to make sure you understand how to use Odin.</li>
<li>Install a couple more R packages that you will need to get the model running: <code><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages("statmod","ggplot2","reshape2","dplyr","magrittr")</a></code>
</li>
</ul>
</div>
<div id="installing-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#installing-the-model" class="anchor"></a>Installing the model</h2>
<p>Easiest way to install this model (until we can make it publicly available) is probably to clone this repository to your local machine, open the <code>hanojoel.Rproj</code> file in RStudio and then Ctrl+Shift+B to build and reload the package</p>
</div>
<div id="running-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#running-the-model" class="anchor"></a>Running the model</h2>
<p>Below is some code that shows how you might go about performing simple runs of the model</p>
<pre><code>  # load the model package (or have it built and reloaded as described above)
  library(hanojoel)

  # create a vector of age categories
  init_age &lt;- c(0,0.25,0.5,0.75,1,1.25,1.5,1.75,2,3.5,5,7.5,10,15,20,30,40,50,60,70,80)
  
  # provide a value of the annual EIR for this model run
  init_EIR &lt;- 10
  
  # provide a string for the admin 2 unit that you want to use the seasonality profile for
  admin_str &lt;- "Katanga"
  
  # provide the length of time (in days) that you want to run the model for
  time_period &lt;- 365*2
  
  # provide a value for the proportion of cases that are treated (referred to as ft in the paper)
  prop_treated &lt;- 0.6
  
  # run the model
  model_run &lt;- run_model(age=init_age, EIR=init_EIR, ft = prop_treated, admin2 = admin_str, time = time_period)
  
  # After this has finished, `model_run` will have 2 components. model_run$plot is a ggplot of the main compartments of the model
  # over time (summed over all age, biting &amp; intervention categories). model_run$dat is a list containing 
  # the estimated values for all of the compartments in the model. For example, model_run$dat$S will 
  # be a big 3-dimensional array with the indices relating to age, biting heterogeneity and intervention categories.
  </code></pre>
</div>
<div id="running-alternative-models" class="section level2">
<h2 class="hasAnchor">
<a href="#running-alternative-models" class="anchor"></a>Running alternative models</h2>
<p>The basic model used above has been adapted by various people, to add SMC, ivermectin courses, MDA etc. As such these model changes will have a number of diffrent parameters required within the actual odin model code (e.g. see “inst/extdata/odin_model_IVM_SMChet.R”). As such it becomes annoying having to do housekeeping about what parameters are required from the user, and creating the model becomes quite drawn out in terms of specifying what all the user paramaters are. As such there is an altenrative function <code>create_r_model</code> that will take some of the burden away, as demonstrated with this model that assumes a proportion of hrp2 deleted parasites exist.</p>
<pre><code># first we use the function, by specifying very similar parameters such as 
# the odin model path, and the initial EIR, ft, age categories, region etc.
wh &lt;- hanojoel:::create_r_model(odin_model_path = system.file("extdata/odin_model_hrp2.R",package = "hanojoel"),
                                het_brackets = 5,
                                age = init_age,
                                init_EIR = init_EIR,
                                init_ft = 0.4,
                                country = "Uganda",
                                admin2 = "Tororo")
</code></pre>
<p>The outpput of <code>create_r_model</code> returns a list with 4 elements.</p>
<ol>
<li>The first is an automatically created function called <code>generate_default_model</code>, which has scanned over the odin model and identified all the user required parameters before writing to a temp file the required function that pulls all the user required variables from your initial state solution.</li>
<li>The initial state solution is the second element in the list. This is a list that contains the equilibirum solution for the default parameters and also contains all the parameters used to create the initial solution. These parameters will also then be used when the model is run forwards, and thus if you want to run the model for the next year with a different value for <code>ft</code> you can change that here. This will no affect the initial solution, but simply the parameters that are used when running the deterministic model forward from the initial solution.</li>
<li>The actual odin model generated using the odin package.</li>
<li>The model parameter list that was used to create the initial solution.</li>
</ol>
<p>We can now use the following to create our model:</p>
<pre><code>mod &lt;- wh$generate_model_function(dat = wh$state,generator = wh$generator,dde = TRUE)</code></pre>
<p>We’ll see the model errors intially as we didn’t declare a value for <code>hrp2_prop</code>. This variable is not needed in the basic model, but was found to be needed in this extended model. Thus we should add it to out model state as an extra variable.</p>
<pre><code>wh$state$hrp2_prop &lt;- 0.1

mod &lt;- wh$generate_model_function(dat = wh$state,generator = wh$generator,dde = TRUE)
mod_run &lt;- mod$run(t = 1:90)
out &lt;- mod$transform_variables(mod_run)
plot(out$t,out$prev)

# If we wanted to increase the treatment for example:
wh$state$ft &lt;- 0.7
mod &lt;- wh$generate_model_function(dat = wh$state,generator = wh$generator,dde = TRUE)
mod_run &lt;- mod$run(t = 1:90)
out2 &lt;- mod$transform_variables(mod_run)

# And then compare the change in the prevalence
par(mfrow=c(2,1))
plot(out$t,out$prev)
plot(out2$t,out2$prev)

</code></pre>
<p>This will now work and should show how once you have the model set up you can then directly change model variables within the state list object to alter how the deterministic model is run.</p>
</div>
<div id="further-thoughts-and-rambles" class="section level2">
<h2 class="hasAnchor">
<a href="#further-thoughts-and-rambles" class="anchor"></a>Further thoughts and rambles</h2>
<p>Although the second way of running the model takes some of the burden from writing out the generate_model_function, it does start to become a bit messy still. In the above example it was only one variable that would affect how the model was run. We could have also specified this in the intial call to <code>create_r_model</code> like this:</p>
<pre><code>wh &lt;- hanojoel:::create_r_model(odin_model_path = system.file("extdata/odin_model_hrp2.R",package = "hanojoel"),
                                het_brackets = 5,
                                age = init_age,
                                init_EIR = init_EIR,
                                init_ft = 0.4,
                                country = "Uganda",
                                admin2 = "Tororo",
                                hrp2_prop = 0.1)
</code></pre>
<p>This will append the parameter to the model parameter list and it will appear in the intial state list object. If we had lots of variables we need to add then we could also specify these as a list:</p>
<pre><code>wh &lt;- hanojoel:::create_r_model(odin_model_path = system.file("extdata/odin_model_hrp2.R",package = "hanojoel"),
                                het_brackets = 5,
                                age = init_age,
                                init_EIR = init_EIR,
                                init_ft = 0.4,
                                country = "Uganda",
                                admin2 = "Tororo",
                                ... = list("hrp2_prop"=0.1, "IVM_start"=1)
                                )
</code></pre>
<p>However, this does not change how the initial solution was created as ultimately the intial solution doesn’t change at the moment, regardless of what model you want to run. This will be an issue if, for example your model has a 4th dimension, such as the IVM_SMChet model. As such there is now a catch in the <code>equilibirum_init_create</code> function that looks for a variable called <code>ncc</code>, so that if you declared <code>ncc</code> as an extra variable within <code>create_r_model</code> the <code>equilibirum_init_create</code> function will catch this.</p>
<p>This starts to become quite ugly and not reliably expandable, as you will need to change the <code>equilibirum_init_create</code> function every time a new model is needed that sets up the initial solution differently. It’s not perhaps the worst thing in the world, but it might be nice here to then specify a path name as a new variable to where your initial solution function is if it becomes very different.</p>
<p>The above is hoped to possibly explain how we might start thinking about how to make the malaria models more modular and operational in the future, but the above might not be the correct way yet.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>
<a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Joel Hellewell <br><small class="roles"> Author </small>  </li>
<li>Hannah Slater <br><small class="roles"> Author </small>  </li>
<li>OJ Watson <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>

  </div>
</div>

      <footer><div class="copyright">
  <p>Developed by Joel Hellewell, Hannah Slater, OJ Watson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9000.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
