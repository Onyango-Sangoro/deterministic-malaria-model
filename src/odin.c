// This file was automatically generated by odin.
// Do not edit by hand as changes will be lost.
#include <R.h>
#include <Rmath.h>
#include <Rinternals.h>
#include <R_ext/Rdynload.h>
#include <stdbool.h>

// Collect together all the parameters and transient memory
// required to run the model in a struct.
typedef struct odin_model_pars {
  int odin_use_dde;
  double initial_t;
  int dim_Ev;
  double *initial_Ev;
  int offset_Ev;
  int na;
  int nh;
  double ft;
  double eta;
  double rA;
  double rT;
  double rD;
  double rU;
  double rP;
  double dCM;
  double uCA;
  double dCA;
  double dB;
  double uB;
  double dID;
  double uD;
  double phi0;
  double phi1;
  double IC0;
  double kC;
  double b0;
  double b1;
  double kB;
  double IB0;
  double aD;
  double fD0;
  double gammaD;
  double d1;
  double ID0;
  double kD;
  double dE;
  double pi;
  double ssa0;
  double ssa1;
  double ssa2;
  double ssa3;
  double ssb1;
  double ssb2;
  double ssb3;
  double theta_c;
  double init_Sv;
  double init_Ev;
  double init_Iv;
  double cU;
  double cD;
  double cT;
  double gamma1;
  double omega;
  double delayGam;
  double delayMos;
  double dLL;
  double dPL;
  double dEL;
  double muLL;
  double muPL;
  double muEL;
  double gammaL;
  double mv0;
  double tau1;
  double tau2;
  double p10;
  double p2;
  double beta_larval0;
  double init_PL;
  double init_LL;
  double init_EL;
  double ITN_IRS_on;
  int num_int;
  double itn_cov;
  double irs_cov;
  double IRS_interval;
  double ITN_interval;
  double chi;
  double Q0;
  double bites_Bed;
  double bites_Indoors;
  double r_ITN0;
  double d_ITN0;
  double d_IRS0;
  double r_IRS0;
  double r_ITN1;
  double irs_loss;
  double itn_loss;
  int age59;
  int age05;
  int dim_age_rate;
  double *age_rate;
  int dim_het_wt;
  double *het_wt;
  int dim_init_S;
  int dim_init_S_1;
  int dim_init_S_2;
  int dim_init_S_3;
  int dim_init_S_12;
  double *init_S;
  int dim_S;
  int dim_S_1;
  int dim_S_2;
  int dim_S_3;
  int dim_S_12;
  double *initial_S;
  int offset_S;
  int dim_init_T;
  int dim_init_T_1;
  int dim_init_T_2;
  int dim_init_T_3;
  int dim_init_T_12;
  double *init_T;
  int dim_T;
  int dim_T_1;
  int dim_T_2;
  int dim_T_3;
  int dim_T_12;
  double *initial_T;
  int offset_T;
  int dim_init_D;
  int dim_init_D_1;
  int dim_init_D_2;
  int dim_init_D_3;
  int dim_init_D_12;
  double *init_D;
  int dim_D;
  int dim_D_1;
  int dim_D_2;
  int dim_D_3;
  int dim_D_12;
  double *initial_D;
  int offset_D;
  int dim_init_A;
  int dim_init_A_1;
  int dim_init_A_2;
  int dim_init_A_3;
  int dim_init_A_12;
  double *init_A;
  int dim_A;
  int dim_A_1;
  int dim_A_2;
  int dim_A_3;
  int dim_A_12;
  double *initial_A;
  int offset_A;
  int dim_init_U;
  int dim_init_U_1;
  int dim_init_U_2;
  int dim_init_U_3;
  int dim_init_U_12;
  double *init_U;
  int dim_U;
  int dim_U_1;
  int dim_U_2;
  int dim_U_3;
  int dim_U_12;
  double *initial_U;
  int offset_U;
  int dim_init_P;
  int dim_init_P_1;
  int dim_init_P_2;
  int dim_init_P_3;
  int dim_init_P_12;
  double *init_P;
  int dim_P;
  int dim_P_1;
  int dim_P_2;
  int dim_P_3;
  int dim_P_12;
  double *initial_P;
  int offset_P;
  int dim_Y;
  int dim_Y_1;
  int dim_Y_2;
  int dim_Y_3;
  int dim_Y_12;
  double *Y;
  int dim_clin_inc;
  int dim_clin_inc_1;
  int dim_clin_inc_2;
  int dim_clin_inc_3;
  int dim_clin_inc_12;
  double *clin_inc;
  int dim_x_I;
  double *x_I;
  int dim_init_ICM;
  int dim_init_ICM_1;
  int dim_init_ICM_2;
  int dim_init_ICM_3;
  int dim_init_ICM_12;
  double *init_ICM;
  int dim_ICM;
  int dim_ICM_1;
  int dim_ICM_2;
  int dim_ICM_3;
  int dim_ICM_12;
  double *initial_ICM;
  int offset_ICM;
  int dim_init_ICA;
  int dim_init_ICA_1;
  int dim_init_ICA_2;
  int dim_init_ICA_3;
  int dim_init_ICA_12;
  double *init_ICA;
  int dim_ICA;
  int dim_ICA_1;
  int dim_ICA_2;
  int dim_ICA_3;
  int dim_ICA_12;
  double *initial_ICA;
  int offset_ICA;
  int dim_IC;
  int dim_IC_1;
  int dim_IC_2;
  int dim_IC_3;
  int dim_IC_12;
  double *IC;
  int dim_phi;
  int dim_phi_1;
  int dim_phi_2;
  int dim_phi_3;
  int dim_phi_12;
  double *phi;
  int dim_init_IB;
  int dim_init_IB_1;
  int dim_init_IB_2;
  int dim_init_IB_3;
  int dim_init_IB_12;
  double *init_IB;
  int dim_IB;
  int dim_IB_1;
  int dim_IB_2;
  int dim_IB_3;
  int dim_IB_12;
  double *initial_IB;
  int offset_IB;
  int dim_b;
  int dim_b_1;
  int dim_b_2;
  int dim_b_3;
  int dim_b_12;
  double *b;
  double *delay_b;
  int dim_init_ID;
  int dim_init_ID_1;
  int dim_init_ID_2;
  int dim_init_ID_3;
  int dim_init_ID_12;
  double *init_ID;
  int dim_ID;
  int dim_ID_1;
  int dim_ID_2;
  int dim_ID_3;
  int dim_ID_12;
  double *initial_ID;
  int offset_ID;
  int dim_age;
  double *age;
  int dim_fd;
  double *fd;
  int dim_p_det;
  int dim_p_det_1;
  int dim_p_det_2;
  int dim_p_det_3;
  int dim_p_det_12;
  double *p_det;
  double *delay_p_det;
  int dim_FOI_lag;
  int dim_FOI_lag_1;
  int dim_FOI_lag_2;
  int dim_FOI_lag_3;
  int dim_FOI_lag_12;
  double *FOI_lag;
  double *delay_FOI_lag;
  int dim_FOI;
  int dim_FOI_1;
  int dim_FOI_2;
  int dim_FOI_3;
  int dim_FOI_12;
  double *FOI;
  int dim_foi_age;
  double *foi_age;
  int dim_rel_foi;
  double *rel_foi;
  int dim_EIR;
  int dim_EIR_1;
  int dim_EIR_2;
  int dim_EIR_3;
  int dim_EIR_12;
  double *EIR;
  double *delay_EIR;
  double initial_Sv;
  double initial_Iv;
  int dim_cA;
  int dim_cA_1;
  int dim_cA_2;
  int dim_cA_3;
  int dim_cA_12;
  double *cA;
  double *delay_cA;
  int dim_FOIvijk;
  int dim_FOIvijk_1;
  int dim_FOIvijk_2;
  int dim_FOIvijk_3;
  int dim_FOIvijk_12;
  double *FOIvijk;
  double *delay_FOIvijk;
  double b_lambda;
  double initial_PL;
  double initial_LL;
  double initial_EL;
  int dim_cov;
  double *cov;
  int offset_output_cov;
  int dim_w;
  double *w;
  double *delay_w;
  int dim_yy;
  double *yy;
  double *delay_yy;
  int dim_z;
  double *z;
  double *delay_z;
  int dim_zhi;
  double *zhi;
  double *delay_zhi;
  int dim_whi;
  double *whi;
  double *delay_whi;
  int dim_av_mosq;
  double *av_mosq;
  double *delay_av_mosq;
  int dim_av_human;
  double *av_human;
  double *delay_av_human;
  int dim_den;
  double *den;
  int dim_prev0to59;
  int dim_prev0to59_1;
  int dim_prev0to59_2;
  int dim_prev0to59_3;
  int dim_prev0to59_12;
  double *prev0to59;
  int dim_clin_inc0to5;
  int dim_clin_inc0to5_1;
  int dim_clin_inc0to5_2;
  int dim_clin_inc0to5_3;
  int dim_clin_inc0to5_12;
  double *clin_inc0to5;
  int dim_delay_FOI;
  int *delay_i_FOI;
  double *delay_state_FOI;
  int dim_delay_FOIv;
  int *delay_i_FOIv;
  double *delay_state_FOIv;
  int dim_delay_incv;
  int *delay_i_incv;
  double *delay_state_incv;
  int dim;
  int dim_output;
} odin_model_pars;
odin_model_pars* odin_model_get_pointer(SEXP odin_model_ptr, int closed_error);
SEXP odin_model_set_user(odin_model_pars *odin_model_p, SEXP user);

SEXP get_ds_pars();
double fmodr(double x, double y);
void lagvalue_dde(double t, int *idx, size_t dim_idx, double *state);
void lagvalue_ds(double t, int *idx, int dim_idx, double *state);
int get_user_int(SEXP user, const char *name, int default_value);
double get_user_double(SEXP user, const char *name, double default_value);
void get_user_array(SEXP user, const char *name, bool is_real, void *dest, int nd, ...);
SEXP get_user_array_check_rank(SEXP user, const char *name, int nd);
void get_user_array_copy(SEXP el, const char *name, bool is_real, void *dest);
void odin_set_dim(SEXP target, int nd, ...);
SEXP get_list_element(SEXP list, const char *name);
double odin_sum1(double *x, int from_i, int to_i);
double odin_sum3(double *x, int from_i, int to_i, int from_j, int to_j, int from_k, int to_k, int dim_x_1, int dim_x_12);

// Create the pointer; this will establish the struct, allocate
// memory for things that are constant size, and initialize
// constant variables
static void odin_model_finalize(SEXP odin_model_ptr);
SEXP odin_model_create(SEXP user, SEXP odin_use_dde) {
  odin_model_pars *odin_model_p = (odin_model_pars*) Calloc(1, odin_model_pars);
  odin_model_p->dim_Ev = 10;
  odin_model_p->initial_Ev = (double*) Calloc(odin_model_p->dim_Ev, double);
  odin_model_p->offset_Ev = 5;
  odin_model_p->na = NA_INTEGER;
  odin_model_p->nh = NA_INTEGER;
  odin_model_p->ft = NA_REAL;
  odin_model_p->eta = NA_REAL;
  odin_model_p->rA = NA_REAL;
  odin_model_p->rT = NA_REAL;
  odin_model_p->rD = NA_REAL;
  odin_model_p->rU = NA_REAL;
  odin_model_p->rP = NA_REAL;
  odin_model_p->dCM = NA_REAL;
  odin_model_p->uCA = NA_REAL;
  odin_model_p->dCA = NA_REAL;
  odin_model_p->dB = NA_REAL;
  odin_model_p->uB = NA_REAL;
  odin_model_p->dID = NA_REAL;
  odin_model_p->uD = NA_REAL;
  odin_model_p->phi0 = NA_REAL;
  odin_model_p->phi1 = NA_REAL;
  odin_model_p->IC0 = NA_REAL;
  odin_model_p->kC = NA_REAL;
  odin_model_p->b0 = NA_REAL;
  odin_model_p->b1 = NA_REAL;
  odin_model_p->kB = NA_REAL;
  odin_model_p->IB0 = NA_REAL;
  odin_model_p->aD = NA_REAL;
  odin_model_p->fD0 = NA_REAL;
  odin_model_p->gammaD = NA_REAL;
  odin_model_p->d1 = NA_REAL;
  odin_model_p->ID0 = NA_REAL;
  odin_model_p->kD = NA_REAL;
  odin_model_p->dE = NA_REAL;
  odin_model_p->pi = NA_REAL;
  odin_model_p->ssa0 = NA_REAL;
  odin_model_p->ssa1 = NA_REAL;
  odin_model_p->ssa2 = NA_REAL;
  odin_model_p->ssa3 = NA_REAL;
  odin_model_p->ssb1 = NA_REAL;
  odin_model_p->ssb2 = NA_REAL;
  odin_model_p->ssb3 = NA_REAL;
  odin_model_p->theta_c = NA_REAL;
  odin_model_p->init_Sv = NA_REAL;
  odin_model_p->init_Ev = NA_REAL;
  odin_model_p->init_Iv = NA_REAL;
  odin_model_p->cU = NA_REAL;
  odin_model_p->cD = NA_REAL;
  odin_model_p->cT = NA_REAL;
  odin_model_p->gamma1 = NA_REAL;
  odin_model_p->omega = NA_REAL;
  odin_model_p->delayGam = NA_REAL;
  odin_model_p->delayMos = NA_REAL;
  odin_model_p->dLL = NA_REAL;
  odin_model_p->dPL = NA_REAL;
  odin_model_p->dEL = NA_REAL;
  odin_model_p->muLL = NA_REAL;
  odin_model_p->muPL = NA_REAL;
  odin_model_p->muEL = NA_REAL;
  odin_model_p->gammaL = NA_REAL;
  odin_model_p->mv0 = NA_REAL;
  odin_model_p->tau1 = NA_REAL;
  odin_model_p->tau2 = NA_REAL;
  odin_model_p->p10 = NA_REAL;
  odin_model_p->p2 = NA_REAL;
  odin_model_p->beta_larval0 = NA_REAL;
  odin_model_p->init_PL = NA_REAL;
  odin_model_p->init_LL = NA_REAL;
  odin_model_p->init_EL = NA_REAL;
  odin_model_p->ITN_IRS_on = NA_REAL;
  odin_model_p->num_int = NA_INTEGER;
  odin_model_p->itn_cov = NA_REAL;
  odin_model_p->irs_cov = NA_REAL;
  odin_model_p->IRS_interval = NA_REAL;
  odin_model_p->ITN_interval = NA_REAL;
  odin_model_p->chi = NA_REAL;
  odin_model_p->Q0 = NA_REAL;
  odin_model_p->bites_Bed = NA_REAL;
  odin_model_p->bites_Indoors = NA_REAL;
  odin_model_p->r_ITN0 = NA_REAL;
  odin_model_p->d_ITN0 = NA_REAL;
  odin_model_p->d_IRS0 = NA_REAL;
  odin_model_p->r_IRS0 = NA_REAL;
  odin_model_p->r_ITN1 = NA_REAL;
  odin_model_p->irs_loss = NA_REAL;
  odin_model_p->itn_loss = NA_REAL;
  odin_model_p->age59 = NA_INTEGER;
  odin_model_p->age05 = NA_INTEGER;
  odin_model_p->age_rate = NULL;
  odin_model_p->het_wt = NULL;
  odin_model_p->init_S = NULL;
  odin_model_p->initial_S = NULL;
  odin_model_p->init_T = NULL;
  odin_model_p->initial_T = NULL;
  odin_model_p->init_D = NULL;
  odin_model_p->initial_D = NULL;
  odin_model_p->init_A = NULL;
  odin_model_p->initial_A = NULL;
  odin_model_p->init_U = NULL;
  odin_model_p->initial_U = NULL;
  odin_model_p->init_P = NULL;
  odin_model_p->initial_P = NULL;
  odin_model_p->Y = NULL;
  odin_model_p->clin_inc = NULL;
  odin_model_p->x_I = NULL;
  odin_model_p->init_ICM = NULL;
  odin_model_p->initial_ICM = NULL;
  odin_model_p->init_ICA = NULL;
  odin_model_p->initial_ICA = NULL;
  odin_model_p->IC = NULL;
  odin_model_p->phi = NULL;
  odin_model_p->init_IB = NULL;
  odin_model_p->initial_IB = NULL;
  odin_model_p->b = NULL;
  odin_model_p->delay_b = NULL;
  odin_model_p->init_ID = NULL;
  odin_model_p->initial_ID = NULL;
  odin_model_p->age = NULL;
  odin_model_p->fd = NULL;
  odin_model_p->p_det = NULL;
  odin_model_p->delay_p_det = NULL;
  odin_model_p->FOI_lag = NULL;
  odin_model_p->delay_FOI_lag = NULL;
  odin_model_p->FOI = NULL;
  odin_model_p->foi_age = NULL;
  odin_model_p->rel_foi = NULL;
  odin_model_p->EIR = NULL;
  odin_model_p->delay_EIR = NULL;
  odin_model_p->cA = NULL;
  odin_model_p->delay_cA = NULL;
  odin_model_p->FOIvijk = NULL;
  odin_model_p->delay_FOIvijk = NULL;
  odin_model_p->cov = NULL;
  odin_model_p->w = NULL;
  odin_model_p->delay_w = NULL;
  odin_model_p->yy = NULL;
  odin_model_p->delay_yy = NULL;
  odin_model_p->z = NULL;
  odin_model_p->delay_z = NULL;
  odin_model_p->zhi = NULL;
  odin_model_p->delay_zhi = NULL;
  odin_model_p->whi = NULL;
  odin_model_p->delay_whi = NULL;
  odin_model_p->av_mosq = NULL;
  odin_model_p->delay_av_mosq = NULL;
  odin_model_p->av_human = NULL;
  odin_model_p->delay_av_human = NULL;
  odin_model_p->den = NULL;
  odin_model_p->prev0to59 = NULL;
  odin_model_p->clin_inc0to5 = NULL;
  odin_model_p->delay_i_FOI = NULL;
  odin_model_p->delay_state_FOI = NULL;
  odin_model_p->delay_i_FOIv = NULL;
  odin_model_p->delay_state_FOIv = NULL;
  odin_model_p->delay_i_incv = NULL;
  odin_model_p->delay_state_incv = NULL;
  SEXP odin_model_ptr = PROTECT(R_MakeExternalPtr(odin_model_p, R_NilValue, R_NilValue));
  R_RegisterCFinalizer(odin_model_ptr, odin_model_finalize);
  odin_model_set_user(odin_model_p, user);
  odin_model_p->odin_use_dde = INTEGER(odin_use_dde)[0];
  UNPROTECT(1);
  return odin_model_ptr;
}

// Set user-supplied parameter values.
SEXP odin_model_set_user(odin_model_pars *odin_model_p, SEXP user) {
  odin_model_p->na = get_user_int(user, "na", odin_model_p->na);
  odin_model_p->nh = get_user_int(user, "nh", odin_model_p->nh);
  odin_model_p->ft = get_user_double(user, "ft", odin_model_p->ft);
  odin_model_p->eta = get_user_double(user, "eta", odin_model_p->eta);
  odin_model_p->rA = get_user_double(user, "rA", odin_model_p->rA);
  odin_model_p->rT = get_user_double(user, "rT", odin_model_p->rT);
  odin_model_p->rD = get_user_double(user, "rD", odin_model_p->rD);
  odin_model_p->rU = get_user_double(user, "rU", odin_model_p->rU);
  odin_model_p->rP = get_user_double(user, "rP", odin_model_p->rP);
  odin_model_p->dCM = get_user_double(user, "dCM", odin_model_p->dCM);
  odin_model_p->uCA = get_user_double(user, "uCA", odin_model_p->uCA);
  odin_model_p->dCA = get_user_double(user, "dCA", odin_model_p->dCA);
  odin_model_p->dB = get_user_double(user, "dB", odin_model_p->dB);
  odin_model_p->uB = get_user_double(user, "uB", odin_model_p->uB);
  odin_model_p->dID = get_user_double(user, "dID", odin_model_p->dID);
  odin_model_p->uD = get_user_double(user, "uD", odin_model_p->uD);
  odin_model_p->phi0 = get_user_double(user, "phi0", odin_model_p->phi0);
  odin_model_p->phi1 = get_user_double(user, "phi1", odin_model_p->phi1);
  odin_model_p->IC0 = get_user_double(user, "IC0", odin_model_p->IC0);
  odin_model_p->kC = get_user_double(user, "kC", odin_model_p->kC);
  odin_model_p->b0 = get_user_double(user, "b0", odin_model_p->b0);
  odin_model_p->b1 = get_user_double(user, "b1", odin_model_p->b1);
  odin_model_p->kB = get_user_double(user, "kB", odin_model_p->kB);
  odin_model_p->IB0 = get_user_double(user, "IB0", odin_model_p->IB0);
  odin_model_p->aD = get_user_double(user, "aD", odin_model_p->aD);
  odin_model_p->fD0 = get_user_double(user, "fD0", odin_model_p->fD0);
  odin_model_p->gammaD = get_user_double(user, "gammaD", odin_model_p->gammaD);
  odin_model_p->d1 = get_user_double(user, "d1", odin_model_p->d1);
  odin_model_p->ID0 = get_user_double(user, "ID0", odin_model_p->ID0);
  odin_model_p->kD = get_user_double(user, "kD", odin_model_p->kD);
  odin_model_p->dE = get_user_double(user, "dE", odin_model_p->dE);
  odin_model_p->pi = get_user_double(user, "pi", odin_model_p->pi);
  odin_model_p->ssa0 = get_user_double(user, "ssa0", odin_model_p->ssa0);
  odin_model_p->ssa1 = get_user_double(user, "ssa1", odin_model_p->ssa1);
  odin_model_p->ssa2 = get_user_double(user, "ssa2", odin_model_p->ssa2);
  odin_model_p->ssa3 = get_user_double(user, "ssa3", odin_model_p->ssa3);
  odin_model_p->ssb1 = get_user_double(user, "ssb1", odin_model_p->ssb1);
  odin_model_p->ssb2 = get_user_double(user, "ssb2", odin_model_p->ssb2);
  odin_model_p->ssb3 = get_user_double(user, "ssb3", odin_model_p->ssb3);
  odin_model_p->theta_c = get_user_double(user, "theta_c", odin_model_p->theta_c);
  odin_model_p->init_Sv = get_user_double(user, "init_Sv", odin_model_p->init_Sv);
  odin_model_p->init_Ev = get_user_double(user, "init_Ev", odin_model_p->init_Ev);
  odin_model_p->init_Iv = get_user_double(user, "init_Iv", odin_model_p->init_Iv);
  odin_model_p->cU = get_user_double(user, "cU", odin_model_p->cU);
  odin_model_p->cD = get_user_double(user, "cD", odin_model_p->cD);
  odin_model_p->cT = get_user_double(user, "cT", odin_model_p->cT);
  odin_model_p->gamma1 = get_user_double(user, "gamma1", odin_model_p->gamma1);
  odin_model_p->omega = get_user_double(user, "omega", odin_model_p->omega);
  odin_model_p->delayGam = get_user_double(user, "delayGam", odin_model_p->delayGam);
  odin_model_p->delayMos = get_user_double(user, "delayMos", odin_model_p->delayMos);
  odin_model_p->dLL = get_user_double(user, "dLL", odin_model_p->dLL);
  odin_model_p->dPL = get_user_double(user, "dPL", odin_model_p->dPL);
  odin_model_p->dEL = get_user_double(user, "dEL", odin_model_p->dEL);
  odin_model_p->muLL = get_user_double(user, "muLL", odin_model_p->muLL);
  odin_model_p->muPL = get_user_double(user, "muPL", odin_model_p->muPL);
  odin_model_p->muEL = get_user_double(user, "muEL", odin_model_p->muEL);
  odin_model_p->gammaL = get_user_double(user, "gammaL", odin_model_p->gammaL);
  odin_model_p->mv0 = get_user_double(user, "mv0", odin_model_p->mv0);
  odin_model_p->tau1 = get_user_double(user, "tau1", odin_model_p->tau1);
  odin_model_p->tau2 = get_user_double(user, "tau2", odin_model_p->tau2);
  odin_model_p->p10 = get_user_double(user, "p10", odin_model_p->p10);
  odin_model_p->p2 = get_user_double(user, "p2", odin_model_p->p2);
  odin_model_p->beta_larval0 = get_user_double(user, "beta_larval0", odin_model_p->beta_larval0);
  odin_model_p->init_PL = get_user_double(user, "init_PL", odin_model_p->init_PL);
  odin_model_p->init_LL = get_user_double(user, "init_LL", odin_model_p->init_LL);
  odin_model_p->init_EL = get_user_double(user, "init_EL", odin_model_p->init_EL);
  odin_model_p->ITN_IRS_on = get_user_double(user, "ITN_IRS_on", odin_model_p->ITN_IRS_on);
  odin_model_p->num_int = get_user_int(user, "num_int", odin_model_p->num_int);
  odin_model_p->itn_cov = get_user_double(user, "itn_cov", odin_model_p->itn_cov);
  odin_model_p->irs_cov = get_user_double(user, "irs_cov", odin_model_p->irs_cov);
  odin_model_p->IRS_interval = get_user_double(user, "IRS_interval", odin_model_p->IRS_interval);
  odin_model_p->ITN_interval = get_user_double(user, "ITN_interval", odin_model_p->ITN_interval);
  odin_model_p->chi = get_user_double(user, "chi", odin_model_p->chi);
  odin_model_p->Q0 = get_user_double(user, "Q0", odin_model_p->Q0);
  odin_model_p->bites_Bed = get_user_double(user, "bites_Bed", odin_model_p->bites_Bed);
  odin_model_p->bites_Indoors = get_user_double(user, "bites_Indoors", odin_model_p->bites_Indoors);
  odin_model_p->r_ITN0 = get_user_double(user, "r_ITN0", odin_model_p->r_ITN0);
  odin_model_p->d_ITN0 = get_user_double(user, "d_ITN0", odin_model_p->d_ITN0);
  odin_model_p->d_IRS0 = get_user_double(user, "d_IRS0", odin_model_p->d_IRS0);
  odin_model_p->r_IRS0 = get_user_double(user, "r_IRS0", odin_model_p->r_IRS0);
  odin_model_p->r_ITN1 = get_user_double(user, "r_ITN1", odin_model_p->r_ITN1);
  odin_model_p->irs_loss = get_user_double(user, "irs_loss", odin_model_p->irs_loss);
  odin_model_p->itn_loss = get_user_double(user, "itn_loss", odin_model_p->itn_loss);
  odin_model_p->age59 = get_user_int(user, "age59", odin_model_p->age59);
  odin_model_p->age05 = get_user_int(user, "age05", odin_model_p->age05);
  Free(odin_model_p->age_rate);
  odin_model_p->dim_age_rate = odin_model_p->na;
  odin_model_p->age_rate = (double*) Calloc(odin_model_p->dim_age_rate, double);
  get_user_array(user, "age_rate", true, odin_model_p->age_rate, 1, odin_model_p->dim_age_rate);
  Free(odin_model_p->het_wt);
  odin_model_p->dim_het_wt = odin_model_p->nh;
  odin_model_p->het_wt = (double*) Calloc(odin_model_p->dim_het_wt, double);
  get_user_array(user, "het_wt", true, odin_model_p->het_wt, 1, odin_model_p->dim_het_wt);
  Free(odin_model_p->init_S);
  odin_model_p->dim_init_S_1 = odin_model_p->na;
  odin_model_p->dim_init_S_2 = odin_model_p->nh;
  odin_model_p->dim_init_S_3 = odin_model_p->num_int;
  odin_model_p->dim_init_S_12 = odin_model_p->dim_init_S_1 * odin_model_p->dim_init_S_2;
  odin_model_p->dim_init_S = odin_model_p->dim_init_S_1 * odin_model_p->dim_init_S_2 * odin_model_p->dim_init_S_3;
  odin_model_p->init_S = (double*) Calloc(odin_model_p->dim_init_S, double);
  get_user_array(user, "init_S", true, odin_model_p->init_S, 3, odin_model_p->dim_init_S_1, odin_model_p->dim_init_S_2, odin_model_p->dim_init_S_3);
  Free(odin_model_p->initial_S);
  odin_model_p->dim_S_1 = odin_model_p->na;
  odin_model_p->dim_S_2 = odin_model_p->nh;
  odin_model_p->dim_S_3 = odin_model_p->num_int;
  odin_model_p->dim_S_12 = odin_model_p->dim_S_1 * odin_model_p->dim_S_2;
  odin_model_p->dim_S = odin_model_p->dim_S_1 * odin_model_p->dim_S_2 * odin_model_p->dim_S_3;
  odin_model_p->initial_S = (double*) Calloc(odin_model_p->dim_S, double);
  odin_model_p->offset_S = 5 + odin_model_p->dim_Ev;
  for (int i = 0; i < odin_model_p->dim_S_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_S_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_S_3; ++k) {
        odin_model_p->initial_S[i + j * odin_model_p->dim_S_1 + k * odin_model_p->dim_S_12] = odin_model_p->init_S[i + j * odin_model_p->dim_init_S_1 + k * odin_model_p->dim_init_S_12];
      }
    }
  }
  Free(odin_model_p->init_T);
  odin_model_p->dim_init_T_1 = odin_model_p->na;
  odin_model_p->dim_init_T_2 = odin_model_p->nh;
  odin_model_p->dim_init_T_3 = odin_model_p->num_int;
  odin_model_p->dim_init_T_12 = odin_model_p->dim_init_T_1 * odin_model_p->dim_init_T_2;
  odin_model_p->dim_init_T = odin_model_p->dim_init_T_1 * odin_model_p->dim_init_T_2 * odin_model_p->dim_init_T_3;
  odin_model_p->init_T = (double*) Calloc(odin_model_p->dim_init_T, double);
  get_user_array(user, "init_T", true, odin_model_p->init_T, 3, odin_model_p->dim_init_T_1, odin_model_p->dim_init_T_2, odin_model_p->dim_init_T_3);
  Free(odin_model_p->initial_T);
  odin_model_p->dim_T_1 = odin_model_p->na;
  odin_model_p->dim_T_2 = odin_model_p->nh;
  odin_model_p->dim_T_3 = odin_model_p->num_int;
  odin_model_p->dim_T_12 = odin_model_p->dim_T_1 * odin_model_p->dim_T_2;
  odin_model_p->dim_T = odin_model_p->dim_T_1 * odin_model_p->dim_T_2 * odin_model_p->dim_T_3;
  odin_model_p->initial_T = (double*) Calloc(odin_model_p->dim_T, double);
  odin_model_p->offset_T = odin_model_p->offset_S + odin_model_p->dim_S;
  for (int i = 0; i < odin_model_p->dim_T_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_T_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_T_3; ++k) {
        odin_model_p->initial_T[i + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12] = odin_model_p->init_T[i + j * odin_model_p->dim_init_T_1 + k * odin_model_p->dim_init_T_12];
      }
    }
  }
  Free(odin_model_p->init_D);
  odin_model_p->dim_init_D_1 = odin_model_p->na;
  odin_model_p->dim_init_D_2 = odin_model_p->nh;
  odin_model_p->dim_init_D_3 = odin_model_p->num_int;
  odin_model_p->dim_init_D_12 = odin_model_p->dim_init_D_1 * odin_model_p->dim_init_D_2;
  odin_model_p->dim_init_D = odin_model_p->dim_init_D_1 * odin_model_p->dim_init_D_2 * odin_model_p->dim_init_D_3;
  odin_model_p->init_D = (double*) Calloc(odin_model_p->dim_init_D, double);
  get_user_array(user, "init_D", true, odin_model_p->init_D, 3, odin_model_p->dim_init_D_1, odin_model_p->dim_init_D_2, odin_model_p->dim_init_D_3);
  Free(odin_model_p->initial_D);
  odin_model_p->dim_D_1 = odin_model_p->na;
  odin_model_p->dim_D_2 = odin_model_p->nh;
  odin_model_p->dim_D_3 = odin_model_p->num_int;
  odin_model_p->dim_D_12 = odin_model_p->dim_D_1 * odin_model_p->dim_D_2;
  odin_model_p->dim_D = odin_model_p->dim_D_1 * odin_model_p->dim_D_2 * odin_model_p->dim_D_3;
  odin_model_p->initial_D = (double*) Calloc(odin_model_p->dim_D, double);
  odin_model_p->offset_D = odin_model_p->offset_T + odin_model_p->dim_T;
  for (int i = 0; i < odin_model_p->dim_D_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_D_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_D_3; ++k) {
        odin_model_p->initial_D[i + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12] = odin_model_p->init_D[i + j * odin_model_p->dim_init_D_1 + k * odin_model_p->dim_init_D_12];
      }
    }
  }
  Free(odin_model_p->init_A);
  odin_model_p->dim_init_A_1 = odin_model_p->na;
  odin_model_p->dim_init_A_2 = odin_model_p->nh;
  odin_model_p->dim_init_A_3 = odin_model_p->num_int;
  odin_model_p->dim_init_A_12 = odin_model_p->dim_init_A_1 * odin_model_p->dim_init_A_2;
  odin_model_p->dim_init_A = odin_model_p->dim_init_A_1 * odin_model_p->dim_init_A_2 * odin_model_p->dim_init_A_3;
  odin_model_p->init_A = (double*) Calloc(odin_model_p->dim_init_A, double);
  get_user_array(user, "init_A", true, odin_model_p->init_A, 3, odin_model_p->dim_init_A_1, odin_model_p->dim_init_A_2, odin_model_p->dim_init_A_3);
  Free(odin_model_p->initial_A);
  odin_model_p->dim_A_1 = odin_model_p->na;
  odin_model_p->dim_A_2 = odin_model_p->nh;
  odin_model_p->dim_A_3 = odin_model_p->num_int;
  odin_model_p->dim_A_12 = odin_model_p->dim_A_1 * odin_model_p->dim_A_2;
  odin_model_p->dim_A = odin_model_p->dim_A_1 * odin_model_p->dim_A_2 * odin_model_p->dim_A_3;
  odin_model_p->initial_A = (double*) Calloc(odin_model_p->dim_A, double);
  odin_model_p->offset_A = odin_model_p->offset_D + odin_model_p->dim_D;
  for (int i = 0; i < odin_model_p->dim_A_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_A_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_A_3; ++k) {
        odin_model_p->initial_A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] = odin_model_p->init_A[i + j * odin_model_p->dim_init_A_1 + k * odin_model_p->dim_init_A_12];
      }
    }
  }
  Free(odin_model_p->init_U);
  odin_model_p->dim_init_U_1 = odin_model_p->na;
  odin_model_p->dim_init_U_2 = odin_model_p->nh;
  odin_model_p->dim_init_U_3 = odin_model_p->num_int;
  odin_model_p->dim_init_U_12 = odin_model_p->dim_init_U_1 * odin_model_p->dim_init_U_2;
  odin_model_p->dim_init_U = odin_model_p->dim_init_U_1 * odin_model_p->dim_init_U_2 * odin_model_p->dim_init_U_3;
  odin_model_p->init_U = (double*) Calloc(odin_model_p->dim_init_U, double);
  get_user_array(user, "init_U", true, odin_model_p->init_U, 3, odin_model_p->dim_init_U_1, odin_model_p->dim_init_U_2, odin_model_p->dim_init_U_3);
  Free(odin_model_p->initial_U);
  odin_model_p->dim_U_1 = odin_model_p->na;
  odin_model_p->dim_U_2 = odin_model_p->nh;
  odin_model_p->dim_U_3 = odin_model_p->num_int;
  odin_model_p->dim_U_12 = odin_model_p->dim_U_1 * odin_model_p->dim_U_2;
  odin_model_p->dim_U = odin_model_p->dim_U_1 * odin_model_p->dim_U_2 * odin_model_p->dim_U_3;
  odin_model_p->initial_U = (double*) Calloc(odin_model_p->dim_U, double);
  odin_model_p->offset_U = odin_model_p->offset_A + odin_model_p->dim_A;
  for (int i = 0; i < odin_model_p->dim_U_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_U_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_U_3; ++k) {
        odin_model_p->initial_U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12] = odin_model_p->init_U[i + j * odin_model_p->dim_init_U_1 + k * odin_model_p->dim_init_U_12];
      }
    }
  }
  Free(odin_model_p->init_P);
  odin_model_p->dim_init_P_1 = odin_model_p->na;
  odin_model_p->dim_init_P_2 = odin_model_p->nh;
  odin_model_p->dim_init_P_3 = odin_model_p->num_int;
  odin_model_p->dim_init_P_12 = odin_model_p->dim_init_P_1 * odin_model_p->dim_init_P_2;
  odin_model_p->dim_init_P = odin_model_p->dim_init_P_1 * odin_model_p->dim_init_P_2 * odin_model_p->dim_init_P_3;
  odin_model_p->init_P = (double*) Calloc(odin_model_p->dim_init_P, double);
  get_user_array(user, "init_P", true, odin_model_p->init_P, 3, odin_model_p->dim_init_P_1, odin_model_p->dim_init_P_2, odin_model_p->dim_init_P_3);
  Free(odin_model_p->initial_P);
  odin_model_p->dim_P_1 = odin_model_p->na;
  odin_model_p->dim_P_2 = odin_model_p->nh;
  odin_model_p->dim_P_3 = odin_model_p->num_int;
  odin_model_p->dim_P_12 = odin_model_p->dim_P_1 * odin_model_p->dim_P_2;
  odin_model_p->dim_P = odin_model_p->dim_P_1 * odin_model_p->dim_P_2 * odin_model_p->dim_P_3;
  odin_model_p->initial_P = (double*) Calloc(odin_model_p->dim_P, double);
  odin_model_p->offset_P = odin_model_p->offset_U + odin_model_p->dim_U;
  for (int i = 0; i < odin_model_p->dim_P_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_P_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_P_3; ++k) {
        odin_model_p->initial_P[i + j * odin_model_p->dim_P_1 + k * odin_model_p->dim_P_12] = odin_model_p->init_P[i + j * odin_model_p->dim_init_P_1 + k * odin_model_p->dim_init_P_12];
      }
    }
  }
  Free(odin_model_p->Y);
  odin_model_p->dim_Y_1 = odin_model_p->na;
  odin_model_p->dim_Y_2 = odin_model_p->nh;
  odin_model_p->dim_Y_3 = odin_model_p->num_int;
  odin_model_p->dim_Y_12 = odin_model_p->dim_Y_1 * odin_model_p->dim_Y_2;
  odin_model_p->dim_Y = odin_model_p->dim_Y_1 * odin_model_p->dim_Y_2 * odin_model_p->dim_Y_3;
  odin_model_p->Y = (double*) Calloc(odin_model_p->dim_Y, double);
  Free(odin_model_p->clin_inc);
  odin_model_p->dim_clin_inc_1 = odin_model_p->na;
  odin_model_p->dim_clin_inc_2 = odin_model_p->nh;
  odin_model_p->dim_clin_inc_3 = odin_model_p->num_int;
  odin_model_p->dim_clin_inc_12 = odin_model_p->dim_clin_inc_1 * odin_model_p->dim_clin_inc_2;
  odin_model_p->dim_clin_inc = odin_model_p->dim_clin_inc_1 * odin_model_p->dim_clin_inc_2 * odin_model_p->dim_clin_inc_3;
  odin_model_p->clin_inc = (double*) Calloc(odin_model_p->dim_clin_inc, double);
  Free(odin_model_p->x_I);
  odin_model_p->dim_x_I = odin_model_p->na;
  odin_model_p->x_I = (double*) Calloc(odin_model_p->dim_x_I, double);
  get_user_array(user, "x_I", true, odin_model_p->x_I, 1, odin_model_p->dim_x_I);
  Free(odin_model_p->init_ICM);
  odin_model_p->dim_init_ICM_1 = odin_model_p->na;
  odin_model_p->dim_init_ICM_2 = odin_model_p->nh;
  odin_model_p->dim_init_ICM_3 = odin_model_p->num_int;
  odin_model_p->dim_init_ICM_12 = odin_model_p->dim_init_ICM_1 * odin_model_p->dim_init_ICM_2;
  odin_model_p->dim_init_ICM = odin_model_p->dim_init_ICM_1 * odin_model_p->dim_init_ICM_2 * odin_model_p->dim_init_ICM_3;
  odin_model_p->init_ICM = (double*) Calloc(odin_model_p->dim_init_ICM, double);
  get_user_array(user, "init_ICM", true, odin_model_p->init_ICM, 3, odin_model_p->dim_init_ICM_1, odin_model_p->dim_init_ICM_2, odin_model_p->dim_init_ICM_3);
  Free(odin_model_p->initial_ICM);
  odin_model_p->dim_ICM_1 = odin_model_p->na;
  odin_model_p->dim_ICM_2 = odin_model_p->nh;
  odin_model_p->dim_ICM_3 = odin_model_p->num_int;
  odin_model_p->dim_ICM_12 = odin_model_p->dim_ICM_1 * odin_model_p->dim_ICM_2;
  odin_model_p->dim_ICM = odin_model_p->dim_ICM_1 * odin_model_p->dim_ICM_2 * odin_model_p->dim_ICM_3;
  odin_model_p->initial_ICM = (double*) Calloc(odin_model_p->dim_ICM, double);
  odin_model_p->offset_ICM = odin_model_p->offset_P + odin_model_p->dim_P;
  for (int i = 0; i < odin_model_p->dim_ICM_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_ICM_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_ICM_3; ++k) {
        odin_model_p->initial_ICM[i + j * odin_model_p->dim_ICM_1 + k * odin_model_p->dim_ICM_12] = odin_model_p->init_ICM[i + j * odin_model_p->dim_init_ICM_1 + k * odin_model_p->dim_init_ICM_12];
      }
    }
  }
  Free(odin_model_p->init_ICA);
  odin_model_p->dim_init_ICA_1 = odin_model_p->na;
  odin_model_p->dim_init_ICA_2 = odin_model_p->nh;
  odin_model_p->dim_init_ICA_3 = odin_model_p->num_int;
  odin_model_p->dim_init_ICA_12 = odin_model_p->dim_init_ICA_1 * odin_model_p->dim_init_ICA_2;
  odin_model_p->dim_init_ICA = odin_model_p->dim_init_ICA_1 * odin_model_p->dim_init_ICA_2 * odin_model_p->dim_init_ICA_3;
  odin_model_p->init_ICA = (double*) Calloc(odin_model_p->dim_init_ICA, double);
  get_user_array(user, "init_ICA", true, odin_model_p->init_ICA, 3, odin_model_p->dim_init_ICA_1, odin_model_p->dim_init_ICA_2, odin_model_p->dim_init_ICA_3);
  Free(odin_model_p->initial_ICA);
  odin_model_p->dim_ICA_1 = odin_model_p->na;
  odin_model_p->dim_ICA_2 = odin_model_p->nh;
  odin_model_p->dim_ICA_3 = odin_model_p->num_int;
  odin_model_p->dim_ICA_12 = odin_model_p->dim_ICA_1 * odin_model_p->dim_ICA_2;
  odin_model_p->dim_ICA = odin_model_p->dim_ICA_1 * odin_model_p->dim_ICA_2 * odin_model_p->dim_ICA_3;
  odin_model_p->initial_ICA = (double*) Calloc(odin_model_p->dim_ICA, double);
  odin_model_p->offset_ICA = odin_model_p->offset_ICM + odin_model_p->dim_ICM;
  for (int i = 0; i < odin_model_p->dim_ICA_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_ICA_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_ICA_3; ++k) {
        odin_model_p->initial_ICA[i + j * odin_model_p->dim_ICA_1 + k * odin_model_p->dim_ICA_12] = odin_model_p->init_ICA[i + j * odin_model_p->dim_init_ICA_1 + k * odin_model_p->dim_init_ICA_12];
      }
    }
  }
  Free(odin_model_p->IC);
  odin_model_p->dim_IC_1 = odin_model_p->na;
  odin_model_p->dim_IC_2 = odin_model_p->nh;
  odin_model_p->dim_IC_3 = odin_model_p->num_int;
  odin_model_p->dim_IC_12 = odin_model_p->dim_IC_1 * odin_model_p->dim_IC_2;
  odin_model_p->dim_IC = odin_model_p->dim_IC_1 * odin_model_p->dim_IC_2 * odin_model_p->dim_IC_3;
  odin_model_p->IC = (double*) Calloc(odin_model_p->dim_IC, double);
  Free(odin_model_p->phi);
  odin_model_p->dim_phi_1 = odin_model_p->na;
  odin_model_p->dim_phi_2 = odin_model_p->nh;
  odin_model_p->dim_phi_3 = odin_model_p->num_int;
  odin_model_p->dim_phi_12 = odin_model_p->dim_phi_1 * odin_model_p->dim_phi_2;
  odin_model_p->dim_phi = odin_model_p->dim_phi_1 * odin_model_p->dim_phi_2 * odin_model_p->dim_phi_3;
  odin_model_p->phi = (double*) Calloc(odin_model_p->dim_phi, double);
  Free(odin_model_p->init_IB);
  odin_model_p->dim_init_IB_1 = odin_model_p->na;
  odin_model_p->dim_init_IB_2 = odin_model_p->nh;
  odin_model_p->dim_init_IB_3 = odin_model_p->num_int;
  odin_model_p->dim_init_IB_12 = odin_model_p->dim_init_IB_1 * odin_model_p->dim_init_IB_2;
  odin_model_p->dim_init_IB = odin_model_p->dim_init_IB_1 * odin_model_p->dim_init_IB_2 * odin_model_p->dim_init_IB_3;
  odin_model_p->init_IB = (double*) Calloc(odin_model_p->dim_init_IB, double);
  get_user_array(user, "init_IB", true, odin_model_p->init_IB, 3, odin_model_p->dim_init_IB_1, odin_model_p->dim_init_IB_2, odin_model_p->dim_init_IB_3);
  Free(odin_model_p->initial_IB);
  odin_model_p->dim_IB_1 = odin_model_p->na;
  odin_model_p->dim_IB_2 = odin_model_p->nh;
  odin_model_p->dim_IB_3 = odin_model_p->num_int;
  odin_model_p->dim_IB_12 = odin_model_p->dim_IB_1 * odin_model_p->dim_IB_2;
  odin_model_p->dim_IB = odin_model_p->dim_IB_1 * odin_model_p->dim_IB_2 * odin_model_p->dim_IB_3;
  odin_model_p->initial_IB = (double*) Calloc(odin_model_p->dim_IB, double);
  odin_model_p->offset_IB = odin_model_p->offset_ICA + odin_model_p->dim_ICA;
  for (int i = 0; i < odin_model_p->dim_IB_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_IB_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_IB_3; ++k) {
        odin_model_p->initial_IB[i + j * odin_model_p->dim_IB_1 + k * odin_model_p->dim_IB_12] = odin_model_p->init_IB[i + j * odin_model_p->dim_init_IB_1 + k * odin_model_p->dim_init_IB_12];
      }
    }
  }
  Free(odin_model_p->b);
  odin_model_p->dim_b_1 = odin_model_p->na;
  odin_model_p->dim_b_2 = odin_model_p->nh;
  odin_model_p->dim_b_3 = odin_model_p->num_int;
  odin_model_p->dim_b_12 = odin_model_p->dim_b_1 * odin_model_p->dim_b_2;
  odin_model_p->dim_b = odin_model_p->dim_b_1 * odin_model_p->dim_b_2 * odin_model_p->dim_b_3;
  odin_model_p->b = (double*) Calloc(odin_model_p->dim_b, double);
  Free(odin_model_p->delay_b);
  odin_model_p->delay_b = (double*) Calloc(odin_model_p->dim_b, double);
  Free(odin_model_p->init_ID);
  odin_model_p->dim_init_ID_1 = odin_model_p->na;
  odin_model_p->dim_init_ID_2 = odin_model_p->nh;
  odin_model_p->dim_init_ID_3 = odin_model_p->num_int;
  odin_model_p->dim_init_ID_12 = odin_model_p->dim_init_ID_1 * odin_model_p->dim_init_ID_2;
  odin_model_p->dim_init_ID = odin_model_p->dim_init_ID_1 * odin_model_p->dim_init_ID_2 * odin_model_p->dim_init_ID_3;
  odin_model_p->init_ID = (double*) Calloc(odin_model_p->dim_init_ID, double);
  get_user_array(user, "init_ID", true, odin_model_p->init_ID, 3, odin_model_p->dim_init_ID_1, odin_model_p->dim_init_ID_2, odin_model_p->dim_init_ID_3);
  Free(odin_model_p->initial_ID);
  odin_model_p->dim_ID_1 = odin_model_p->na;
  odin_model_p->dim_ID_2 = odin_model_p->nh;
  odin_model_p->dim_ID_3 = odin_model_p->num_int;
  odin_model_p->dim_ID_12 = odin_model_p->dim_ID_1 * odin_model_p->dim_ID_2;
  odin_model_p->dim_ID = odin_model_p->dim_ID_1 * odin_model_p->dim_ID_2 * odin_model_p->dim_ID_3;
  odin_model_p->initial_ID = (double*) Calloc(odin_model_p->dim_ID, double);
  odin_model_p->offset_ID = odin_model_p->offset_IB + odin_model_p->dim_IB;
  for (int i = 0; i < odin_model_p->dim_ID_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_ID_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_ID_3; ++k) {
        odin_model_p->initial_ID[i + j * odin_model_p->dim_ID_1 + k * odin_model_p->dim_ID_12] = odin_model_p->init_ID[i + j * odin_model_p->dim_init_ID_1 + k * odin_model_p->dim_init_ID_12];
      }
    }
  }
  Free(odin_model_p->age);
  odin_model_p->dim_age = odin_model_p->na;
  odin_model_p->age = (double*) Calloc(odin_model_p->dim_age, double);
  get_user_array(user, "age", true, odin_model_p->age, 1, odin_model_p->dim_age);
  Free(odin_model_p->fd);
  odin_model_p->dim_fd = odin_model_p->na;
  odin_model_p->fd = (double*) Calloc(odin_model_p->dim_fd, double);
  for (int i = 0; i < odin_model_p->na; ++i) {
    odin_model_p->fd[i] = 1 - (1 - odin_model_p->fD0) / (1 + pow((odin_model_p->age[i] / odin_model_p->aD), odin_model_p->gammaD));
  }
  Free(odin_model_p->p_det);
  odin_model_p->dim_p_det_1 = odin_model_p->na;
  odin_model_p->dim_p_det_2 = odin_model_p->nh;
  odin_model_p->dim_p_det_3 = odin_model_p->num_int;
  odin_model_p->dim_p_det_12 = odin_model_p->dim_p_det_1 * odin_model_p->dim_p_det_2;
  odin_model_p->dim_p_det = odin_model_p->dim_p_det_1 * odin_model_p->dim_p_det_2 * odin_model_p->dim_p_det_3;
  odin_model_p->p_det = (double*) Calloc(odin_model_p->dim_p_det, double);
  Free(odin_model_p->delay_p_det);
  odin_model_p->delay_p_det = (double*) Calloc(odin_model_p->dim_p_det, double);
  Free(odin_model_p->FOI_lag);
  odin_model_p->dim_FOI_lag_1 = odin_model_p->na;
  odin_model_p->dim_FOI_lag_2 = odin_model_p->nh;
  odin_model_p->dim_FOI_lag_3 = odin_model_p->num_int;
  odin_model_p->dim_FOI_lag_12 = odin_model_p->dim_FOI_lag_1 * odin_model_p->dim_FOI_lag_2;
  odin_model_p->dim_FOI_lag = odin_model_p->dim_FOI_lag_1 * odin_model_p->dim_FOI_lag_2 * odin_model_p->dim_FOI_lag_3;
  odin_model_p->FOI_lag = (double*) Calloc(odin_model_p->dim_FOI_lag, double);
  Free(odin_model_p->delay_FOI_lag);
  odin_model_p->delay_FOI_lag = (double*) Calloc(odin_model_p->dim_FOI_lag, double);
  Free(odin_model_p->FOI);
  odin_model_p->dim_FOI_1 = odin_model_p->na;
  odin_model_p->dim_FOI_2 = odin_model_p->nh;
  odin_model_p->dim_FOI_3 = odin_model_p->num_int;
  odin_model_p->dim_FOI_12 = odin_model_p->dim_FOI_1 * odin_model_p->dim_FOI_2;
  odin_model_p->dim_FOI = odin_model_p->dim_FOI_1 * odin_model_p->dim_FOI_2 * odin_model_p->dim_FOI_3;
  odin_model_p->FOI = (double*) Calloc(odin_model_p->dim_FOI, double);
  Free(odin_model_p->foi_age);
  odin_model_p->dim_foi_age = odin_model_p->na;
  odin_model_p->foi_age = (double*) Calloc(odin_model_p->dim_foi_age, double);
  get_user_array(user, "foi_age", true, odin_model_p->foi_age, 1, odin_model_p->dim_foi_age);
  Free(odin_model_p->rel_foi);
  odin_model_p->dim_rel_foi = odin_model_p->nh;
  odin_model_p->rel_foi = (double*) Calloc(odin_model_p->dim_rel_foi, double);
  get_user_array(user, "rel_foi", true, odin_model_p->rel_foi, 1, odin_model_p->dim_rel_foi);
  Free(odin_model_p->EIR);
  odin_model_p->dim_EIR_1 = odin_model_p->na;
  odin_model_p->dim_EIR_2 = odin_model_p->nh;
  odin_model_p->dim_EIR_3 = odin_model_p->num_int;
  odin_model_p->dim_EIR_12 = odin_model_p->dim_EIR_1 * odin_model_p->dim_EIR_2;
  odin_model_p->dim_EIR = odin_model_p->dim_EIR_1 * odin_model_p->dim_EIR_2 * odin_model_p->dim_EIR_3;
  odin_model_p->EIR = (double*) Calloc(odin_model_p->dim_EIR, double);
  Free(odin_model_p->delay_EIR);
  odin_model_p->delay_EIR = (double*) Calloc(odin_model_p->dim_EIR, double);
  for (int i = 0; i < 10; ++i) {
    odin_model_p->initial_Ev[i] = odin_model_p->init_Ev / (double) 10 * odin_model_p->mv0;
  }
  Free(odin_model_p->cA);
  odin_model_p->dim_cA_1 = odin_model_p->na;
  odin_model_p->dim_cA_2 = odin_model_p->nh;
  odin_model_p->dim_cA_3 = odin_model_p->num_int;
  odin_model_p->dim_cA_12 = odin_model_p->dim_cA_1 * odin_model_p->dim_cA_2;
  odin_model_p->dim_cA = odin_model_p->dim_cA_1 * odin_model_p->dim_cA_2 * odin_model_p->dim_cA_3;
  odin_model_p->cA = (double*) Calloc(odin_model_p->dim_cA, double);
  Free(odin_model_p->delay_cA);
  odin_model_p->delay_cA = (double*) Calloc(odin_model_p->dim_cA, double);
  Free(odin_model_p->FOIvijk);
  odin_model_p->dim_FOIvijk_1 = odin_model_p->na;
  odin_model_p->dim_FOIvijk_2 = odin_model_p->nh;
  odin_model_p->dim_FOIvijk_3 = odin_model_p->num_int;
  odin_model_p->dim_FOIvijk_12 = odin_model_p->dim_FOIvijk_1 * odin_model_p->dim_FOIvijk_2;
  odin_model_p->dim_FOIvijk = odin_model_p->dim_FOIvijk_1 * odin_model_p->dim_FOIvijk_2 * odin_model_p->dim_FOIvijk_3;
  odin_model_p->FOIvijk = (double*) Calloc(odin_model_p->dim_FOIvijk, double);
  Free(odin_model_p->delay_FOIvijk);
  odin_model_p->delay_FOIvijk = (double*) Calloc(odin_model_p->dim_FOIvijk, double);
  odin_model_p->b_lambda = (odin_model_p->gammaL * odin_model_p->muLL / odin_model_p->muEL - odin_model_p->dEL / odin_model_p->dLL + (odin_model_p->gammaL - 1) * odin_model_p->muLL * odin_model_p->dEL);
  Free(odin_model_p->cov);
  odin_model_p->dim_cov = odin_model_p->num_int;
  odin_model_p->cov = (double*) Calloc(odin_model_p->dim_cov, double);
  odin_model_p->offset_output_cov = 22;
  odin_model_p->cov[0] = (1 - odin_model_p->itn_cov) * (1 - odin_model_p->irs_cov);
  odin_model_p->cov[1] = odin_model_p->itn_cov * (1 - odin_model_p->irs_cov);
  odin_model_p->cov[2] = (1 - odin_model_p->itn_cov) * odin_model_p->irs_cov;
  odin_model_p->cov[3] = odin_model_p->itn_cov * odin_model_p->irs_cov;
  Free(odin_model_p->w);
  odin_model_p->dim_w = odin_model_p->num_int;
  odin_model_p->w = (double*) Calloc(odin_model_p->dim_w, double);
  Free(odin_model_p->delay_w);
  odin_model_p->delay_w = (double*) Calloc(odin_model_p->dim_w, double);
  Free(odin_model_p->yy);
  odin_model_p->dim_yy = odin_model_p->num_int;
  odin_model_p->yy = (double*) Calloc(odin_model_p->dim_yy, double);
  Free(odin_model_p->delay_yy);
  odin_model_p->delay_yy = (double*) Calloc(odin_model_p->dim_yy, double);
  Free(odin_model_p->z);
  odin_model_p->dim_z = odin_model_p->num_int;
  odin_model_p->z = (double*) Calloc(odin_model_p->dim_z, double);
  Free(odin_model_p->delay_z);
  odin_model_p->delay_z = (double*) Calloc(odin_model_p->dim_z, double);
  Free(odin_model_p->zhi);
  odin_model_p->dim_zhi = odin_model_p->num_int;
  odin_model_p->zhi = (double*) Calloc(odin_model_p->dim_zhi, double);
  Free(odin_model_p->delay_zhi);
  odin_model_p->delay_zhi = (double*) Calloc(odin_model_p->dim_zhi, double);
  Free(odin_model_p->whi);
  odin_model_p->dim_whi = odin_model_p->num_int;
  odin_model_p->whi = (double*) Calloc(odin_model_p->dim_whi, double);
  Free(odin_model_p->delay_whi);
  odin_model_p->delay_whi = (double*) Calloc(odin_model_p->dim_whi, double);
  Free(odin_model_p->av_mosq);
  odin_model_p->dim_av_mosq = odin_model_p->num_int;
  odin_model_p->av_mosq = (double*) Calloc(odin_model_p->dim_av_mosq, double);
  Free(odin_model_p->delay_av_mosq);
  odin_model_p->delay_av_mosq = (double*) Calloc(odin_model_p->dim_av_mosq, double);
  Free(odin_model_p->av_human);
  odin_model_p->dim_av_human = odin_model_p->num_int;
  odin_model_p->av_human = (double*) Calloc(odin_model_p->dim_av_human, double);
  Free(odin_model_p->delay_av_human);
  odin_model_p->delay_av_human = (double*) Calloc(odin_model_p->dim_av_human, double);
  Free(odin_model_p->den);
  odin_model_p->dim_den = odin_model_p->na;
  odin_model_p->den = (double*) Calloc(odin_model_p->dim_den, double);
  get_user_array(user, "den", true, odin_model_p->den, 1, odin_model_p->dim_den);
  Free(odin_model_p->prev0to59);
  odin_model_p->dim_prev0to59_1 = odin_model_p->age59;
  odin_model_p->dim_prev0to59_2 = odin_model_p->nh;
  odin_model_p->dim_prev0to59_3 = odin_model_p->num_int;
  odin_model_p->dim_prev0to59_12 = odin_model_p->dim_prev0to59_1 * odin_model_p->dim_prev0to59_2;
  odin_model_p->dim_prev0to59 = odin_model_p->dim_prev0to59_1 * odin_model_p->dim_prev0to59_2 * odin_model_p->dim_prev0to59_3;
  odin_model_p->prev0to59 = (double*) Calloc(odin_model_p->dim_prev0to59, double);
  Free(odin_model_p->clin_inc0to5);
  odin_model_p->dim_clin_inc0to5_1 = odin_model_p->age05;
  odin_model_p->dim_clin_inc0to5_2 = odin_model_p->nh;
  odin_model_p->dim_clin_inc0to5_3 = odin_model_p->num_int;
  odin_model_p->dim_clin_inc0to5_12 = odin_model_p->dim_clin_inc0to5_1 * odin_model_p->dim_clin_inc0to5_2;
  odin_model_p->dim_clin_inc0to5 = odin_model_p->dim_clin_inc0to5_1 * odin_model_p->dim_clin_inc0to5_2 * odin_model_p->dim_clin_inc0to5_3;
  odin_model_p->clin_inc0to5 = (double*) Calloc(odin_model_p->dim_clin_inc0to5, double);
  odin_model_p->dim_delay_FOI = 1 + odin_model_p->dim_IB;
  Free(odin_model_p->delay_i_FOI);
  Free(odin_model_p->delay_state_FOI);
  odin_model_p->delay_i_FOI = (int*) Calloc(odin_model_p->dim_delay_FOI, int);
  odin_model_p->delay_state_FOI = (double*) Calloc(odin_model_p->dim_delay_FOI, double);
  {
    // delay block for FOI
    int j = 0;
    odin_model_p->delay_i_FOI[j++] = 1;
    for (int i = 0, k = odin_model_p->offset_IB; i < odin_model_p->dim_IB; ++i) {
      odin_model_p->delay_i_FOI[j++] = k++;
    }
  }
  odin_model_p->dim_delay_FOIv = odin_model_p->dim_T + odin_model_p->dim_D + odin_model_p->dim_A + odin_model_p->dim_U + odin_model_p->dim_ID;
  Free(odin_model_p->delay_i_FOIv);
  Free(odin_model_p->delay_state_FOIv);
  odin_model_p->delay_i_FOIv = (int*) Calloc(odin_model_p->dim_delay_FOIv, int);
  odin_model_p->delay_state_FOIv = (double*) Calloc(odin_model_p->dim_delay_FOIv, double);
  {
    // delay block for FOIv
    int j = 0;
    for (int i = 0, k = odin_model_p->offset_T; i < odin_model_p->dim_T; ++i) {
      odin_model_p->delay_i_FOIv[j++] = k++;
    }
    for (int i = 0, k = odin_model_p->offset_D; i < odin_model_p->dim_D; ++i) {
      odin_model_p->delay_i_FOIv[j++] = k++;
    }
    for (int i = 0, k = odin_model_p->offset_A; i < odin_model_p->dim_A; ++i) {
      odin_model_p->delay_i_FOIv[j++] = k++;
    }
    for (int i = 0, k = odin_model_p->offset_U; i < odin_model_p->dim_U; ++i) {
      odin_model_p->delay_i_FOIv[j++] = k++;
    }
    for (int i = 0, k = odin_model_p->offset_ID; i < odin_model_p->dim_ID; ++i) {
      odin_model_p->delay_i_FOIv[j++] = k++;
    }
  }
  odin_model_p->dim_delay_incv = 1;
  Free(odin_model_p->delay_i_incv);
  Free(odin_model_p->delay_state_incv);
  odin_model_p->delay_i_incv = (int*) Calloc(odin_model_p->dim_delay_incv, int);
  odin_model_p->delay_state_incv = (double*) Calloc(odin_model_p->dim_delay_incv, double);
  {
    // delay block for incv
    int j = 0;
    odin_model_p->delay_i_incv[j++] = 0;
  }
  odin_model_p->dim = odin_model_p->offset_ID + odin_model_p->dim_ID;
  odin_model_p->dim_output = 22 + odin_model_p->dim_cov;
  return R_NilValue;
}
// Wrapper around this for use from R.
SEXP r_odin_model_set_user(SEXP odin_model_ptr, SEXP user) {
  odin_model_pars *odin_model_p = odin_model_get_pointer(odin_model_ptr, 1);
  odin_model_set_user(odin_model_p, user);
  return R_NilValue;
}

// Arrange to free all memory we have allocated
// This is called by R automatically when the pointer is
// garbage collected (i.e., when all objects holding the pointer
// go out of scope
void odin_model_finalize(SEXP odin_model_ptr) {
  odin_model_pars *odin_model_p = odin_model_get_pointer(odin_model_ptr, 0);
  if (odin_model_ptr) {
    Free(odin_model_p->initial_Ev);
    Free(odin_model_p->age_rate);
    Free(odin_model_p->het_wt);
    Free(odin_model_p->init_S);
    Free(odin_model_p->initial_S);
    Free(odin_model_p->init_T);
    Free(odin_model_p->initial_T);
    Free(odin_model_p->init_D);
    Free(odin_model_p->initial_D);
    Free(odin_model_p->init_A);
    Free(odin_model_p->initial_A);
    Free(odin_model_p->init_U);
    Free(odin_model_p->initial_U);
    Free(odin_model_p->init_P);
    Free(odin_model_p->initial_P);
    Free(odin_model_p->Y);
    Free(odin_model_p->clin_inc);
    Free(odin_model_p->x_I);
    Free(odin_model_p->init_ICM);
    Free(odin_model_p->initial_ICM);
    Free(odin_model_p->init_ICA);
    Free(odin_model_p->initial_ICA);
    Free(odin_model_p->IC);
    Free(odin_model_p->phi);
    Free(odin_model_p->init_IB);
    Free(odin_model_p->initial_IB);
    Free(odin_model_p->b);
    Free(odin_model_p->delay_b);
    Free(odin_model_p->init_ID);
    Free(odin_model_p->initial_ID);
    Free(odin_model_p->age);
    Free(odin_model_p->fd);
    Free(odin_model_p->p_det);
    Free(odin_model_p->delay_p_det);
    Free(odin_model_p->FOI_lag);
    Free(odin_model_p->delay_FOI_lag);
    Free(odin_model_p->FOI);
    Free(odin_model_p->foi_age);
    Free(odin_model_p->rel_foi);
    Free(odin_model_p->EIR);
    Free(odin_model_p->delay_EIR);
    Free(odin_model_p->cA);
    Free(odin_model_p->delay_cA);
    Free(odin_model_p->FOIvijk);
    Free(odin_model_p->delay_FOIvijk);
    Free(odin_model_p->cov);
    Free(odin_model_p->w);
    Free(odin_model_p->delay_w);
    Free(odin_model_p->yy);
    Free(odin_model_p->delay_yy);
    Free(odin_model_p->z);
    Free(odin_model_p->delay_z);
    Free(odin_model_p->zhi);
    Free(odin_model_p->delay_zhi);
    Free(odin_model_p->whi);
    Free(odin_model_p->delay_whi);
    Free(odin_model_p->av_mosq);
    Free(odin_model_p->delay_av_mosq);
    Free(odin_model_p->av_human);
    Free(odin_model_p->delay_av_human);
    Free(odin_model_p->den);
    Free(odin_model_p->prev0to59);
    Free(odin_model_p->clin_inc0to5);
    Free(odin_model_p->delay_i_FOI);
    Free(odin_model_p->delay_state_FOI);
    Free(odin_model_p->delay_i_FOIv);
    Free(odin_model_p->delay_state_FOIv);
    Free(odin_model_p->delay_i_incv);
    Free(odin_model_p->delay_state_incv);
    Free(odin_model_p);
    R_ClearExternalPtr(odin_model_ptr);
  }
}

SEXP odin_model_initialise(SEXP odin_model_ptr, SEXP t_ptr) {
  odin_model_pars *odin_model_p = odin_model_get_pointer(odin_model_ptr, 1);
  const double t = REAL(t_ptr)[0];
  odin_model_p->initial_t = t;
  odin_model_p->initial_Sv = odin_model_p->init_Sv * odin_model_p->mv0;
  odin_model_p->initial_Iv = odin_model_p->init_Iv * odin_model_p->mv0;
  odin_model_p->initial_PL = odin_model_p->init_PL;
  odin_model_p->initial_LL = odin_model_p->init_LL;
  odin_model_p->initial_EL = odin_model_p->init_EL;
  SEXP state = PROTECT(allocVector(REALSXP, odin_model_p->dim));
  REAL(state)[0] = odin_model_p->initial_Sv;
  REAL(state)[1] = odin_model_p->initial_Iv;
  REAL(state)[2] = odin_model_p->initial_EL;
  REAL(state)[3] = odin_model_p->initial_LL;
  REAL(state)[4] = odin_model_p->initial_PL;
  memcpy(REAL(state) + 5, odin_model_p->initial_Ev, odin_model_p->dim_Ev * sizeof(double));
  memcpy(REAL(state) + odin_model_p->offset_S, odin_model_p->initial_S, odin_model_p->dim_S * sizeof(double));
  memcpy(REAL(state) + odin_model_p->offset_T, odin_model_p->initial_T, odin_model_p->dim_T * sizeof(double));
  memcpy(REAL(state) + odin_model_p->offset_D, odin_model_p->initial_D, odin_model_p->dim_D * sizeof(double));
  memcpy(REAL(state) + odin_model_p->offset_A, odin_model_p->initial_A, odin_model_p->dim_A * sizeof(double));
  memcpy(REAL(state) + odin_model_p->offset_U, odin_model_p->initial_U, odin_model_p->dim_U * sizeof(double));
  memcpy(REAL(state) + odin_model_p->offset_P, odin_model_p->initial_P, odin_model_p->dim_P * sizeof(double));
  memcpy(REAL(state) + odin_model_p->offset_ICM, odin_model_p->initial_ICM, odin_model_p->dim_ICM * sizeof(double));
  memcpy(REAL(state) + odin_model_p->offset_ICA, odin_model_p->initial_ICA, odin_model_p->dim_ICA * sizeof(double));
  memcpy(REAL(state) + odin_model_p->offset_IB, odin_model_p->initial_IB, odin_model_p->dim_IB * sizeof(double));
  memcpy(REAL(state) + odin_model_p->offset_ID, odin_model_p->initial_ID, odin_model_p->dim_ID * sizeof(double));
  setAttrib(state, install("output_len"), ScalarInteger(odin_model_p->dim_output));
  UNPROTECT(1);
  return state;
}

SEXP odin_model_set_initial(SEXP odin_model_ptr, SEXP t_ptr, SEXP state_ptr) {
  odin_model_pars *odin_model_p = odin_model_get_pointer(odin_model_ptr, 1);
  if (length(odin_model_ptr) != odin_model_p->dim) {
    Rf_error("Incorrect length initial conditions");
  }
  double * state = REAL(state_ptr);
  const double t = REAL(t_ptr)[0];
  odin_model_p->initial_t = t;
  odin_model_p->initial_Sv = state[0];
  odin_model_p->initial_Iv = state[1];
  odin_model_p->initial_EL = state[2];
  odin_model_p->initial_LL = state[3];
  odin_model_p->initial_PL = state[4];
  memcpy(odin_model_p->initial_Ev, state + 5, odin_model_p->dim_Ev * sizeof(double));
  memcpy(odin_model_p->initial_S, state + odin_model_p->offset_S, odin_model_p->dim_S * sizeof(double));
  memcpy(odin_model_p->initial_T, state + odin_model_p->offset_T, odin_model_p->dim_T * sizeof(double));
  memcpy(odin_model_p->initial_D, state + odin_model_p->offset_D, odin_model_p->dim_D * sizeof(double));
  memcpy(odin_model_p->initial_A, state + odin_model_p->offset_A, odin_model_p->dim_A * sizeof(double));
  memcpy(odin_model_p->initial_U, state + odin_model_p->offset_U, odin_model_p->dim_U * sizeof(double));
  memcpy(odin_model_p->initial_P, state + odin_model_p->offset_P, odin_model_p->dim_P * sizeof(double));
  memcpy(odin_model_p->initial_ICM, state + odin_model_p->offset_ICM, odin_model_p->dim_ICM * sizeof(double));
  memcpy(odin_model_p->initial_ICA, state + odin_model_p->offset_ICA, odin_model_p->dim_ICA * sizeof(double));
  memcpy(odin_model_p->initial_IB, state + odin_model_p->offset_IB, odin_model_p->dim_IB * sizeof(double));
  memcpy(odin_model_p->initial_ID, state + odin_model_p->offset_ID, odin_model_p->dim_ID * sizeof(double));
  return R_NilValue;
}

void odin_model_deriv(odin_model_pars *odin_model_p, double t, double *state, double *dstatedt, double *output) {
  double Sv = state[0];
  double Iv = state[1];
  double EL = state[2];
  double LL = state[3];
  double PL = state[4];
  double *Ev = state + 5;
  double *S = state + odin_model_p->offset_S;
  double *T = state + odin_model_p->offset_T;
  double *D = state + odin_model_p->offset_D;
  double *A = state + odin_model_p->offset_A;
  double *U = state + odin_model_p->offset_U;
  double *P = state + odin_model_p->offset_P;
  double *ICM = state + odin_model_p->offset_ICM;
  double *ICA = state + odin_model_p->offset_ICA;
  double *IB = state + odin_model_p->offset_IB;
  double *ID = state + odin_model_p->offset_ID;
  double *deriv_Ev = dstatedt + 5;
  double *deriv_S = dstatedt + odin_model_p->offset_S;
  double *deriv_T = dstatedt + odin_model_p->offset_T;
  double *deriv_D = dstatedt + odin_model_p->offset_D;
  double *deriv_A = dstatedt + odin_model_p->offset_A;
  double *deriv_U = dstatedt + odin_model_p->offset_U;
  double *deriv_P = dstatedt + odin_model_p->offset_P;
  double *deriv_ICM = dstatedt + odin_model_p->offset_ICM;
  double *deriv_ICA = dstatedt + odin_model_p->offset_ICA;
  double *deriv_IB = dstatedt + odin_model_p->offset_IB;
  double *deriv_ID = dstatedt + odin_model_p->offset_ID;
  {
    int i = 0;
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_P[i + j * odin_model_p->dim_P_1 + k * odin_model_p->dim_P_12] = odin_model_p->rT * T[i + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12] - odin_model_p->rP * P[i + j * odin_model_p->dim_P_1 + k * odin_model_p->dim_P_12] - (odin_model_p->eta + odin_model_p->age_rate[i]) * P[i + j * odin_model_p->dim_P_1 + k * odin_model_p->dim_P_12];
      }
    }
  }
  for (int i = 1; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_P[i + j * odin_model_p->dim_P_1 + k * odin_model_p->dim_P_12] = odin_model_p->rT * T[i + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12] - odin_model_p->rP * P[i + j * odin_model_p->dim_P_1 + k * odin_model_p->dim_P_12] - (odin_model_p->eta + odin_model_p->age_rate[i]) * P[i + j * odin_model_p->dim_P_1 + k * odin_model_p->dim_P_12] + odin_model_p->age_rate[i - 1] * P[i - 1 + j * odin_model_p->dim_P_1 + k * odin_model_p->dim_P_12];
      }
    }
  }
  for (int i = 0; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        odin_model_p->Y[i + j * odin_model_p->dim_Y_1 + k * odin_model_p->dim_Y_12] = S[i + j * odin_model_p->dim_S_1 + k * odin_model_p->dim_S_12] + A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] + U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12];
      }
    }
  }
  double Sh = odin_sum3(S, 0, odin_model_p->dim_S_1 - 1, 0, odin_model_p->dim_S_2 - 1, 0, odin_model_p->dim_S_3 - 1, odin_model_p->dim_S_1, odin_model_p->dim_S_12);
  double Th = odin_sum3(T, 0, odin_model_p->dim_T_1 - 1, 0, odin_model_p->dim_T_2 - 1, 0, odin_model_p->dim_T_3 - 1, odin_model_p->dim_T_1, odin_model_p->dim_T_12);
  double Dh = odin_sum3(D, 0, odin_model_p->dim_D_1 - 1, 0, odin_model_p->dim_D_2 - 1, 0, odin_model_p->dim_D_3 - 1, odin_model_p->dim_D_1, odin_model_p->dim_D_12);
  double Ah = odin_sum3(A, 0, odin_model_p->dim_A_1 - 1, 0, odin_model_p->dim_A_2 - 1, 0, odin_model_p->dim_A_3 - 1, odin_model_p->dim_A_1, odin_model_p->dim_A_12);
  double Uh = odin_sum3(U, 0, odin_model_p->dim_U_1 - 1, 0, odin_model_p->dim_U_2 - 1, 0, odin_model_p->dim_U_3 - 1, odin_model_p->dim_U_1, odin_model_p->dim_U_12);
  double Ph = odin_sum3(P, 0, odin_model_p->dim_P_1 - 1, 0, odin_model_p->dim_P_2 - 1, 0, odin_model_p->dim_P_3 - 1, odin_model_p->dim_P_1, odin_model_p->dim_P_12);
  double H = Sh + Th + Dh + Ah + Uh + Ph;
  {
    int i = 0;
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_ICM[i + j * odin_model_p->dim_ICM_1 + k * odin_model_p->dim_ICM_12] = -1 / odin_model_p->dCM * ICM[i + j * odin_model_p->dim_ICM_1 + k * odin_model_p->dim_ICM_12] + (odin_model_p->init_ICM[i + j * odin_model_p->dim_init_ICM_1 + k * odin_model_p->dim_init_ICM_12] - ICM[i + j * odin_model_p->dim_ICM_1 + k * odin_model_p->dim_ICM_12]) / odin_model_p->x_I[i];
      }
    }
  }
  for (int i = 1; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_ICM[i + j * odin_model_p->dim_ICM_1 + k * odin_model_p->dim_ICM_12] = -1 / odin_model_p->dCM * ICM[i + j * odin_model_p->dim_ICM_1 + k * odin_model_p->dim_ICM_12] - (ICM[i + j * odin_model_p->dim_ICM_1 + k * odin_model_p->dim_ICM_12] - ICM[i + j * odin_model_p->dim_ICM_1 + k * odin_model_p->dim_ICM_12]) / odin_model_p->x_I[i];
      }
    }
  }
  for (int i = 0; i < odin_model_p->dim_IC_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_IC_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_IC_3; ++k) {
        odin_model_p->IC[i + j * odin_model_p->dim_IC_1 + k * odin_model_p->dim_IC_12] = ICM[i + j * odin_model_p->dim_ICM_1 + k * odin_model_p->dim_ICM_12] + ICA[i + j * odin_model_p->dim_ICA_1 + k * odin_model_p->dim_ICA_12];
      }
    }
  }
  for (int i = 0; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        odin_model_p->phi[i + j * odin_model_p->dim_phi_1 + k * odin_model_p->dim_phi_12] = odin_model_p->phi0 * ((1 - odin_model_p->phi1) / (1 + pow((odin_model_p->IC[i + j * odin_model_p->dim_IC_1 + k * odin_model_p->dim_IC_12] / odin_model_p->IC0), odin_model_p->kC)) + odin_model_p->phi1);
      }
    }
  }
  {
    // delay block for FOI
    double Iv, *IB;
    const double odin_true_t = t;
    const double t = odin_true_t - odin_model_p->dE;
    if (t <= odin_model_p->initial_t) {
      Iv = odin_model_p->initial_Iv;
      IB = odin_model_p->initial_IB;
    } else {
      if (odin_model_p->odin_use_dde) {
        lagvalue_dde(t, odin_model_p->delay_i_FOI, odin_model_p->dim_delay_FOI, odin_model_p->delay_state_FOI);
      } else {
        lagvalue_ds(t, odin_model_p->delay_i_FOI, odin_model_p->dim_delay_FOI, odin_model_p->delay_state_FOI);
      }
      Iv = odin_model_p->delay_state_FOI[0];
      IB = odin_model_p->delay_state_FOI + 1;
    }
    for (int i = 0; i < odin_model_p->na; ++i) {
      for (int j = 0; j < odin_model_p->nh; ++j) {
        for (int k = 0; k < odin_model_p->num_int; ++k) {
          odin_model_p->delay_b[i + j * odin_model_p->dim_b_1 + k * odin_model_p->dim_b_12] = odin_model_p->b0 * ((1 - odin_model_p->b1) / (1 + pow((IB[i + j * odin_model_p->dim_IB_1 + k * odin_model_p->dim_IB_12] / odin_model_p->IB0), odin_model_p->kB)) + odin_model_p->b1);
        }
      }
    }
    double ITN_decay = (t < odin_model_p->ITN_IRS_on ? 0 : exp(-(fmodr((t - odin_model_p->ITN_IRS_on), odin_model_p->ITN_interval)) * odin_model_p->itn_loss));
    double IRS_decay = (t < odin_model_p->ITN_IRS_on ? 0 : exp(-(fmodr((t - odin_model_p->ITN_IRS_on), odin_model_p->IRS_interval)) * odin_model_p->irs_loss));
    double d_ITN = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->d_ITN0 * ITN_decay);
    double r_ITN = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->r_ITN1 + (odin_model_p->r_ITN0 - odin_model_p->r_ITN1) * ITN_decay);
    double s_ITN = (t < odin_model_p->ITN_IRS_on ? 1 : 1 - d_ITN - r_ITN);
    double r_IRS = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->r_IRS0 * IRS_decay);
    double d_IRS = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->chi * odin_model_p->d_IRS0 * IRS_decay);
    double s_IRS = (t < odin_model_p->ITN_IRS_on ? 1 : 1 - d_IRS);
    odin_model_p->delay_w[0] = 1;
    odin_model_p->delay_w[1] = 1 - odin_model_p->bites_Bed + odin_model_p->bites_Bed * s_ITN;
    odin_model_p->delay_w[2] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Indoors * (1 - r_IRS) * s_IRS;
    odin_model_p->delay_w[3] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Bed * (1 - r_IRS) * s_ITN * s_IRS + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * (1 - r_IRS) * s_IRS;
    odin_model_p->delay_yy[0] = 1;
    odin_model_p->delay_yy[1] = odin_model_p->delay_w[1];
    odin_model_p->delay_yy[2] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Indoors * (1 - r_IRS);
    odin_model_p->delay_yy[3] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Bed * (1 - r_IRS) * s_ITN + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * (1 - r_IRS);
    odin_model_p->delay_z[0] = 0;
    odin_model_p->delay_z[1] = odin_model_p->bites_Bed * r_ITN;
    odin_model_p->delay_z[2] = odin_model_p->bites_Indoors * r_IRS;
    odin_model_p->delay_z[3] = odin_model_p->bites_Bed * (r_IRS + (1 - r_IRS) * r_ITN) + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * r_IRS;
    for (int i = 0; i < odin_model_p->num_int; ++i) {
      odin_model_p->delay_zhi[i] = odin_model_p->cov[i] * odin_model_p->delay_z[i];
    }
    for (int i = 0; i < odin_model_p->num_int; ++i) {
      odin_model_p->delay_whi[i] = odin_model_p->cov[i] * odin_model_p->delay_w[i];
    }
    double zh = (t < odin_model_p->ITN_IRS_on ? 0 : odin_sum1(odin_model_p->delay_zhi, 0, odin_model_p->dim_zhi - 1));
    double wh = (t < odin_model_p->ITN_IRS_on ? 1 : odin_sum1(odin_model_p->delay_whi, 0, odin_model_p->dim_whi - 1));
    double zbar = odin_model_p->Q0 * zh;
    double fv = (double) 1 / (odin_model_p->tau1 / (1 - zbar) + odin_model_p->tau2);
    double wbar = 1 - odin_model_p->Q0 + odin_model_p->Q0 * wh;
    double Q = 1 - (1 - odin_model_p->Q0) / wbar;
    double av = fv * Q;
    for (int i = 0; i < odin_model_p->num_int; ++i) {
      odin_model_p->delay_av_human[i] = av * odin_model_p->delay_yy[i] / wh;
    }
    for (int i = 0; i < odin_model_p->dim_EIR_1; ++i) {
      for (int j = 0; j < odin_model_p->dim_EIR_2; ++j) {
        for (int k = 0; k < odin_model_p->dim_EIR_3; ++k) {
          odin_model_p->delay_EIR[i + j * odin_model_p->dim_EIR_1 + k * odin_model_p->dim_EIR_12] = odin_model_p->delay_av_human[k] * odin_model_p->rel_foi[j] * odin_model_p->foi_age[i] / odin_model_p->omega * Iv;
        }
      }
    }
    for (int i = 0; i < odin_model_p->na; ++i) {
      for (int j = 0; j < odin_model_p->nh; ++j) {
        for (int k = 0; k < odin_model_p->num_int; ++k) {
          odin_model_p->delay_FOI_lag[i + j * odin_model_p->dim_FOI_lag_1 + k * odin_model_p->dim_FOI_lag_12] = odin_model_p->delay_EIR[i + j * odin_model_p->dim_EIR_1 + k * odin_model_p->dim_EIR_12] * ((IB[i + j * odin_model_p->dim_IB_1 + k * odin_model_p->dim_IB_12] == 0 ? odin_model_p->b0 : odin_model_p->delay_b[i + j * odin_model_p->dim_b_1 + k * odin_model_p->dim_b_12]));
        }
      }
    }
    for (int i = 0; i < odin_model_p->dim_FOI_1; ++i) {
      for (int j = 0; j < odin_model_p->dim_FOI_2; ++j) {
        for (int k = 0; k < odin_model_p->dim_FOI_3; ++k) {
          odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] = odin_model_p->delay_FOI_lag[i + j * odin_model_p->dim_FOI_lag_1 + k * odin_model_p->dim_FOI_lag_12];
        }
      }
    }
  }
  {
    int i = 0;
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] = (1 - odin_model_p->phi[i + j * odin_model_p->dim_phi_1 + k * odin_model_p->dim_phi_12]) * odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * odin_model_p->Y[i + j * odin_model_p->dim_Y_1 + k * odin_model_p->dim_Y_12] - odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] + odin_model_p->rD * D[i + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12] - odin_model_p->rA * A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] - (odin_model_p->eta + odin_model_p->age_rate[i]) * A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12];
      }
    }
  }
  for (int i = 1; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] = (1 - odin_model_p->phi[i + j * odin_model_p->dim_phi_1 + k * odin_model_p->dim_phi_12]) * odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * odin_model_p->Y[i + j * odin_model_p->dim_Y_1 + k * odin_model_p->dim_Y_12] - odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] + odin_model_p->rD * D[i + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12] - odin_model_p->rA * A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] - (odin_model_p->eta + odin_model_p->age_rate[i]) * A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] + odin_model_p->age_rate[i - 1] * A[i - 1 + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12];
      }
    }
  }
  {
    int i = 0;
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12] = odin_model_p->rA * A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] - odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12] - odin_model_p->rU * U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12] - (odin_model_p->eta + odin_model_p->age_rate[i]) * U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12];
      }
    }
  }
  for (int i = 1; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12] = odin_model_p->rA * A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] - odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12] - odin_model_p->rU * U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12] - (odin_model_p->eta + odin_model_p->age_rate[i]) * U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12] + odin_model_p->age_rate[i - 1] * U[i - 1 + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12];
      }
    }
  }
  for (int i = 0; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        odin_model_p->clin_inc[i + j * odin_model_p->dim_clin_inc_1 + k * odin_model_p->dim_clin_inc_12] = odin_model_p->phi[i + j * odin_model_p->dim_phi_1 + k * odin_model_p->dim_phi_12] * odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * odin_model_p->Y[i + j * odin_model_p->dim_Y_1 + k * odin_model_p->dim_Y_12];
      }
    }
  }
  {
    int i = 0;
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_T[i + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12] = odin_model_p->ft * odin_model_p->clin_inc[i + j * odin_model_p->dim_clin_inc_1 + k * odin_model_p->dim_clin_inc_12] - odin_model_p->rT * T[i + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12] - (odin_model_p->eta + odin_model_p->age_rate[i]) * T[i + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12];
      }
    }
  }
  for (int i = 1; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_T[i + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12] = odin_model_p->ft * odin_model_p->clin_inc[i + j * odin_model_p->dim_clin_inc_1 + k * odin_model_p->dim_clin_inc_12] - odin_model_p->rT * T[i + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12] - (odin_model_p->eta + odin_model_p->age_rate[i]) * T[i + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12] + odin_model_p->age_rate[i - 1] * T[i - 1 + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12];
      }
    }
  }
  {
    int i = 0;
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_D[i + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12] = (1 - odin_model_p->ft) * odin_model_p->clin_inc[i + j * odin_model_p->dim_clin_inc_1 + k * odin_model_p->dim_clin_inc_12] - odin_model_p->rD * D[i + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12] - (odin_model_p->eta + odin_model_p->age_rate[i]) * D[i + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12];
      }
    }
  }
  for (int i = 1; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_D[i + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12] = (1 - odin_model_p->ft) * odin_model_p->clin_inc[i + j * odin_model_p->dim_clin_inc_1 + k * odin_model_p->dim_clin_inc_12] - odin_model_p->rD * D[i + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12] - (odin_model_p->eta + odin_model_p->age_rate[i]) * D[i + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12] + odin_model_p->age_rate[i - 1] * D[i - 1 + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12];
      }
    }
  }
  {
    int i = 0;
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_ICA[i + j * odin_model_p->dim_ICA_1 + k * odin_model_p->dim_ICA_12] = odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] / (odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * odin_model_p->uCA + 1) - (double) 1 / odin_model_p->dCA * ICA[i + j * odin_model_p->dim_ICA_1 + k * odin_model_p->dim_ICA_12] - ICA[i + j * odin_model_p->dim_ICA_1 + k * odin_model_p->dim_ICA_12] / odin_model_p->x_I[i];
      }
    }
  }
  for (int i = 1; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_ICA[i + j * odin_model_p->dim_ICA_1 + k * odin_model_p->dim_ICA_12] = odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] / (odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * odin_model_p->uCA + 1) - (double) 1 / odin_model_p->dCA * ICA[i + j * odin_model_p->dim_ICA_1 + k * odin_model_p->dim_ICA_12] - (ICA[i + j * odin_model_p->dim_ICA_1 + k * odin_model_p->dim_ICA_12] - ICA[i - 1 + j * odin_model_p->dim_ICA_1 + k * odin_model_p->dim_ICA_12]) / odin_model_p->x_I[i];
      }
    }
  }
  {
    int i = 0;
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_ID[i + j * odin_model_p->dim_ID_1 + k * odin_model_p->dim_ID_12] = odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] / (odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * odin_model_p->uD + 1) - ID[i + j * odin_model_p->dim_ID_1 + k * odin_model_p->dim_ID_12] / odin_model_p->dID - ID[i + j * odin_model_p->dim_ID_1 + k * odin_model_p->dim_ID_12] / odin_model_p->x_I[i];
      }
    }
  }
  for (int i = 1; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_ID[i + j * odin_model_p->dim_ID_1 + k * odin_model_p->dim_ID_12] = odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] / (odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * odin_model_p->uD + 1) - ID[i + j * odin_model_p->dim_ID_1 + k * odin_model_p->dim_ID_12] / odin_model_p->dID - (ID[i + j * odin_model_p->dim_ID_1 + k * odin_model_p->dim_ID_12] - ID[i - 1 + j * odin_model_p->dim_ID_1 + k * odin_model_p->dim_ID_12]) / odin_model_p->x_I[i];
      }
    }
  }
  double theta2 = (odin_model_p->ssa0 == 0 && odin_model_p->ssa1 == 0 && odin_model_p->ssa2 == 0 && odin_model_p->ssb1 == 0 && odin_model_p->ssb2 == 0 && odin_model_p->ssb3 == 0 && odin_model_p->theta_c == 0 ? 1 : fmax((odin_model_p->ssa0 + odin_model_p->ssa1 * cos(2 * odin_model_p->pi * t / (double) 365) + odin_model_p->ssa2 * cos(2 * 2 * odin_model_p->pi * t / (double) 365) + odin_model_p->ssa3 * cos(3 * 2 * odin_model_p->pi * t / (double) 365) + odin_model_p->ssb1 * sin(2 * odin_model_p->pi * t / (double) 365) + odin_model_p->ssb2 * sin(2 * 2 * odin_model_p->pi * t / (double) 365) + odin_model_p->ssb3 * sin(3 * 2 * odin_model_p->pi * t / (double) 365)) / odin_model_p->theta_c, 0.001));
  double FOIv;
  {
    // delay block for FOIv
    double *T, *D, *A, *U, *ID;
    const double odin_true_t = t;
    const double t = odin_true_t - odin_model_p->delayGam;
    if (t <= odin_model_p->initial_t) {
      T = odin_model_p->initial_T;
      D = odin_model_p->initial_D;
      A = odin_model_p->initial_A;
      U = odin_model_p->initial_U;
      ID = odin_model_p->initial_ID;
    } else {
      if (odin_model_p->odin_use_dde) {
        lagvalue_dde(t, odin_model_p->delay_i_FOIv, odin_model_p->dim_delay_FOIv, odin_model_p->delay_state_FOIv);
      } else {
        lagvalue_ds(t, odin_model_p->delay_i_FOIv, odin_model_p->dim_delay_FOIv, odin_model_p->delay_state_FOIv);
      }
      T = odin_model_p->delay_state_FOIv;
      D = T + odin_model_p->dim_T;
      A = D + odin_model_p->dim_D;
      U = A + odin_model_p->dim_A;
      ID = U + odin_model_p->dim_U;
    }
    for (int i = 0; i < odin_model_p->dim_p_det_1; ++i) {
      for (int j = 0; j < odin_model_p->dim_p_det_2; ++j) {
        for (int k = 0; k < odin_model_p->dim_p_det_3; ++k) {
          odin_model_p->delay_p_det[i + j * odin_model_p->dim_p_det_1 + k * odin_model_p->dim_p_det_12] = odin_model_p->d1 + (1 - odin_model_p->d1) / (1 + odin_model_p->fd[i] * pow((ID[i + j * odin_model_p->dim_ID_1 + k * odin_model_p->dim_ID_12] / odin_model_p->ID0), odin_model_p->kD));
        }
      }
    }
    for (int i = 0; i < odin_model_p->dim_cA_1; ++i) {
      for (int j = 0; j < odin_model_p->dim_cA_2; ++j) {
        for (int k = 0; k < odin_model_p->dim_cA_3; ++k) {
          odin_model_p->delay_cA[i + j * odin_model_p->dim_cA_1 + k * odin_model_p->dim_cA_12] = odin_model_p->cU + (odin_model_p->cD - odin_model_p->cU) * pow(odin_model_p->delay_p_det[i + j * odin_model_p->dim_p_det_1 + k * odin_model_p->dim_p_det_12], odin_model_p->gamma1);
        }
      }
    }
    double ITN_decay = (t < odin_model_p->ITN_IRS_on ? 0 : exp(-(fmodr((t - odin_model_p->ITN_IRS_on), odin_model_p->ITN_interval)) * odin_model_p->itn_loss));
    double IRS_decay = (t < odin_model_p->ITN_IRS_on ? 0 : exp(-(fmodr((t - odin_model_p->ITN_IRS_on), odin_model_p->IRS_interval)) * odin_model_p->irs_loss));
    double d_ITN = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->d_ITN0 * ITN_decay);
    double r_ITN = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->r_ITN1 + (odin_model_p->r_ITN0 - odin_model_p->r_ITN1) * ITN_decay);
    double s_ITN = (t < odin_model_p->ITN_IRS_on ? 1 : 1 - d_ITN - r_ITN);
    double r_IRS = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->r_IRS0 * IRS_decay);
    double d_IRS = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->chi * odin_model_p->d_IRS0 * IRS_decay);
    double s_IRS = (t < odin_model_p->ITN_IRS_on ? 1 : 1 - d_IRS);
    odin_model_p->delay_w[0] = 1;
    odin_model_p->delay_w[1] = 1 - odin_model_p->bites_Bed + odin_model_p->bites_Bed * s_ITN;
    odin_model_p->delay_w[2] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Indoors * (1 - r_IRS) * s_IRS;
    odin_model_p->delay_w[3] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Bed * (1 - r_IRS) * s_ITN * s_IRS + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * (1 - r_IRS) * s_IRS;
    odin_model_p->delay_z[0] = 0;
    odin_model_p->delay_z[1] = odin_model_p->bites_Bed * r_ITN;
    odin_model_p->delay_z[2] = odin_model_p->bites_Indoors * r_IRS;
    odin_model_p->delay_z[3] = odin_model_p->bites_Bed * (r_IRS + (1 - r_IRS) * r_ITN) + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * r_IRS;
    for (int i = 0; i < odin_model_p->num_int; ++i) {
      odin_model_p->delay_zhi[i] = odin_model_p->cov[i] * odin_model_p->delay_z[i];
    }
    for (int i = 0; i < odin_model_p->num_int; ++i) {
      odin_model_p->delay_whi[i] = odin_model_p->cov[i] * odin_model_p->delay_w[i];
    }
    double zh = (t < odin_model_p->ITN_IRS_on ? 0 : odin_sum1(odin_model_p->delay_zhi, 0, odin_model_p->dim_zhi - 1));
    double wh = (t < odin_model_p->ITN_IRS_on ? 1 : odin_sum1(odin_model_p->delay_whi, 0, odin_model_p->dim_whi - 1));
    double zbar = odin_model_p->Q0 * zh;
    double fv = (double) 1 / (odin_model_p->tau1 / (1 - zbar) + odin_model_p->tau2);
    double wbar = 1 - odin_model_p->Q0 + odin_model_p->Q0 * wh;
    double Q = 1 - (1 - odin_model_p->Q0) / wbar;
    double av = fv * Q;
    for (int i = 0; i < odin_model_p->num_int; ++i) {
      odin_model_p->delay_av_mosq[i] = av * odin_model_p->delay_w[i] / wh;
    }
    for (int i = 0; i < odin_model_p->na; ++i) {
      for (int j = 0; j < odin_model_p->nh; ++j) {
        for (int k = 0; k < odin_model_p->num_int; ++k) {
          odin_model_p->delay_FOIvijk[i + j * odin_model_p->dim_FOIvijk_1 + k * odin_model_p->dim_FOIvijk_12] = (odin_model_p->cT * T[i + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12] + odin_model_p->cD * D[i + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12] + odin_model_p->delay_cA[i + j * odin_model_p->dim_cA_1 + k * odin_model_p->dim_cA_12] * A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] + odin_model_p->cU * U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12]) * odin_model_p->rel_foi[j] * odin_model_p->delay_av_mosq[k] * odin_model_p->foi_age[i] / odin_model_p->omega;
        }
      }
    }
    double lag_FOIv = odin_sum1(odin_model_p->delay_FOIvijk, 0, odin_model_p->dim_FOIvijk - 1);
    FOIv = lag_FOIv;
  }
  double ince = FOIv * Sv;
  double incv;
  {
    // delay block for incv
    double Sv;
    const double odin_true_t = t;
    const double t = odin_true_t - odin_model_p->delayMos;
    if (t <= odin_model_p->initial_t) {
      Sv = odin_model_p->initial_Sv;
    } else {
      if (odin_model_p->odin_use_dde) {
        lagvalue_dde(t, odin_model_p->delay_i_incv, odin_model_p->dim_delay_incv, odin_model_p->delay_state_incv);
      } else {
        lagvalue_ds(t, odin_model_p->delay_i_incv, odin_model_p->dim_delay_incv, odin_model_p->delay_state_incv);
      }
      Sv = odin_model_p->delay_state_incv[0];
    }
    double ince = FOIv * Sv;
    double ITN_decay = (t < odin_model_p->ITN_IRS_on ? 0 : exp(-(fmodr((t - odin_model_p->ITN_IRS_on), odin_model_p->ITN_interval)) * odin_model_p->itn_loss));
    double IRS_decay = (t < odin_model_p->ITN_IRS_on ? 0 : exp(-(fmodr((t - odin_model_p->ITN_IRS_on), odin_model_p->IRS_interval)) * odin_model_p->irs_loss));
    double d_ITN = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->d_ITN0 * ITN_decay);
    double r_ITN = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->r_ITN1 + (odin_model_p->r_ITN0 - odin_model_p->r_ITN1) * ITN_decay);
    double s_ITN = (t < odin_model_p->ITN_IRS_on ? 1 : 1 - d_ITN - r_ITN);
    double r_IRS = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->r_IRS0 * IRS_decay);
    double d_IRS = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->chi * odin_model_p->d_IRS0 * IRS_decay);
    double s_IRS = (t < odin_model_p->ITN_IRS_on ? 1 : 1 - d_IRS);
    odin_model_p->delay_w[0] = 1;
    odin_model_p->delay_w[1] = 1 - odin_model_p->bites_Bed + odin_model_p->bites_Bed * s_ITN;
    odin_model_p->delay_w[2] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Indoors * (1 - r_IRS) * s_IRS;
    odin_model_p->delay_w[3] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Bed * (1 - r_IRS) * s_ITN * s_IRS + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * (1 - r_IRS) * s_IRS;
    odin_model_p->delay_z[0] = 0;
    odin_model_p->delay_z[1] = odin_model_p->bites_Bed * r_ITN;
    odin_model_p->delay_z[2] = odin_model_p->bites_Indoors * r_IRS;
    odin_model_p->delay_z[3] = odin_model_p->bites_Bed * (r_IRS + (1 - r_IRS) * r_ITN) + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * r_IRS;
    for (int i = 0; i < odin_model_p->num_int; ++i) {
      odin_model_p->delay_zhi[i] = odin_model_p->cov[i] * odin_model_p->delay_z[i];
    }
    for (int i = 0; i < odin_model_p->num_int; ++i) {
      odin_model_p->delay_whi[i] = odin_model_p->cov[i] * odin_model_p->delay_w[i];
    }
    double zh = (t < odin_model_p->ITN_IRS_on ? 0 : odin_sum1(odin_model_p->delay_zhi, 0, odin_model_p->dim_zhi - 1));
    double wh = (t < odin_model_p->ITN_IRS_on ? 1 : odin_sum1(odin_model_p->delay_whi, 0, odin_model_p->dim_whi - 1));
    double zbar = odin_model_p->Q0 * zh;
    double fv = (double) 1 / (odin_model_p->tau1 / (1 - zbar) + odin_model_p->tau2);
    double wbar = 1 - odin_model_p->Q0 + odin_model_p->Q0 * wh;
    double p1 = wbar * odin_model_p->p10 / (1 - zbar * odin_model_p->p10);
    double mu = -fv * log(p1 * odin_model_p->p2);
    double surv = exp(-mu * odin_model_p->delayMos);
    double lag_incv = ince * surv;
    incv = lag_incv;
  }
  double mv = Sv + odin_sum1(Ev, 0, odin_model_p->dim_Ev - 1) + Iv;
  dstatedt[4] = LL / odin_model_p->dLL - odin_model_p->muPL * PL - PL / odin_model_p->dPL;
  {
    int i = 0;
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_S[i + j * odin_model_p->dim_S_1 + k * odin_model_p->dim_S_12] = -odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * S[i + j * odin_model_p->dim_S_1 + k * odin_model_p->dim_S_12] + odin_model_p->rP * P[i + j * odin_model_p->dim_P_1 + k * odin_model_p->dim_P_12] + odin_model_p->rU * U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12] + odin_model_p->cov[k] * odin_model_p->eta * H * odin_model_p->het_wt[j] - (odin_model_p->eta + odin_model_p->age_rate[i]) * S[i + j * odin_model_p->dim_S_1 + k * odin_model_p->dim_S_12];
      }
    }
  }
  for (int i = 1; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_S[i + j * odin_model_p->dim_S_1 + k * odin_model_p->dim_S_12] = -odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * S[i + j * odin_model_p->dim_S_1 + k * odin_model_p->dim_S_12] + odin_model_p->rP * P[i + j * odin_model_p->dim_P_1 + k * odin_model_p->dim_P_12] + odin_model_p->rU * U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12] - (odin_model_p->eta + odin_model_p->age_rate[i]) * S[i + j * odin_model_p->dim_S_1 + k * odin_model_p->dim_S_12] + odin_model_p->age_rate[i - 1] * S[i - 1 + j * odin_model_p->dim_S_1 + k * odin_model_p->dim_S_12];
      }
    }
  }
  double ITN_decay = (t < odin_model_p->ITN_IRS_on ? 0 : exp(-(fmodr((t - odin_model_p->ITN_IRS_on), odin_model_p->ITN_interval)) * odin_model_p->itn_loss));
  double IRS_decay = (t < odin_model_p->ITN_IRS_on ? 0 : exp(-(fmodr((t - odin_model_p->ITN_IRS_on), odin_model_p->IRS_interval)) * odin_model_p->irs_loss));
  double d_ITN = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->d_ITN0 * ITN_decay);
  double r_ITN = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->r_ITN1 + (odin_model_p->r_ITN0 - odin_model_p->r_ITN1) * ITN_decay);
  double s_ITN = (t < odin_model_p->ITN_IRS_on ? 1 : 1 - d_ITN - r_ITN);
  double r_IRS = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->r_IRS0 * IRS_decay);
  double d_IRS = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->chi * odin_model_p->d_IRS0 * IRS_decay);
  double s_IRS = (t < odin_model_p->ITN_IRS_on ? 1 : 1 - d_IRS);
  odin_model_p->w[0] = 1;
  odin_model_p->w[1] = 1 - odin_model_p->bites_Bed + odin_model_p->bites_Bed * s_ITN;
  odin_model_p->w[2] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Indoors * (1 - r_IRS) * s_IRS;
  odin_model_p->w[3] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Bed * (1 - r_IRS) * s_ITN * s_IRS + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * (1 - r_IRS) * s_IRS;
  odin_model_p->yy[0] = 1;
  odin_model_p->yy[1] = odin_model_p->w[1];
  odin_model_p->yy[2] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Indoors * (1 - r_IRS);
  odin_model_p->yy[3] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Bed * (1 - r_IRS) * s_ITN + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * (1 - r_IRS);
  odin_model_p->z[0] = 0;
  odin_model_p->z[1] = odin_model_p->bites_Bed * r_ITN;
  odin_model_p->z[2] = odin_model_p->bites_Indoors * r_IRS;
  odin_model_p->z[3] = odin_model_p->bites_Bed * (r_IRS + (1 - r_IRS) * r_ITN) + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * r_IRS;
  for (int i = 0; i < odin_model_p->num_int; ++i) {
    odin_model_p->zhi[i] = odin_model_p->cov[i] * odin_model_p->z[i];
  }
  for (int i = 0; i < odin_model_p->num_int; ++i) {
    odin_model_p->whi[i] = odin_model_p->cov[i] * odin_model_p->w[i];
  }
  double zh = (t < odin_model_p->ITN_IRS_on ? 0 : odin_sum1(odin_model_p->zhi, 0, odin_model_p->dim_zhi - 1));
  double wh = (t < odin_model_p->ITN_IRS_on ? 1 : odin_sum1(odin_model_p->whi, 0, odin_model_p->dim_whi - 1));
  double zbar = odin_model_p->Q0 * zh;
  double fv = (double) 1 / (odin_model_p->tau1 / (1 - zbar) + odin_model_p->tau2);
  double wbar = 1 - odin_model_p->Q0 + odin_model_p->Q0 * wh;
  double p1 = wbar * odin_model_p->p10 / (1 - zbar * odin_model_p->p10);
  double mu = -fv * log(p1 * odin_model_p->p2);
  double betaa = odin_model_p->mv0 * mu * theta2;
  dstatedt[0] = -ince - mu * Sv + betaa;
  {
    int i = 0;
    deriv_Ev[i] = ince - Ev[0] - mu * Ev[0];
  }
  for (int i = 1; i < 10; ++i) {
    deriv_Ev[i] = Ev[i - 1] - Ev[i] - mu * Ev[i];
  }
  dstatedt[1] = incv - mu * Iv;
  double eov = odin_model_p->beta_larval0 / mu * (exp(mu / fv) - 1);
  double beta_larval = eov * mu * exp(-mu / fv) / (1 - exp(-mu / fv));
  double lambda = -0.5 * odin_model_p->b_lambda + sqrt(0.25 * pow(odin_model_p->b_lambda, 2) + odin_model_p->gammaL * beta_larval * odin_model_p->muLL * odin_model_p->dEL / (2 * odin_model_p->muEL * mu * odin_model_p->dLL * (1 + odin_model_p->dPL * odin_model_p->muPL)));
  double K0 = 2 * odin_model_p->mv0 * odin_model_p->dLL * mu * (1 + odin_model_p->dPL * odin_model_p->muPL) * odin_model_p->gammaL * (lambda + 1) / (lambda / (odin_model_p->muLL * odin_model_p->dEL) - (double) 1 / (odin_model_p->muLL * odin_model_p->dLL) - 1);
  double KL = K0 * theta2;
  dstatedt[2] = beta_larval * mv - odin_model_p->muEL * (1 + (EL + LL) / KL) * EL - EL / odin_model_p->dEL;
  dstatedt[3] = EL / odin_model_p->dEL - odin_model_p->muLL * (1 + odin_model_p->gammaL * (EL + LL) / KL) * LL - LL / odin_model_p->dLL;
  double Q = 1 - (1 - odin_model_p->Q0) / wbar;
  double av = fv * Q;
  for (int i = 0; i < odin_model_p->num_int; ++i) {
    odin_model_p->av_human[i] = av * odin_model_p->yy[i] / wh;
  }
  for (int i = 0; i < odin_model_p->dim_EIR_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_EIR_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_EIR_3; ++k) {
        odin_model_p->EIR[i + j * odin_model_p->dim_EIR_1 + k * odin_model_p->dim_EIR_12] = odin_model_p->av_human[k] * odin_model_p->rel_foi[j] * odin_model_p->foi_age[i] / odin_model_p->omega * Iv;
      }
    }
  }
  {
    int i = 0;
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_IB[i + j * odin_model_p->dim_IB_1 + k * odin_model_p->dim_IB_12] = odin_model_p->EIR[i + j * odin_model_p->dim_EIR_1 + k * odin_model_p->dim_EIR_12] / (odin_model_p->EIR[i + j * odin_model_p->dim_EIR_1 + k * odin_model_p->dim_EIR_12] * odin_model_p->uB + 1) - IB[i + j * odin_model_p->dim_IB_1 + k * odin_model_p->dim_IB_12] / odin_model_p->dB - IB[i + j * odin_model_p->dim_IB_1 + k * odin_model_p->dim_IB_12] / odin_model_p->x_I[i];
      }
    }
  }
  for (int i = 1; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        deriv_IB[i + j * odin_model_p->dim_IB_1 + k * odin_model_p->dim_IB_12] = odin_model_p->EIR[i + j * odin_model_p->dim_EIR_1 + k * odin_model_p->dim_EIR_12] / (odin_model_p->EIR[i + j * odin_model_p->dim_EIR_1 + k * odin_model_p->dim_EIR_12] * odin_model_p->uB + 1) - IB[i + j * odin_model_p->dim_IB_1 + k * odin_model_p->dim_IB_12] / odin_model_p->dB - (IB[i + j * odin_model_p->dim_IB_1 + k * odin_model_p->dim_IB_12] - IB[i - 1 + j * odin_model_p->dim_IB_1 + k * odin_model_p->dim_IB_12]) / odin_model_p->x_I[i];
      }
    }
  }
  if (output != NULL) {
    double *output_cov = output + 22;
    for (int i = 0; i < odin_model_p->dim_p_det_1; ++i) {
      for (int j = 0; j < odin_model_p->dim_p_det_2; ++j) {
        for (int k = 0; k < odin_model_p->dim_p_det_3; ++k) {
          odin_model_p->p_det[i + j * odin_model_p->dim_p_det_1 + k * odin_model_p->dim_p_det_12] = odin_model_p->d1 + (1 - odin_model_p->d1) / (1 + odin_model_p->fd[i] * pow((ID[i + j * odin_model_p->dim_ID_1 + k * odin_model_p->dim_ID_12] / odin_model_p->ID0), odin_model_p->kD));
        }
      }
    }
    output[0] = odin_sum3(S, 0, odin_model_p->dim_S_1 - 1, 0, odin_model_p->dim_S_2 - 1, 0, odin_model_p->dim_S_3 - 1, odin_model_p->dim_S_1, odin_model_p->dim_S_12);
    output[1] = odin_sum3(T, 0, odin_model_p->dim_T_1 - 1, 0, odin_model_p->dim_T_2 - 1, 0, odin_model_p->dim_T_3 - 1, odin_model_p->dim_T_1, odin_model_p->dim_T_12);
    output[2] = odin_sum3(D, 0, odin_model_p->dim_D_1 - 1, 0, odin_model_p->dim_D_2 - 1, 0, odin_model_p->dim_D_3 - 1, odin_model_p->dim_D_1, odin_model_p->dim_D_12);
    output[3] = odin_sum3(A, 0, odin_model_p->dim_A_1 - 1, 0, odin_model_p->dim_A_2 - 1, 0, odin_model_p->dim_A_3 - 1, odin_model_p->dim_A_1, odin_model_p->dim_A_12);
    output[4] = odin_sum3(U, 0, odin_model_p->dim_U_1 - 1, 0, odin_model_p->dim_U_2 - 1, 0, odin_model_p->dim_U_3 - 1, odin_model_p->dim_U_1, odin_model_p->dim_U_12);
    output[5] = odin_sum3(P, 0, odin_model_p->dim_P_1 - 1, 0, odin_model_p->dim_P_2 - 1, 0, odin_model_p->dim_P_3 - 1, odin_model_p->dim_P_1, odin_model_p->dim_P_12);
    for (int i = 0; i < odin_model_p->age59; ++i) {
      for (int j = 0; j < odin_model_p->dim_prev0to59_2; ++j) {
        for (int k = 0; k < odin_model_p->dim_prev0to59_3; ++k) {
          odin_model_p->prev0to59[i + j * odin_model_p->dim_prev0to59_1 + k * odin_model_p->dim_prev0to59_12] = T[i + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12] + D[i + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12] + A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] * odin_model_p->p_det[i + j * odin_model_p->dim_p_det_1 + k * odin_model_p->dim_p_det_12];
        }
      }
    }
    output[6] = odin_sum3(odin_model_p->prev0to59, 0, odin_model_p->dim_prev0to59_1 - 1, 0, odin_model_p->dim_prev0to59_2 - 1, 0, odin_model_p->dim_prev0to59_3 - 1, odin_model_p->dim_prev0to59_1, odin_model_p->dim_prev0to59_12) / odin_sum1(odin_model_p->den, 0, odin_model_p->age59 - 1);
    for (int i = 0; i < odin_model_p->age05; ++i) {
      for (int j = 0; j < odin_model_p->dim_clin_inc0to5_2; ++j) {
        for (int k = 0; k < odin_model_p->dim_clin_inc0to5_3; ++k) {
          odin_model_p->clin_inc0to5[i + j * odin_model_p->dim_clin_inc0to5_1 + k * odin_model_p->dim_clin_inc0to5_12] = odin_model_p->clin_inc[i + j * odin_model_p->dim_clin_inc_1 + k * odin_model_p->dim_clin_inc_12];
        }
      }
    }
    output[7] = odin_sum1(odin_model_p->clin_inc0to5, 0, odin_model_p->dim_clin_inc0to5 - 1) / odin_sum1(odin_model_p->den, 0, odin_model_p->age05 - 1);
    output[8] = odin_sum3(odin_model_p->clin_inc, 0, odin_model_p->dim_clin_inc_1 - 1, 0, odin_model_p->dim_clin_inc_2 - 1, 0, odin_model_p->dim_clin_inc_3 - 1, odin_model_p->dim_clin_inc_1, odin_model_p->dim_clin_inc_12);
    output[9] = mu;
    output[10] = beta_larval;
    output[11] = KL;
    output[12] = mv;
    output[13] = Q;
    output[14] = wh;
    output[15] = d_ITN;
    output[16] = r_ITN;
    output[17] = s_ITN;
    output[18] = d_IRS;
    output[19] = r_IRS;
    output[20] = s_IRS;
    for (int i = 0; i < odin_model_p->dim_cov; ++i) {
      output_cov[i] = odin_model_p->cov[i];
    }
    output[21] = K0;
  }
}

void odin_model_output(odin_model_pars *odin_model_p, double t, double *state, double *output) {
  double Sv = state[0];
  double Iv = state[1];
  double *Ev = state + 5;
  double *S = state + odin_model_p->offset_S;
  double *T = state + odin_model_p->offset_T;
  double *D = state + odin_model_p->offset_D;
  double *A = state + odin_model_p->offset_A;
  double *U = state + odin_model_p->offset_U;
  double *P = state + odin_model_p->offset_P;
  double *ICM = state + odin_model_p->offset_ICM;
  double *ICA = state + odin_model_p->offset_ICA;
  double *ID = state + odin_model_p->offset_ID;
  double *output_cov = output + 22;
  for (int i = 0; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        odin_model_p->Y[i + j * odin_model_p->dim_Y_1 + k * odin_model_p->dim_Y_12] = S[i + j * odin_model_p->dim_S_1 + k * odin_model_p->dim_S_12] + A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] + U[i + j * odin_model_p->dim_U_1 + k * odin_model_p->dim_U_12];
      }
    }
  }
  for (int i = 0; i < odin_model_p->dim_IC_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_IC_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_IC_3; ++k) {
        odin_model_p->IC[i + j * odin_model_p->dim_IC_1 + k * odin_model_p->dim_IC_12] = ICM[i + j * odin_model_p->dim_ICM_1 + k * odin_model_p->dim_ICM_12] + ICA[i + j * odin_model_p->dim_ICA_1 + k * odin_model_p->dim_ICA_12];
      }
    }
  }
  for (int i = 0; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        odin_model_p->phi[i + j * odin_model_p->dim_phi_1 + k * odin_model_p->dim_phi_12] = odin_model_p->phi0 * ((1 - odin_model_p->phi1) / (1 + pow((odin_model_p->IC[i + j * odin_model_p->dim_IC_1 + k * odin_model_p->dim_IC_12] / odin_model_p->IC0), odin_model_p->kC)) + odin_model_p->phi1);
      }
    }
  }
  for (int i = 0; i < odin_model_p->dim_p_det_1; ++i) {
    for (int j = 0; j < odin_model_p->dim_p_det_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_p_det_3; ++k) {
        odin_model_p->p_det[i + j * odin_model_p->dim_p_det_1 + k * odin_model_p->dim_p_det_12] = odin_model_p->d1 + (1 - odin_model_p->d1) / (1 + odin_model_p->fd[i] * pow((ID[i + j * odin_model_p->dim_ID_1 + k * odin_model_p->dim_ID_12] / odin_model_p->ID0), odin_model_p->kD));
      }
    }
  }
  {
    // delay block for FOI
    double Iv, *IB;
    const double odin_true_t = t;
    const double t = odin_true_t - odin_model_p->dE;
    if (t <= odin_model_p->initial_t) {
      Iv = odin_model_p->initial_Iv;
      IB = odin_model_p->initial_IB;
    } else {
      if (odin_model_p->odin_use_dde) {
        lagvalue_dde(t, odin_model_p->delay_i_FOI, odin_model_p->dim_delay_FOI, odin_model_p->delay_state_FOI);
      } else {
        lagvalue_ds(t, odin_model_p->delay_i_FOI, odin_model_p->dim_delay_FOI, odin_model_p->delay_state_FOI);
      }
      Iv = odin_model_p->delay_state_FOI[0];
      IB = odin_model_p->delay_state_FOI + 1;
    }
    for (int i = 0; i < odin_model_p->na; ++i) {
      for (int j = 0; j < odin_model_p->nh; ++j) {
        for (int k = 0; k < odin_model_p->num_int; ++k) {
          odin_model_p->delay_b[i + j * odin_model_p->dim_b_1 + k * odin_model_p->dim_b_12] = odin_model_p->b0 * ((1 - odin_model_p->b1) / (1 + pow((IB[i + j * odin_model_p->dim_IB_1 + k * odin_model_p->dim_IB_12] / odin_model_p->IB0), odin_model_p->kB)) + odin_model_p->b1);
        }
      }
    }
    double ITN_decay = (t < odin_model_p->ITN_IRS_on ? 0 : exp(-(fmodr((t - odin_model_p->ITN_IRS_on), odin_model_p->ITN_interval)) * odin_model_p->itn_loss));
    double IRS_decay = (t < odin_model_p->ITN_IRS_on ? 0 : exp(-(fmodr((t - odin_model_p->ITN_IRS_on), odin_model_p->IRS_interval)) * odin_model_p->irs_loss));
    double d_ITN = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->d_ITN0 * ITN_decay);
    double r_ITN = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->r_ITN1 + (odin_model_p->r_ITN0 - odin_model_p->r_ITN1) * ITN_decay);
    double s_ITN = (t < odin_model_p->ITN_IRS_on ? 1 : 1 - d_ITN - r_ITN);
    double r_IRS = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->r_IRS0 * IRS_decay);
    double d_IRS = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->chi * odin_model_p->d_IRS0 * IRS_decay);
    double s_IRS = (t < odin_model_p->ITN_IRS_on ? 1 : 1 - d_IRS);
    odin_model_p->delay_w[0] = 1;
    odin_model_p->delay_w[1] = 1 - odin_model_p->bites_Bed + odin_model_p->bites_Bed * s_ITN;
    odin_model_p->delay_w[2] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Indoors * (1 - r_IRS) * s_IRS;
    odin_model_p->delay_w[3] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Bed * (1 - r_IRS) * s_ITN * s_IRS + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * (1 - r_IRS) * s_IRS;
    odin_model_p->delay_yy[0] = 1;
    odin_model_p->delay_yy[1] = odin_model_p->delay_w[1];
    odin_model_p->delay_yy[2] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Indoors * (1 - r_IRS);
    odin_model_p->delay_yy[3] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Bed * (1 - r_IRS) * s_ITN + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * (1 - r_IRS);
    odin_model_p->delay_z[0] = 0;
    odin_model_p->delay_z[1] = odin_model_p->bites_Bed * r_ITN;
    odin_model_p->delay_z[2] = odin_model_p->bites_Indoors * r_IRS;
    odin_model_p->delay_z[3] = odin_model_p->bites_Bed * (r_IRS + (1 - r_IRS) * r_ITN) + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * r_IRS;
    for (int i = 0; i < odin_model_p->num_int; ++i) {
      odin_model_p->delay_zhi[i] = odin_model_p->cov[i] * odin_model_p->delay_z[i];
    }
    for (int i = 0; i < odin_model_p->num_int; ++i) {
      odin_model_p->delay_whi[i] = odin_model_p->cov[i] * odin_model_p->delay_w[i];
    }
    double zh = (t < odin_model_p->ITN_IRS_on ? 0 : odin_sum1(odin_model_p->delay_zhi, 0, odin_model_p->dim_zhi - 1));
    double wh = (t < odin_model_p->ITN_IRS_on ? 1 : odin_sum1(odin_model_p->delay_whi, 0, odin_model_p->dim_whi - 1));
    double zbar = odin_model_p->Q0 * zh;
    double fv = (double) 1 / (odin_model_p->tau1 / (1 - zbar) + odin_model_p->tau2);
    double wbar = 1 - odin_model_p->Q0 + odin_model_p->Q0 * wh;
    double Q = 1 - (1 - odin_model_p->Q0) / wbar;
    double av = fv * Q;
    for (int i = 0; i < odin_model_p->num_int; ++i) {
      odin_model_p->delay_av_human[i] = av * odin_model_p->delay_yy[i] / wh;
    }
    for (int i = 0; i < odin_model_p->dim_EIR_1; ++i) {
      for (int j = 0; j < odin_model_p->dim_EIR_2; ++j) {
        for (int k = 0; k < odin_model_p->dim_EIR_3; ++k) {
          odin_model_p->delay_EIR[i + j * odin_model_p->dim_EIR_1 + k * odin_model_p->dim_EIR_12] = odin_model_p->delay_av_human[k] * odin_model_p->rel_foi[j] * odin_model_p->foi_age[i] / odin_model_p->omega * Iv;
        }
      }
    }
    for (int i = 0; i < odin_model_p->na; ++i) {
      for (int j = 0; j < odin_model_p->nh; ++j) {
        for (int k = 0; k < odin_model_p->num_int; ++k) {
          odin_model_p->delay_FOI_lag[i + j * odin_model_p->dim_FOI_lag_1 + k * odin_model_p->dim_FOI_lag_12] = odin_model_p->delay_EIR[i + j * odin_model_p->dim_EIR_1 + k * odin_model_p->dim_EIR_12] * ((IB[i + j * odin_model_p->dim_IB_1 + k * odin_model_p->dim_IB_12] == 0 ? odin_model_p->b0 : odin_model_p->delay_b[i + j * odin_model_p->dim_b_1 + k * odin_model_p->dim_b_12]));
        }
      }
    }
    for (int i = 0; i < odin_model_p->dim_FOI_1; ++i) {
      for (int j = 0; j < odin_model_p->dim_FOI_2; ++j) {
        for (int k = 0; k < odin_model_p->dim_FOI_3; ++k) {
          odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] = odin_model_p->delay_FOI_lag[i + j * odin_model_p->dim_FOI_lag_1 + k * odin_model_p->dim_FOI_lag_12];
        }
      }
    }
  }
  for (int i = 0; i < odin_model_p->na; ++i) {
    for (int j = 0; j < odin_model_p->nh; ++j) {
      for (int k = 0; k < odin_model_p->num_int; ++k) {
        odin_model_p->clin_inc[i + j * odin_model_p->dim_clin_inc_1 + k * odin_model_p->dim_clin_inc_12] = odin_model_p->phi[i + j * odin_model_p->dim_phi_1 + k * odin_model_p->dim_phi_12] * odin_model_p->FOI[i + j * odin_model_p->dim_FOI_1 + k * odin_model_p->dim_FOI_12] * odin_model_p->Y[i + j * odin_model_p->dim_Y_1 + k * odin_model_p->dim_Y_12];
      }
    }
  }
  double theta2 = (odin_model_p->ssa0 == 0 && odin_model_p->ssa1 == 0 && odin_model_p->ssa2 == 0 && odin_model_p->ssb1 == 0 && odin_model_p->ssb2 == 0 && odin_model_p->ssb3 == 0 && odin_model_p->theta_c == 0 ? 1 : fmax((odin_model_p->ssa0 + odin_model_p->ssa1 * cos(2 * odin_model_p->pi * t / (double) 365) + odin_model_p->ssa2 * cos(2 * 2 * odin_model_p->pi * t / (double) 365) + odin_model_p->ssa3 * cos(3 * 2 * odin_model_p->pi * t / (double) 365) + odin_model_p->ssb1 * sin(2 * odin_model_p->pi * t / (double) 365) + odin_model_p->ssb2 * sin(2 * 2 * odin_model_p->pi * t / (double) 365) + odin_model_p->ssb3 * sin(3 * 2 * odin_model_p->pi * t / (double) 365)) / odin_model_p->theta_c, 0.001));
  double mv = Sv + odin_sum1(Ev, 0, odin_model_p->dim_Ev - 1) + Iv;
  double ITN_decay = (t < odin_model_p->ITN_IRS_on ? 0 : exp(-(fmodr((t - odin_model_p->ITN_IRS_on), odin_model_p->ITN_interval)) * odin_model_p->itn_loss));
  double IRS_decay = (t < odin_model_p->ITN_IRS_on ? 0 : exp(-(fmodr((t - odin_model_p->ITN_IRS_on), odin_model_p->IRS_interval)) * odin_model_p->irs_loss));
  double d_ITN = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->d_ITN0 * ITN_decay);
  double r_ITN = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->r_ITN1 + (odin_model_p->r_ITN0 - odin_model_p->r_ITN1) * ITN_decay);
  double s_ITN = (t < odin_model_p->ITN_IRS_on ? 1 : 1 - d_ITN - r_ITN);
  double r_IRS = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->r_IRS0 * IRS_decay);
  double d_IRS = (t < odin_model_p->ITN_IRS_on ? 0 : odin_model_p->chi * odin_model_p->d_IRS0 * IRS_decay);
  double s_IRS = (t < odin_model_p->ITN_IRS_on ? 1 : 1 - d_IRS);
  odin_model_p->w[0] = 1;
  odin_model_p->w[1] = 1 - odin_model_p->bites_Bed + odin_model_p->bites_Bed * s_ITN;
  odin_model_p->w[2] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Indoors * (1 - r_IRS) * s_IRS;
  odin_model_p->w[3] = 1 - odin_model_p->bites_Indoors + odin_model_p->bites_Bed * (1 - r_IRS) * s_ITN * s_IRS + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * (1 - r_IRS) * s_IRS;
  odin_model_p->z[0] = 0;
  odin_model_p->z[1] = odin_model_p->bites_Bed * r_ITN;
  odin_model_p->z[2] = odin_model_p->bites_Indoors * r_IRS;
  odin_model_p->z[3] = odin_model_p->bites_Bed * (r_IRS + (1 - r_IRS) * r_ITN) + (odin_model_p->bites_Indoors - odin_model_p->bites_Bed) * r_IRS;
  for (int i = 0; i < odin_model_p->num_int; ++i) {
    odin_model_p->zhi[i] = odin_model_p->cov[i] * odin_model_p->z[i];
  }
  for (int i = 0; i < odin_model_p->num_int; ++i) {
    odin_model_p->whi[i] = odin_model_p->cov[i] * odin_model_p->w[i];
  }
  double zh = (t < odin_model_p->ITN_IRS_on ? 0 : odin_sum1(odin_model_p->zhi, 0, odin_model_p->dim_zhi - 1));
  double wh = (t < odin_model_p->ITN_IRS_on ? 1 : odin_sum1(odin_model_p->whi, 0, odin_model_p->dim_whi - 1));
  double zbar = odin_model_p->Q0 * zh;
  double fv = (double) 1 / (odin_model_p->tau1 / (1 - zbar) + odin_model_p->tau2);
  double wbar = 1 - odin_model_p->Q0 + odin_model_p->Q0 * wh;
  double p1 = wbar * odin_model_p->p10 / (1 - zbar * odin_model_p->p10);
  double mu = -fv * log(p1 * odin_model_p->p2);
  double eov = odin_model_p->beta_larval0 / mu * (exp(mu / fv) - 1);
  double beta_larval = eov * mu * exp(-mu / fv) / (1 - exp(-mu / fv));
  double lambda = -0.5 * odin_model_p->b_lambda + sqrt(0.25 * pow(odin_model_p->b_lambda, 2) + odin_model_p->gammaL * beta_larval * odin_model_p->muLL * odin_model_p->dEL / (2 * odin_model_p->muEL * mu * odin_model_p->dLL * (1 + odin_model_p->dPL * odin_model_p->muPL)));
  double K0 = 2 * odin_model_p->mv0 * odin_model_p->dLL * mu * (1 + odin_model_p->dPL * odin_model_p->muPL) * odin_model_p->gammaL * (lambda + 1) / (lambda / (odin_model_p->muLL * odin_model_p->dEL) - (double) 1 / (odin_model_p->muLL * odin_model_p->dLL) - 1);
  double KL = K0 * theta2;
  double Q = 1 - (1 - odin_model_p->Q0) / wbar;
  output[0] = odin_sum3(S, 0, odin_model_p->dim_S_1 - 1, 0, odin_model_p->dim_S_2 - 1, 0, odin_model_p->dim_S_3 - 1, odin_model_p->dim_S_1, odin_model_p->dim_S_12);
  output[1] = odin_sum3(T, 0, odin_model_p->dim_T_1 - 1, 0, odin_model_p->dim_T_2 - 1, 0, odin_model_p->dim_T_3 - 1, odin_model_p->dim_T_1, odin_model_p->dim_T_12);
  output[2] = odin_sum3(D, 0, odin_model_p->dim_D_1 - 1, 0, odin_model_p->dim_D_2 - 1, 0, odin_model_p->dim_D_3 - 1, odin_model_p->dim_D_1, odin_model_p->dim_D_12);
  output[3] = odin_sum3(A, 0, odin_model_p->dim_A_1 - 1, 0, odin_model_p->dim_A_2 - 1, 0, odin_model_p->dim_A_3 - 1, odin_model_p->dim_A_1, odin_model_p->dim_A_12);
  output[4] = odin_sum3(U, 0, odin_model_p->dim_U_1 - 1, 0, odin_model_p->dim_U_2 - 1, 0, odin_model_p->dim_U_3 - 1, odin_model_p->dim_U_1, odin_model_p->dim_U_12);
  output[5] = odin_sum3(P, 0, odin_model_p->dim_P_1 - 1, 0, odin_model_p->dim_P_2 - 1, 0, odin_model_p->dim_P_3 - 1, odin_model_p->dim_P_1, odin_model_p->dim_P_12);
  for (int i = 0; i < odin_model_p->age59; ++i) {
    for (int j = 0; j < odin_model_p->dim_prev0to59_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_prev0to59_3; ++k) {
        odin_model_p->prev0to59[i + j * odin_model_p->dim_prev0to59_1 + k * odin_model_p->dim_prev0to59_12] = T[i + j * odin_model_p->dim_T_1 + k * odin_model_p->dim_T_12] + D[i + j * odin_model_p->dim_D_1 + k * odin_model_p->dim_D_12] + A[i + j * odin_model_p->dim_A_1 + k * odin_model_p->dim_A_12] * odin_model_p->p_det[i + j * odin_model_p->dim_p_det_1 + k * odin_model_p->dim_p_det_12];
      }
    }
  }
  output[6] = odin_sum3(odin_model_p->prev0to59, 0, odin_model_p->dim_prev0to59_1 - 1, 0, odin_model_p->dim_prev0to59_2 - 1, 0, odin_model_p->dim_prev0to59_3 - 1, odin_model_p->dim_prev0to59_1, odin_model_p->dim_prev0to59_12) / odin_sum1(odin_model_p->den, 0, odin_model_p->age59 - 1);
  for (int i = 0; i < odin_model_p->age05; ++i) {
    for (int j = 0; j < odin_model_p->dim_clin_inc0to5_2; ++j) {
      for (int k = 0; k < odin_model_p->dim_clin_inc0to5_3; ++k) {
        odin_model_p->clin_inc0to5[i + j * odin_model_p->dim_clin_inc0to5_1 + k * odin_model_p->dim_clin_inc0to5_12] = odin_model_p->clin_inc[i + j * odin_model_p->dim_clin_inc_1 + k * odin_model_p->dim_clin_inc_12];
      }
    }
  }
  output[7] = odin_sum1(odin_model_p->clin_inc0to5, 0, odin_model_p->dim_clin_inc0to5 - 1) / odin_sum1(odin_model_p->den, 0, odin_model_p->age05 - 1);
  output[8] = odin_sum3(odin_model_p->clin_inc, 0, odin_model_p->dim_clin_inc_1 - 1, 0, odin_model_p->dim_clin_inc_2 - 1, 0, odin_model_p->dim_clin_inc_3 - 1, odin_model_p->dim_clin_inc_1, odin_model_p->dim_clin_inc_12);
  output[9] = mu;
  output[10] = beta_larval;
  output[11] = KL;
  output[12] = mv;
  output[13] = Q;
  output[14] = wh;
  output[15] = d_ITN;
  output[16] = r_ITN;
  output[17] = s_ITN;
  output[18] = d_IRS;
  output[19] = r_IRS;
  output[20] = s_IRS;
  for (int i = 0; i < odin_model_p->dim_cov; ++i) {
    output_cov[i] = odin_model_p->cov[i];
  }
  output[21] = K0;
}

// deSolve interface
// Global variable set on initmod, as per deSolve design
static odin_model_pars *odin_model_p;
void odin_model_initmod_ds(void(* odeparms) (int *, double *)) {
  DL_FUNC get_deSolve_gparms = R_GetCCallable("deSolve", "get_deSolve_gparms");
  odin_model_p = odin_model_get_pointer(get_deSolve_gparms(), 1);
}
void odin_model_deriv_ds(int *neq, double *t, double *state,
                         double *dstatedt, double *output, int *np) {
  odin_model_deriv(odin_model_p, *t, state, dstatedt, output);
}

// dde interface
void odin_model_deriv_dde(size_t n_eq, double t, double *state,
                           double *dstatedt, void *odin_model_p) {
  odin_model_deriv((odin_model_pars*)odin_model_p, t, state, dstatedt, NULL);
}

void odin_model_output_dde(size_t n_eq, double t, double *state,
                           size_t dim_output, double *output, void *odin_model_p) {
  odin_model_output((odin_model_pars*)odin_model_p, t, state, output);
}

SEXP odin_model_deriv_r(SEXP odin_model_ptr, SEXP t, SEXP state) {
  SEXP dstatedt = PROTECT(allocVector(REALSXP, LENGTH(state)));
  odin_model_pars *odin_model_p = odin_model_get_pointer(odin_model_ptr, 1);
  SEXP output_ptr = PROTECT(allocVector(REALSXP, odin_model_p->dim_output));
  setAttrib(dstatedt, install("output"), output_ptr);
  double *output = REAL(output_ptr);
  odin_model_deriv(odin_model_p, REAL(t)[0], REAL(state), REAL(dstatedt), output);
  UNPROTECT(2);
  return dstatedt;
}

// Translate all elements in the struct back to R
// This will mostly be useful for debugging.
SEXP odin_model_contents(SEXP odin_model_ptr) {
  odin_model_pars *odin_model_p = odin_model_get_pointer(odin_model_ptr, 1);
  SEXP state = PROTECT(allocVector(VECSXP, 361));
  SET_VECTOR_ELT(state, 0, ScalarInteger(odin_model_p->odin_use_dde));
  SET_VECTOR_ELT(state, 1, ScalarReal(odin_model_p->initial_t));
  SET_VECTOR_ELT(state, 2, ScalarInteger(odin_model_p->dim_Ev));
  SET_VECTOR_ELT(state, 3, allocVector(REALSXP, odin_model_p->dim_Ev));
  memcpy(REAL(VECTOR_ELT(state, 3)), odin_model_p->initial_Ev, odin_model_p->dim_Ev * sizeof(double));
  SET_VECTOR_ELT(state, 4, ScalarInteger(odin_model_p->offset_Ev));
  SET_VECTOR_ELT(state, 5, ScalarInteger(odin_model_p->na));
  SET_VECTOR_ELT(state, 6, ScalarInteger(odin_model_p->nh));
  SET_VECTOR_ELT(state, 7, ScalarReal(odin_model_p->ft));
  SET_VECTOR_ELT(state, 8, ScalarReal(odin_model_p->eta));
  SET_VECTOR_ELT(state, 9, ScalarReal(odin_model_p->rA));
  SET_VECTOR_ELT(state, 10, ScalarReal(odin_model_p->rT));
  SET_VECTOR_ELT(state, 11, ScalarReal(odin_model_p->rD));
  SET_VECTOR_ELT(state, 12, ScalarReal(odin_model_p->rU));
  SET_VECTOR_ELT(state, 13, ScalarReal(odin_model_p->rP));
  SET_VECTOR_ELT(state, 14, ScalarReal(odin_model_p->dCM));
  SET_VECTOR_ELT(state, 15, ScalarReal(odin_model_p->uCA));
  SET_VECTOR_ELT(state, 16, ScalarReal(odin_model_p->dCA));
  SET_VECTOR_ELT(state, 17, ScalarReal(odin_model_p->dB));
  SET_VECTOR_ELT(state, 18, ScalarReal(odin_model_p->uB));
  SET_VECTOR_ELT(state, 19, ScalarReal(odin_model_p->dID));
  SET_VECTOR_ELT(state, 20, ScalarReal(odin_model_p->uD));
  SET_VECTOR_ELT(state, 21, ScalarReal(odin_model_p->phi0));
  SET_VECTOR_ELT(state, 22, ScalarReal(odin_model_p->phi1));
  SET_VECTOR_ELT(state, 23, ScalarReal(odin_model_p->IC0));
  SET_VECTOR_ELT(state, 24, ScalarReal(odin_model_p->kC));
  SET_VECTOR_ELT(state, 25, ScalarReal(odin_model_p->b0));
  SET_VECTOR_ELT(state, 26, ScalarReal(odin_model_p->b1));
  SET_VECTOR_ELT(state, 27, ScalarReal(odin_model_p->kB));
  SET_VECTOR_ELT(state, 28, ScalarReal(odin_model_p->IB0));
  SET_VECTOR_ELT(state, 29, ScalarReal(odin_model_p->aD));
  SET_VECTOR_ELT(state, 30, ScalarReal(odin_model_p->fD0));
  SET_VECTOR_ELT(state, 31, ScalarReal(odin_model_p->gammaD));
  SET_VECTOR_ELT(state, 32, ScalarReal(odin_model_p->d1));
  SET_VECTOR_ELT(state, 33, ScalarReal(odin_model_p->ID0));
  SET_VECTOR_ELT(state, 34, ScalarReal(odin_model_p->kD));
  SET_VECTOR_ELT(state, 35, ScalarReal(odin_model_p->dE));
  SET_VECTOR_ELT(state, 36, ScalarReal(odin_model_p->pi));
  SET_VECTOR_ELT(state, 37, ScalarReal(odin_model_p->ssa0));
  SET_VECTOR_ELT(state, 38, ScalarReal(odin_model_p->ssa1));
  SET_VECTOR_ELT(state, 39, ScalarReal(odin_model_p->ssa2));
  SET_VECTOR_ELT(state, 40, ScalarReal(odin_model_p->ssa3));
  SET_VECTOR_ELT(state, 41, ScalarReal(odin_model_p->ssb1));
  SET_VECTOR_ELT(state, 42, ScalarReal(odin_model_p->ssb2));
  SET_VECTOR_ELT(state, 43, ScalarReal(odin_model_p->ssb3));
  SET_VECTOR_ELT(state, 44, ScalarReal(odin_model_p->theta_c));
  SET_VECTOR_ELT(state, 45, ScalarReal(odin_model_p->init_Sv));
  SET_VECTOR_ELT(state, 46, ScalarReal(odin_model_p->init_Ev));
  SET_VECTOR_ELT(state, 47, ScalarReal(odin_model_p->init_Iv));
  SET_VECTOR_ELT(state, 48, ScalarReal(odin_model_p->cU));
  SET_VECTOR_ELT(state, 49, ScalarReal(odin_model_p->cD));
  SET_VECTOR_ELT(state, 50, ScalarReal(odin_model_p->cT));
  SET_VECTOR_ELT(state, 51, ScalarReal(odin_model_p->gamma1));
  SET_VECTOR_ELT(state, 52, ScalarReal(odin_model_p->omega));
  SET_VECTOR_ELT(state, 53, ScalarReal(odin_model_p->delayGam));
  SET_VECTOR_ELT(state, 54, ScalarReal(odin_model_p->delayMos));
  SET_VECTOR_ELT(state, 55, ScalarReal(odin_model_p->dLL));
  SET_VECTOR_ELT(state, 56, ScalarReal(odin_model_p->dPL));
  SET_VECTOR_ELT(state, 57, ScalarReal(odin_model_p->dEL));
  SET_VECTOR_ELT(state, 58, ScalarReal(odin_model_p->muLL));
  SET_VECTOR_ELT(state, 59, ScalarReal(odin_model_p->muPL));
  SET_VECTOR_ELT(state, 60, ScalarReal(odin_model_p->muEL));
  SET_VECTOR_ELT(state, 61, ScalarReal(odin_model_p->gammaL));
  SET_VECTOR_ELT(state, 62, ScalarReal(odin_model_p->mv0));
  SET_VECTOR_ELT(state, 63, ScalarReal(odin_model_p->tau1));
  SET_VECTOR_ELT(state, 64, ScalarReal(odin_model_p->tau2));
  SET_VECTOR_ELT(state, 65, ScalarReal(odin_model_p->p10));
  SET_VECTOR_ELT(state, 66, ScalarReal(odin_model_p->p2));
  SET_VECTOR_ELT(state, 67, ScalarReal(odin_model_p->beta_larval0));
  SET_VECTOR_ELT(state, 68, ScalarReal(odin_model_p->init_PL));
  SET_VECTOR_ELT(state, 69, ScalarReal(odin_model_p->init_LL));
  SET_VECTOR_ELT(state, 70, ScalarReal(odin_model_p->init_EL));
  SET_VECTOR_ELT(state, 71, ScalarReal(odin_model_p->ITN_IRS_on));
  SET_VECTOR_ELT(state, 72, ScalarInteger(odin_model_p->num_int));
  SET_VECTOR_ELT(state, 73, ScalarReal(odin_model_p->itn_cov));
  SET_VECTOR_ELT(state, 74, ScalarReal(odin_model_p->irs_cov));
  SET_VECTOR_ELT(state, 75, ScalarReal(odin_model_p->IRS_interval));
  SET_VECTOR_ELT(state, 76, ScalarReal(odin_model_p->ITN_interval));
  SET_VECTOR_ELT(state, 77, ScalarReal(odin_model_p->chi));
  SET_VECTOR_ELT(state, 78, ScalarReal(odin_model_p->Q0));
  SET_VECTOR_ELT(state, 79, ScalarReal(odin_model_p->bites_Bed));
  SET_VECTOR_ELT(state, 80, ScalarReal(odin_model_p->bites_Indoors));
  SET_VECTOR_ELT(state, 81, ScalarReal(odin_model_p->r_ITN0));
  SET_VECTOR_ELT(state, 82, ScalarReal(odin_model_p->d_ITN0));
  SET_VECTOR_ELT(state, 83, ScalarReal(odin_model_p->d_IRS0));
  SET_VECTOR_ELT(state, 84, ScalarReal(odin_model_p->r_IRS0));
  SET_VECTOR_ELT(state, 85, ScalarReal(odin_model_p->r_ITN1));
  SET_VECTOR_ELT(state, 86, ScalarReal(odin_model_p->irs_loss));
  SET_VECTOR_ELT(state, 87, ScalarReal(odin_model_p->itn_loss));
  SET_VECTOR_ELT(state, 88, ScalarInteger(odin_model_p->age59));
  SET_VECTOR_ELT(state, 89, ScalarInteger(odin_model_p->age05));
  SET_VECTOR_ELT(state, 90, ScalarInteger(odin_model_p->dim_age_rate));
  SET_VECTOR_ELT(state, 91, allocVector(REALSXP, odin_model_p->dim_age_rate));
  memcpy(REAL(VECTOR_ELT(state, 91)), odin_model_p->age_rate, odin_model_p->dim_age_rate * sizeof(double));
  SET_VECTOR_ELT(state, 92, ScalarInteger(odin_model_p->dim_het_wt));
  SET_VECTOR_ELT(state, 93, allocVector(REALSXP, odin_model_p->dim_het_wt));
  memcpy(REAL(VECTOR_ELT(state, 93)), odin_model_p->het_wt, odin_model_p->dim_het_wt * sizeof(double));
  SET_VECTOR_ELT(state, 94, ScalarInteger(odin_model_p->dim_init_S));
  SET_VECTOR_ELT(state, 95, ScalarInteger(odin_model_p->dim_init_S_1));
  SET_VECTOR_ELT(state, 96, ScalarInteger(odin_model_p->dim_init_S_2));
  SET_VECTOR_ELT(state, 97, ScalarInteger(odin_model_p->dim_init_S_3));
  SET_VECTOR_ELT(state, 98, ScalarInteger(odin_model_p->dim_init_S_12));
  SET_VECTOR_ELT(state, 99, allocVector(REALSXP, odin_model_p->dim_init_S));
  memcpy(REAL(VECTOR_ELT(state, 99)), odin_model_p->init_S, odin_model_p->dim_init_S * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 99), 3, odin_model_p->dim_init_S_1, odin_model_p->dim_init_S_2, odin_model_p->dim_init_S_3);
  SET_VECTOR_ELT(state, 100, ScalarInteger(odin_model_p->dim_S));
  SET_VECTOR_ELT(state, 101, ScalarInteger(odin_model_p->dim_S_1));
  SET_VECTOR_ELT(state, 102, ScalarInteger(odin_model_p->dim_S_2));
  SET_VECTOR_ELT(state, 103, ScalarInteger(odin_model_p->dim_S_3));
  SET_VECTOR_ELT(state, 104, ScalarInteger(odin_model_p->dim_S_12));
  SET_VECTOR_ELT(state, 105, allocVector(REALSXP, odin_model_p->dim_S));
  memcpy(REAL(VECTOR_ELT(state, 105)), odin_model_p->initial_S, odin_model_p->dim_S * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 105), 3, odin_model_p->dim_S_1, odin_model_p->dim_S_2, odin_model_p->dim_S_3);
  SET_VECTOR_ELT(state, 106, ScalarInteger(odin_model_p->offset_S));
  SET_VECTOR_ELT(state, 107, ScalarInteger(odin_model_p->dim_init_T));
  SET_VECTOR_ELT(state, 108, ScalarInteger(odin_model_p->dim_init_T_1));
  SET_VECTOR_ELT(state, 109, ScalarInteger(odin_model_p->dim_init_T_2));
  SET_VECTOR_ELT(state, 110, ScalarInteger(odin_model_p->dim_init_T_3));
  SET_VECTOR_ELT(state, 111, ScalarInteger(odin_model_p->dim_init_T_12));
  SET_VECTOR_ELT(state, 112, allocVector(REALSXP, odin_model_p->dim_init_T));
  memcpy(REAL(VECTOR_ELT(state, 112)), odin_model_p->init_T, odin_model_p->dim_init_T * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 112), 3, odin_model_p->dim_init_T_1, odin_model_p->dim_init_T_2, odin_model_p->dim_init_T_3);
  SET_VECTOR_ELT(state, 113, ScalarInteger(odin_model_p->dim_T));
  SET_VECTOR_ELT(state, 114, ScalarInteger(odin_model_p->dim_T_1));
  SET_VECTOR_ELT(state, 115, ScalarInteger(odin_model_p->dim_T_2));
  SET_VECTOR_ELT(state, 116, ScalarInteger(odin_model_p->dim_T_3));
  SET_VECTOR_ELT(state, 117, ScalarInteger(odin_model_p->dim_T_12));
  SET_VECTOR_ELT(state, 118, allocVector(REALSXP, odin_model_p->dim_T));
  memcpy(REAL(VECTOR_ELT(state, 118)), odin_model_p->initial_T, odin_model_p->dim_T * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 118), 3, odin_model_p->dim_T_1, odin_model_p->dim_T_2, odin_model_p->dim_T_3);
  SET_VECTOR_ELT(state, 119, ScalarInteger(odin_model_p->offset_T));
  SET_VECTOR_ELT(state, 120, ScalarInteger(odin_model_p->dim_init_D));
  SET_VECTOR_ELT(state, 121, ScalarInteger(odin_model_p->dim_init_D_1));
  SET_VECTOR_ELT(state, 122, ScalarInteger(odin_model_p->dim_init_D_2));
  SET_VECTOR_ELT(state, 123, ScalarInteger(odin_model_p->dim_init_D_3));
  SET_VECTOR_ELT(state, 124, ScalarInteger(odin_model_p->dim_init_D_12));
  SET_VECTOR_ELT(state, 125, allocVector(REALSXP, odin_model_p->dim_init_D));
  memcpy(REAL(VECTOR_ELT(state, 125)), odin_model_p->init_D, odin_model_p->dim_init_D * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 125), 3, odin_model_p->dim_init_D_1, odin_model_p->dim_init_D_2, odin_model_p->dim_init_D_3);
  SET_VECTOR_ELT(state, 126, ScalarInteger(odin_model_p->dim_D));
  SET_VECTOR_ELT(state, 127, ScalarInteger(odin_model_p->dim_D_1));
  SET_VECTOR_ELT(state, 128, ScalarInteger(odin_model_p->dim_D_2));
  SET_VECTOR_ELT(state, 129, ScalarInteger(odin_model_p->dim_D_3));
  SET_VECTOR_ELT(state, 130, ScalarInteger(odin_model_p->dim_D_12));
  SET_VECTOR_ELT(state, 131, allocVector(REALSXP, odin_model_p->dim_D));
  memcpy(REAL(VECTOR_ELT(state, 131)), odin_model_p->initial_D, odin_model_p->dim_D * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 131), 3, odin_model_p->dim_D_1, odin_model_p->dim_D_2, odin_model_p->dim_D_3);
  SET_VECTOR_ELT(state, 132, ScalarInteger(odin_model_p->offset_D));
  SET_VECTOR_ELT(state, 133, ScalarInteger(odin_model_p->dim_init_A));
  SET_VECTOR_ELT(state, 134, ScalarInteger(odin_model_p->dim_init_A_1));
  SET_VECTOR_ELT(state, 135, ScalarInteger(odin_model_p->dim_init_A_2));
  SET_VECTOR_ELT(state, 136, ScalarInteger(odin_model_p->dim_init_A_3));
  SET_VECTOR_ELT(state, 137, ScalarInteger(odin_model_p->dim_init_A_12));
  SET_VECTOR_ELT(state, 138, allocVector(REALSXP, odin_model_p->dim_init_A));
  memcpy(REAL(VECTOR_ELT(state, 138)), odin_model_p->init_A, odin_model_p->dim_init_A * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 138), 3, odin_model_p->dim_init_A_1, odin_model_p->dim_init_A_2, odin_model_p->dim_init_A_3);
  SET_VECTOR_ELT(state, 139, ScalarInteger(odin_model_p->dim_A));
  SET_VECTOR_ELT(state, 140, ScalarInteger(odin_model_p->dim_A_1));
  SET_VECTOR_ELT(state, 141, ScalarInteger(odin_model_p->dim_A_2));
  SET_VECTOR_ELT(state, 142, ScalarInteger(odin_model_p->dim_A_3));
  SET_VECTOR_ELT(state, 143, ScalarInteger(odin_model_p->dim_A_12));
  SET_VECTOR_ELT(state, 144, allocVector(REALSXP, odin_model_p->dim_A));
  memcpy(REAL(VECTOR_ELT(state, 144)), odin_model_p->initial_A, odin_model_p->dim_A * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 144), 3, odin_model_p->dim_A_1, odin_model_p->dim_A_2, odin_model_p->dim_A_3);
  SET_VECTOR_ELT(state, 145, ScalarInteger(odin_model_p->offset_A));
  SET_VECTOR_ELT(state, 146, ScalarInteger(odin_model_p->dim_init_U));
  SET_VECTOR_ELT(state, 147, ScalarInteger(odin_model_p->dim_init_U_1));
  SET_VECTOR_ELT(state, 148, ScalarInteger(odin_model_p->dim_init_U_2));
  SET_VECTOR_ELT(state, 149, ScalarInteger(odin_model_p->dim_init_U_3));
  SET_VECTOR_ELT(state, 150, ScalarInteger(odin_model_p->dim_init_U_12));
  SET_VECTOR_ELT(state, 151, allocVector(REALSXP, odin_model_p->dim_init_U));
  memcpy(REAL(VECTOR_ELT(state, 151)), odin_model_p->init_U, odin_model_p->dim_init_U * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 151), 3, odin_model_p->dim_init_U_1, odin_model_p->dim_init_U_2, odin_model_p->dim_init_U_3);
  SET_VECTOR_ELT(state, 152, ScalarInteger(odin_model_p->dim_U));
  SET_VECTOR_ELT(state, 153, ScalarInteger(odin_model_p->dim_U_1));
  SET_VECTOR_ELT(state, 154, ScalarInteger(odin_model_p->dim_U_2));
  SET_VECTOR_ELT(state, 155, ScalarInteger(odin_model_p->dim_U_3));
  SET_VECTOR_ELT(state, 156, ScalarInteger(odin_model_p->dim_U_12));
  SET_VECTOR_ELT(state, 157, allocVector(REALSXP, odin_model_p->dim_U));
  memcpy(REAL(VECTOR_ELT(state, 157)), odin_model_p->initial_U, odin_model_p->dim_U * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 157), 3, odin_model_p->dim_U_1, odin_model_p->dim_U_2, odin_model_p->dim_U_3);
  SET_VECTOR_ELT(state, 158, ScalarInteger(odin_model_p->offset_U));
  SET_VECTOR_ELT(state, 159, ScalarInteger(odin_model_p->dim_init_P));
  SET_VECTOR_ELT(state, 160, ScalarInteger(odin_model_p->dim_init_P_1));
  SET_VECTOR_ELT(state, 161, ScalarInteger(odin_model_p->dim_init_P_2));
  SET_VECTOR_ELT(state, 162, ScalarInteger(odin_model_p->dim_init_P_3));
  SET_VECTOR_ELT(state, 163, ScalarInteger(odin_model_p->dim_init_P_12));
  SET_VECTOR_ELT(state, 164, allocVector(REALSXP, odin_model_p->dim_init_P));
  memcpy(REAL(VECTOR_ELT(state, 164)), odin_model_p->init_P, odin_model_p->dim_init_P * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 164), 3, odin_model_p->dim_init_P_1, odin_model_p->dim_init_P_2, odin_model_p->dim_init_P_3);
  SET_VECTOR_ELT(state, 165, ScalarInteger(odin_model_p->dim_P));
  SET_VECTOR_ELT(state, 166, ScalarInteger(odin_model_p->dim_P_1));
  SET_VECTOR_ELT(state, 167, ScalarInteger(odin_model_p->dim_P_2));
  SET_VECTOR_ELT(state, 168, ScalarInteger(odin_model_p->dim_P_3));
  SET_VECTOR_ELT(state, 169, ScalarInteger(odin_model_p->dim_P_12));
  SET_VECTOR_ELT(state, 170, allocVector(REALSXP, odin_model_p->dim_P));
  memcpy(REAL(VECTOR_ELT(state, 170)), odin_model_p->initial_P, odin_model_p->dim_P * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 170), 3, odin_model_p->dim_P_1, odin_model_p->dim_P_2, odin_model_p->dim_P_3);
  SET_VECTOR_ELT(state, 171, ScalarInteger(odin_model_p->offset_P));
  SET_VECTOR_ELT(state, 172, ScalarInteger(odin_model_p->dim_Y));
  SET_VECTOR_ELT(state, 173, ScalarInteger(odin_model_p->dim_Y_1));
  SET_VECTOR_ELT(state, 174, ScalarInteger(odin_model_p->dim_Y_2));
  SET_VECTOR_ELT(state, 175, ScalarInteger(odin_model_p->dim_Y_3));
  SET_VECTOR_ELT(state, 176, ScalarInteger(odin_model_p->dim_Y_12));
  SET_VECTOR_ELT(state, 177, allocVector(REALSXP, odin_model_p->dim_Y));
  memcpy(REAL(VECTOR_ELT(state, 177)), odin_model_p->Y, odin_model_p->dim_Y * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 177), 3, odin_model_p->dim_Y_1, odin_model_p->dim_Y_2, odin_model_p->dim_Y_3);
  SET_VECTOR_ELT(state, 178, ScalarInteger(odin_model_p->dim_clin_inc));
  SET_VECTOR_ELT(state, 179, ScalarInteger(odin_model_p->dim_clin_inc_1));
  SET_VECTOR_ELT(state, 180, ScalarInteger(odin_model_p->dim_clin_inc_2));
  SET_VECTOR_ELT(state, 181, ScalarInteger(odin_model_p->dim_clin_inc_3));
  SET_VECTOR_ELT(state, 182, ScalarInteger(odin_model_p->dim_clin_inc_12));
  SET_VECTOR_ELT(state, 183, allocVector(REALSXP, odin_model_p->dim_clin_inc));
  memcpy(REAL(VECTOR_ELT(state, 183)), odin_model_p->clin_inc, odin_model_p->dim_clin_inc * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 183), 3, odin_model_p->dim_clin_inc_1, odin_model_p->dim_clin_inc_2, odin_model_p->dim_clin_inc_3);
  SET_VECTOR_ELT(state, 184, ScalarInteger(odin_model_p->dim_x_I));
  SET_VECTOR_ELT(state, 185, allocVector(REALSXP, odin_model_p->dim_x_I));
  memcpy(REAL(VECTOR_ELT(state, 185)), odin_model_p->x_I, odin_model_p->dim_x_I * sizeof(double));
  SET_VECTOR_ELT(state, 186, ScalarInteger(odin_model_p->dim_init_ICM));
  SET_VECTOR_ELT(state, 187, ScalarInteger(odin_model_p->dim_init_ICM_1));
  SET_VECTOR_ELT(state, 188, ScalarInteger(odin_model_p->dim_init_ICM_2));
  SET_VECTOR_ELT(state, 189, ScalarInteger(odin_model_p->dim_init_ICM_3));
  SET_VECTOR_ELT(state, 190, ScalarInteger(odin_model_p->dim_init_ICM_12));
  SET_VECTOR_ELT(state, 191, allocVector(REALSXP, odin_model_p->dim_init_ICM));
  memcpy(REAL(VECTOR_ELT(state, 191)), odin_model_p->init_ICM, odin_model_p->dim_init_ICM * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 191), 3, odin_model_p->dim_init_ICM_1, odin_model_p->dim_init_ICM_2, odin_model_p->dim_init_ICM_3);
  SET_VECTOR_ELT(state, 192, ScalarInteger(odin_model_p->dim_ICM));
  SET_VECTOR_ELT(state, 193, ScalarInteger(odin_model_p->dim_ICM_1));
  SET_VECTOR_ELT(state, 194, ScalarInteger(odin_model_p->dim_ICM_2));
  SET_VECTOR_ELT(state, 195, ScalarInteger(odin_model_p->dim_ICM_3));
  SET_VECTOR_ELT(state, 196, ScalarInteger(odin_model_p->dim_ICM_12));
  SET_VECTOR_ELT(state, 197, allocVector(REALSXP, odin_model_p->dim_ICM));
  memcpy(REAL(VECTOR_ELT(state, 197)), odin_model_p->initial_ICM, odin_model_p->dim_ICM * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 197), 3, odin_model_p->dim_ICM_1, odin_model_p->dim_ICM_2, odin_model_p->dim_ICM_3);
  SET_VECTOR_ELT(state, 198, ScalarInteger(odin_model_p->offset_ICM));
  SET_VECTOR_ELT(state, 199, ScalarInteger(odin_model_p->dim_init_ICA));
  SET_VECTOR_ELT(state, 200, ScalarInteger(odin_model_p->dim_init_ICA_1));
  SET_VECTOR_ELT(state, 201, ScalarInteger(odin_model_p->dim_init_ICA_2));
  SET_VECTOR_ELT(state, 202, ScalarInteger(odin_model_p->dim_init_ICA_3));
  SET_VECTOR_ELT(state, 203, ScalarInteger(odin_model_p->dim_init_ICA_12));
  SET_VECTOR_ELT(state, 204, allocVector(REALSXP, odin_model_p->dim_init_ICA));
  memcpy(REAL(VECTOR_ELT(state, 204)), odin_model_p->init_ICA, odin_model_p->dim_init_ICA * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 204), 3, odin_model_p->dim_init_ICA_1, odin_model_p->dim_init_ICA_2, odin_model_p->dim_init_ICA_3);
  SET_VECTOR_ELT(state, 205, ScalarInteger(odin_model_p->dim_ICA));
  SET_VECTOR_ELT(state, 206, ScalarInteger(odin_model_p->dim_ICA_1));
  SET_VECTOR_ELT(state, 207, ScalarInteger(odin_model_p->dim_ICA_2));
  SET_VECTOR_ELT(state, 208, ScalarInteger(odin_model_p->dim_ICA_3));
  SET_VECTOR_ELT(state, 209, ScalarInteger(odin_model_p->dim_ICA_12));
  SET_VECTOR_ELT(state, 210, allocVector(REALSXP, odin_model_p->dim_ICA));
  memcpy(REAL(VECTOR_ELT(state, 210)), odin_model_p->initial_ICA, odin_model_p->dim_ICA * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 210), 3, odin_model_p->dim_ICA_1, odin_model_p->dim_ICA_2, odin_model_p->dim_ICA_3);
  SET_VECTOR_ELT(state, 211, ScalarInteger(odin_model_p->offset_ICA));
  SET_VECTOR_ELT(state, 212, ScalarInteger(odin_model_p->dim_IC));
  SET_VECTOR_ELT(state, 213, ScalarInteger(odin_model_p->dim_IC_1));
  SET_VECTOR_ELT(state, 214, ScalarInteger(odin_model_p->dim_IC_2));
  SET_VECTOR_ELT(state, 215, ScalarInteger(odin_model_p->dim_IC_3));
  SET_VECTOR_ELT(state, 216, ScalarInteger(odin_model_p->dim_IC_12));
  SET_VECTOR_ELT(state, 217, allocVector(REALSXP, odin_model_p->dim_IC));
  memcpy(REAL(VECTOR_ELT(state, 217)), odin_model_p->IC, odin_model_p->dim_IC * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 217), 3, odin_model_p->dim_IC_1, odin_model_p->dim_IC_2, odin_model_p->dim_IC_3);
  SET_VECTOR_ELT(state, 218, ScalarInteger(odin_model_p->dim_phi));
  SET_VECTOR_ELT(state, 219, ScalarInteger(odin_model_p->dim_phi_1));
  SET_VECTOR_ELT(state, 220, ScalarInteger(odin_model_p->dim_phi_2));
  SET_VECTOR_ELT(state, 221, ScalarInteger(odin_model_p->dim_phi_3));
  SET_VECTOR_ELT(state, 222, ScalarInteger(odin_model_p->dim_phi_12));
  SET_VECTOR_ELT(state, 223, allocVector(REALSXP, odin_model_p->dim_phi));
  memcpy(REAL(VECTOR_ELT(state, 223)), odin_model_p->phi, odin_model_p->dim_phi * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 223), 3, odin_model_p->dim_phi_1, odin_model_p->dim_phi_2, odin_model_p->dim_phi_3);
  SET_VECTOR_ELT(state, 224, ScalarInteger(odin_model_p->dim_init_IB));
  SET_VECTOR_ELT(state, 225, ScalarInteger(odin_model_p->dim_init_IB_1));
  SET_VECTOR_ELT(state, 226, ScalarInteger(odin_model_p->dim_init_IB_2));
  SET_VECTOR_ELT(state, 227, ScalarInteger(odin_model_p->dim_init_IB_3));
  SET_VECTOR_ELT(state, 228, ScalarInteger(odin_model_p->dim_init_IB_12));
  SET_VECTOR_ELT(state, 229, allocVector(REALSXP, odin_model_p->dim_init_IB));
  memcpy(REAL(VECTOR_ELT(state, 229)), odin_model_p->init_IB, odin_model_p->dim_init_IB * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 229), 3, odin_model_p->dim_init_IB_1, odin_model_p->dim_init_IB_2, odin_model_p->dim_init_IB_3);
  SET_VECTOR_ELT(state, 230, ScalarInteger(odin_model_p->dim_IB));
  SET_VECTOR_ELT(state, 231, ScalarInteger(odin_model_p->dim_IB_1));
  SET_VECTOR_ELT(state, 232, ScalarInteger(odin_model_p->dim_IB_2));
  SET_VECTOR_ELT(state, 233, ScalarInteger(odin_model_p->dim_IB_3));
  SET_VECTOR_ELT(state, 234, ScalarInteger(odin_model_p->dim_IB_12));
  SET_VECTOR_ELT(state, 235, allocVector(REALSXP, odin_model_p->dim_IB));
  memcpy(REAL(VECTOR_ELT(state, 235)), odin_model_p->initial_IB, odin_model_p->dim_IB * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 235), 3, odin_model_p->dim_IB_1, odin_model_p->dim_IB_2, odin_model_p->dim_IB_3);
  SET_VECTOR_ELT(state, 236, ScalarInteger(odin_model_p->offset_IB));
  SET_VECTOR_ELT(state, 237, ScalarInteger(odin_model_p->dim_b));
  SET_VECTOR_ELT(state, 238, ScalarInteger(odin_model_p->dim_b_1));
  SET_VECTOR_ELT(state, 239, ScalarInteger(odin_model_p->dim_b_2));
  SET_VECTOR_ELT(state, 240, ScalarInteger(odin_model_p->dim_b_3));
  SET_VECTOR_ELT(state, 241, ScalarInteger(odin_model_p->dim_b_12));
  SET_VECTOR_ELT(state, 242, allocVector(REALSXP, odin_model_p->dim_b));
  memcpy(REAL(VECTOR_ELT(state, 242)), odin_model_p->b, odin_model_p->dim_b * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 242), 3, odin_model_p->dim_b_1, odin_model_p->dim_b_2, odin_model_p->dim_b_3);
  SET_VECTOR_ELT(state, 243, allocVector(REALSXP, odin_model_p->dim_b));
  memcpy(REAL(VECTOR_ELT(state, 243)), odin_model_p->delay_b, odin_model_p->dim_b * sizeof(double));
  SET_VECTOR_ELT(state, 244, ScalarInteger(odin_model_p->dim_init_ID));
  SET_VECTOR_ELT(state, 245, ScalarInteger(odin_model_p->dim_init_ID_1));
  SET_VECTOR_ELT(state, 246, ScalarInteger(odin_model_p->dim_init_ID_2));
  SET_VECTOR_ELT(state, 247, ScalarInteger(odin_model_p->dim_init_ID_3));
  SET_VECTOR_ELT(state, 248, ScalarInteger(odin_model_p->dim_init_ID_12));
  SET_VECTOR_ELT(state, 249, allocVector(REALSXP, odin_model_p->dim_init_ID));
  memcpy(REAL(VECTOR_ELT(state, 249)), odin_model_p->init_ID, odin_model_p->dim_init_ID * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 249), 3, odin_model_p->dim_init_ID_1, odin_model_p->dim_init_ID_2, odin_model_p->dim_init_ID_3);
  SET_VECTOR_ELT(state, 250, ScalarInteger(odin_model_p->dim_ID));
  SET_VECTOR_ELT(state, 251, ScalarInteger(odin_model_p->dim_ID_1));
  SET_VECTOR_ELT(state, 252, ScalarInteger(odin_model_p->dim_ID_2));
  SET_VECTOR_ELT(state, 253, ScalarInteger(odin_model_p->dim_ID_3));
  SET_VECTOR_ELT(state, 254, ScalarInteger(odin_model_p->dim_ID_12));
  SET_VECTOR_ELT(state, 255, allocVector(REALSXP, odin_model_p->dim_ID));
  memcpy(REAL(VECTOR_ELT(state, 255)), odin_model_p->initial_ID, odin_model_p->dim_ID * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 255), 3, odin_model_p->dim_ID_1, odin_model_p->dim_ID_2, odin_model_p->dim_ID_3);
  SET_VECTOR_ELT(state, 256, ScalarInteger(odin_model_p->offset_ID));
  SET_VECTOR_ELT(state, 257, ScalarInteger(odin_model_p->dim_age));
  SET_VECTOR_ELT(state, 258, allocVector(REALSXP, odin_model_p->dim_age));
  memcpy(REAL(VECTOR_ELT(state, 258)), odin_model_p->age, odin_model_p->dim_age * sizeof(double));
  SET_VECTOR_ELT(state, 259, ScalarInteger(odin_model_p->dim_fd));
  SET_VECTOR_ELT(state, 260, allocVector(REALSXP, odin_model_p->dim_fd));
  memcpy(REAL(VECTOR_ELT(state, 260)), odin_model_p->fd, odin_model_p->dim_fd * sizeof(double));
  SET_VECTOR_ELT(state, 261, ScalarInteger(odin_model_p->dim_p_det));
  SET_VECTOR_ELT(state, 262, ScalarInteger(odin_model_p->dim_p_det_1));
  SET_VECTOR_ELT(state, 263, ScalarInteger(odin_model_p->dim_p_det_2));
  SET_VECTOR_ELT(state, 264, ScalarInteger(odin_model_p->dim_p_det_3));
  SET_VECTOR_ELT(state, 265, ScalarInteger(odin_model_p->dim_p_det_12));
  SET_VECTOR_ELT(state, 266, allocVector(REALSXP, odin_model_p->dim_p_det));
  memcpy(REAL(VECTOR_ELT(state, 266)), odin_model_p->p_det, odin_model_p->dim_p_det * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 266), 3, odin_model_p->dim_p_det_1, odin_model_p->dim_p_det_2, odin_model_p->dim_p_det_3);
  SET_VECTOR_ELT(state, 267, allocVector(REALSXP, odin_model_p->dim_p_det));
  memcpy(REAL(VECTOR_ELT(state, 267)), odin_model_p->delay_p_det, odin_model_p->dim_p_det * sizeof(double));
  SET_VECTOR_ELT(state, 268, ScalarInteger(odin_model_p->dim_FOI_lag));
  SET_VECTOR_ELT(state, 269, ScalarInteger(odin_model_p->dim_FOI_lag_1));
  SET_VECTOR_ELT(state, 270, ScalarInteger(odin_model_p->dim_FOI_lag_2));
  SET_VECTOR_ELT(state, 271, ScalarInteger(odin_model_p->dim_FOI_lag_3));
  SET_VECTOR_ELT(state, 272, ScalarInteger(odin_model_p->dim_FOI_lag_12));
  SET_VECTOR_ELT(state, 273, allocVector(REALSXP, odin_model_p->dim_FOI_lag));
  memcpy(REAL(VECTOR_ELT(state, 273)), odin_model_p->FOI_lag, odin_model_p->dim_FOI_lag * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 273), 3, odin_model_p->dim_FOI_lag_1, odin_model_p->dim_FOI_lag_2, odin_model_p->dim_FOI_lag_3);
  SET_VECTOR_ELT(state, 274, allocVector(REALSXP, odin_model_p->dim_FOI_lag));
  memcpy(REAL(VECTOR_ELT(state, 274)), odin_model_p->delay_FOI_lag, odin_model_p->dim_FOI_lag * sizeof(double));
  SET_VECTOR_ELT(state, 275, ScalarInteger(odin_model_p->dim_FOI));
  SET_VECTOR_ELT(state, 276, ScalarInteger(odin_model_p->dim_FOI_1));
  SET_VECTOR_ELT(state, 277, ScalarInteger(odin_model_p->dim_FOI_2));
  SET_VECTOR_ELT(state, 278, ScalarInteger(odin_model_p->dim_FOI_3));
  SET_VECTOR_ELT(state, 279, ScalarInteger(odin_model_p->dim_FOI_12));
  SET_VECTOR_ELT(state, 280, allocVector(REALSXP, odin_model_p->dim_FOI));
  memcpy(REAL(VECTOR_ELT(state, 280)), odin_model_p->FOI, odin_model_p->dim_FOI * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 280), 3, odin_model_p->dim_FOI_1, odin_model_p->dim_FOI_2, odin_model_p->dim_FOI_3);
  SET_VECTOR_ELT(state, 281, ScalarInteger(odin_model_p->dim_foi_age));
  SET_VECTOR_ELT(state, 282, allocVector(REALSXP, odin_model_p->dim_foi_age));
  memcpy(REAL(VECTOR_ELT(state, 282)), odin_model_p->foi_age, odin_model_p->dim_foi_age * sizeof(double));
  SET_VECTOR_ELT(state, 283, ScalarInteger(odin_model_p->dim_rel_foi));
  SET_VECTOR_ELT(state, 284, allocVector(REALSXP, odin_model_p->dim_rel_foi));
  memcpy(REAL(VECTOR_ELT(state, 284)), odin_model_p->rel_foi, odin_model_p->dim_rel_foi * sizeof(double));
  SET_VECTOR_ELT(state, 285, ScalarInteger(odin_model_p->dim_EIR));
  SET_VECTOR_ELT(state, 286, ScalarInteger(odin_model_p->dim_EIR_1));
  SET_VECTOR_ELT(state, 287, ScalarInteger(odin_model_p->dim_EIR_2));
  SET_VECTOR_ELT(state, 288, ScalarInteger(odin_model_p->dim_EIR_3));
  SET_VECTOR_ELT(state, 289, ScalarInteger(odin_model_p->dim_EIR_12));
  SET_VECTOR_ELT(state, 290, allocVector(REALSXP, odin_model_p->dim_EIR));
  memcpy(REAL(VECTOR_ELT(state, 290)), odin_model_p->EIR, odin_model_p->dim_EIR * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 290), 3, odin_model_p->dim_EIR_1, odin_model_p->dim_EIR_2, odin_model_p->dim_EIR_3);
  SET_VECTOR_ELT(state, 291, allocVector(REALSXP, odin_model_p->dim_EIR));
  memcpy(REAL(VECTOR_ELT(state, 291)), odin_model_p->delay_EIR, odin_model_p->dim_EIR * sizeof(double));
  SET_VECTOR_ELT(state, 292, ScalarReal(odin_model_p->initial_Sv));
  SET_VECTOR_ELT(state, 293, ScalarReal(odin_model_p->initial_Iv));
  SET_VECTOR_ELT(state, 294, ScalarInteger(odin_model_p->dim_cA));
  SET_VECTOR_ELT(state, 295, ScalarInteger(odin_model_p->dim_cA_1));
  SET_VECTOR_ELT(state, 296, ScalarInteger(odin_model_p->dim_cA_2));
  SET_VECTOR_ELT(state, 297, ScalarInteger(odin_model_p->dim_cA_3));
  SET_VECTOR_ELT(state, 298, ScalarInteger(odin_model_p->dim_cA_12));
  SET_VECTOR_ELT(state, 299, allocVector(REALSXP, odin_model_p->dim_cA));
  memcpy(REAL(VECTOR_ELT(state, 299)), odin_model_p->cA, odin_model_p->dim_cA * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 299), 3, odin_model_p->dim_cA_1, odin_model_p->dim_cA_2, odin_model_p->dim_cA_3);
  SET_VECTOR_ELT(state, 300, allocVector(REALSXP, odin_model_p->dim_cA));
  memcpy(REAL(VECTOR_ELT(state, 300)), odin_model_p->delay_cA, odin_model_p->dim_cA * sizeof(double));
  SET_VECTOR_ELT(state, 301, ScalarInteger(odin_model_p->dim_FOIvijk));
  SET_VECTOR_ELT(state, 302, ScalarInteger(odin_model_p->dim_FOIvijk_1));
  SET_VECTOR_ELT(state, 303, ScalarInteger(odin_model_p->dim_FOIvijk_2));
  SET_VECTOR_ELT(state, 304, ScalarInteger(odin_model_p->dim_FOIvijk_3));
  SET_VECTOR_ELT(state, 305, ScalarInteger(odin_model_p->dim_FOIvijk_12));
  SET_VECTOR_ELT(state, 306, allocVector(REALSXP, odin_model_p->dim_FOIvijk));
  memcpy(REAL(VECTOR_ELT(state, 306)), odin_model_p->FOIvijk, odin_model_p->dim_FOIvijk * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 306), 3, odin_model_p->dim_FOIvijk_1, odin_model_p->dim_FOIvijk_2, odin_model_p->dim_FOIvijk_3);
  SET_VECTOR_ELT(state, 307, allocVector(REALSXP, odin_model_p->dim_FOIvijk));
  memcpy(REAL(VECTOR_ELT(state, 307)), odin_model_p->delay_FOIvijk, odin_model_p->dim_FOIvijk * sizeof(double));
  SET_VECTOR_ELT(state, 308, ScalarReal(odin_model_p->b_lambda));
  SET_VECTOR_ELT(state, 309, ScalarReal(odin_model_p->initial_PL));
  SET_VECTOR_ELT(state, 310, ScalarReal(odin_model_p->initial_LL));
  SET_VECTOR_ELT(state, 311, ScalarReal(odin_model_p->initial_EL));
  SET_VECTOR_ELT(state, 312, ScalarInteger(odin_model_p->dim_cov));
  SET_VECTOR_ELT(state, 313, allocVector(REALSXP, odin_model_p->dim_cov));
  memcpy(REAL(VECTOR_ELT(state, 313)), odin_model_p->cov, odin_model_p->dim_cov * sizeof(double));
  SET_VECTOR_ELT(state, 314, ScalarInteger(odin_model_p->offset_output_cov));
  SET_VECTOR_ELT(state, 315, ScalarInteger(odin_model_p->dim_w));
  SET_VECTOR_ELT(state, 316, allocVector(REALSXP, odin_model_p->dim_w));
  memcpy(REAL(VECTOR_ELT(state, 316)), odin_model_p->w, odin_model_p->dim_w * sizeof(double));
  SET_VECTOR_ELT(state, 317, allocVector(REALSXP, odin_model_p->dim_w));
  memcpy(REAL(VECTOR_ELT(state, 317)), odin_model_p->delay_w, odin_model_p->dim_w * sizeof(double));
  SET_VECTOR_ELT(state, 318, ScalarInteger(odin_model_p->dim_yy));
  SET_VECTOR_ELT(state, 319, allocVector(REALSXP, odin_model_p->dim_yy));
  memcpy(REAL(VECTOR_ELT(state, 319)), odin_model_p->yy, odin_model_p->dim_yy * sizeof(double));
  SET_VECTOR_ELT(state, 320, allocVector(REALSXP, odin_model_p->dim_yy));
  memcpy(REAL(VECTOR_ELT(state, 320)), odin_model_p->delay_yy, odin_model_p->dim_yy * sizeof(double));
  SET_VECTOR_ELT(state, 321, ScalarInteger(odin_model_p->dim_z));
  SET_VECTOR_ELT(state, 322, allocVector(REALSXP, odin_model_p->dim_z));
  memcpy(REAL(VECTOR_ELT(state, 322)), odin_model_p->z, odin_model_p->dim_z * sizeof(double));
  SET_VECTOR_ELT(state, 323, allocVector(REALSXP, odin_model_p->dim_z));
  memcpy(REAL(VECTOR_ELT(state, 323)), odin_model_p->delay_z, odin_model_p->dim_z * sizeof(double));
  SET_VECTOR_ELT(state, 324, ScalarInteger(odin_model_p->dim_zhi));
  SET_VECTOR_ELT(state, 325, allocVector(REALSXP, odin_model_p->dim_zhi));
  memcpy(REAL(VECTOR_ELT(state, 325)), odin_model_p->zhi, odin_model_p->dim_zhi * sizeof(double));
  SET_VECTOR_ELT(state, 326, allocVector(REALSXP, odin_model_p->dim_zhi));
  memcpy(REAL(VECTOR_ELT(state, 326)), odin_model_p->delay_zhi, odin_model_p->dim_zhi * sizeof(double));
  SET_VECTOR_ELT(state, 327, ScalarInteger(odin_model_p->dim_whi));
  SET_VECTOR_ELT(state, 328, allocVector(REALSXP, odin_model_p->dim_whi));
  memcpy(REAL(VECTOR_ELT(state, 328)), odin_model_p->whi, odin_model_p->dim_whi * sizeof(double));
  SET_VECTOR_ELT(state, 329, allocVector(REALSXP, odin_model_p->dim_whi));
  memcpy(REAL(VECTOR_ELT(state, 329)), odin_model_p->delay_whi, odin_model_p->dim_whi * sizeof(double));
  SET_VECTOR_ELT(state, 330, ScalarInteger(odin_model_p->dim_av_mosq));
  SET_VECTOR_ELT(state, 331, allocVector(REALSXP, odin_model_p->dim_av_mosq));
  memcpy(REAL(VECTOR_ELT(state, 331)), odin_model_p->av_mosq, odin_model_p->dim_av_mosq * sizeof(double));
  SET_VECTOR_ELT(state, 332, allocVector(REALSXP, odin_model_p->dim_av_mosq));
  memcpy(REAL(VECTOR_ELT(state, 332)), odin_model_p->delay_av_mosq, odin_model_p->dim_av_mosq * sizeof(double));
  SET_VECTOR_ELT(state, 333, ScalarInteger(odin_model_p->dim_av_human));
  SET_VECTOR_ELT(state, 334, allocVector(REALSXP, odin_model_p->dim_av_human));
  memcpy(REAL(VECTOR_ELT(state, 334)), odin_model_p->av_human, odin_model_p->dim_av_human * sizeof(double));
  SET_VECTOR_ELT(state, 335, allocVector(REALSXP, odin_model_p->dim_av_human));
  memcpy(REAL(VECTOR_ELT(state, 335)), odin_model_p->delay_av_human, odin_model_p->dim_av_human * sizeof(double));
  SET_VECTOR_ELT(state, 336, ScalarInteger(odin_model_p->dim_den));
  SET_VECTOR_ELT(state, 337, allocVector(REALSXP, odin_model_p->dim_den));
  memcpy(REAL(VECTOR_ELT(state, 337)), odin_model_p->den, odin_model_p->dim_den * sizeof(double));
  SET_VECTOR_ELT(state, 338, ScalarInteger(odin_model_p->dim_prev0to59));
  SET_VECTOR_ELT(state, 339, ScalarInteger(odin_model_p->dim_prev0to59_1));
  SET_VECTOR_ELT(state, 340, ScalarInteger(odin_model_p->dim_prev0to59_2));
  SET_VECTOR_ELT(state, 341, ScalarInteger(odin_model_p->dim_prev0to59_3));
  SET_VECTOR_ELT(state, 342, ScalarInteger(odin_model_p->dim_prev0to59_12));
  SET_VECTOR_ELT(state, 343, allocVector(REALSXP, odin_model_p->dim_prev0to59));
  memcpy(REAL(VECTOR_ELT(state, 343)), odin_model_p->prev0to59, odin_model_p->dim_prev0to59 * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 343), 3, odin_model_p->dim_prev0to59_1, odin_model_p->dim_prev0to59_2, odin_model_p->dim_prev0to59_3);
  SET_VECTOR_ELT(state, 344, ScalarInteger(odin_model_p->dim_clin_inc0to5));
  SET_VECTOR_ELT(state, 345, ScalarInteger(odin_model_p->dim_clin_inc0to5_1));
  SET_VECTOR_ELT(state, 346, ScalarInteger(odin_model_p->dim_clin_inc0to5_2));
  SET_VECTOR_ELT(state, 347, ScalarInteger(odin_model_p->dim_clin_inc0to5_3));
  SET_VECTOR_ELT(state, 348, ScalarInteger(odin_model_p->dim_clin_inc0to5_12));
  SET_VECTOR_ELT(state, 349, allocVector(REALSXP, odin_model_p->dim_clin_inc0to5));
  memcpy(REAL(VECTOR_ELT(state, 349)), odin_model_p->clin_inc0to5, odin_model_p->dim_clin_inc0to5 * sizeof(double));
  odin_set_dim(VECTOR_ELT(state, 349), 3, odin_model_p->dim_clin_inc0to5_1, odin_model_p->dim_clin_inc0to5_2, odin_model_p->dim_clin_inc0to5_3);
  SET_VECTOR_ELT(state, 350, ScalarInteger(odin_model_p->dim_delay_FOI));
  SET_VECTOR_ELT(state, 351, allocVector(INTSXP, odin_model_p->dim_delay_FOI));
  memcpy(INTEGER(VECTOR_ELT(state, 351)), odin_model_p->delay_i_FOI, odin_model_p->dim_delay_FOI * sizeof(int));
  SET_VECTOR_ELT(state, 352, allocVector(REALSXP, odin_model_p->dim_delay_FOI));
  memcpy(REAL(VECTOR_ELT(state, 352)), odin_model_p->delay_state_FOI, odin_model_p->dim_delay_FOI * sizeof(double));
  SET_VECTOR_ELT(state, 353, ScalarInteger(odin_model_p->dim_delay_FOIv));
  SET_VECTOR_ELT(state, 354, allocVector(INTSXP, odin_model_p->dim_delay_FOIv));
  memcpy(INTEGER(VECTOR_ELT(state, 354)), odin_model_p->delay_i_FOIv, odin_model_p->dim_delay_FOIv * sizeof(int));
  SET_VECTOR_ELT(state, 355, allocVector(REALSXP, odin_model_p->dim_delay_FOIv));
  memcpy(REAL(VECTOR_ELT(state, 355)), odin_model_p->delay_state_FOIv, odin_model_p->dim_delay_FOIv * sizeof(double));
  SET_VECTOR_ELT(state, 356, ScalarInteger(odin_model_p->dim_delay_incv));
  SET_VECTOR_ELT(state, 357, allocVector(INTSXP, odin_model_p->dim_delay_incv));
  memcpy(INTEGER(VECTOR_ELT(state, 357)), odin_model_p->delay_i_incv, odin_model_p->dim_delay_incv * sizeof(int));
  SET_VECTOR_ELT(state, 358, allocVector(REALSXP, odin_model_p->dim_delay_incv));
  memcpy(REAL(VECTOR_ELT(state, 358)), odin_model_p->delay_state_incv, odin_model_p->dim_delay_incv * sizeof(double));
  SET_VECTOR_ELT(state, 359, ScalarInteger(odin_model_p->dim));
  SET_VECTOR_ELT(state, 360, ScalarInteger(odin_model_p->dim_output));
  SEXP state_names = PROTECT(allocVector(STRSXP, 361));
  SET_STRING_ELT(state_names, 0, mkChar("odin_use_dde"));
  SET_STRING_ELT(state_names, 1, mkChar("initial_t"));
  SET_STRING_ELT(state_names, 2, mkChar("dim_Ev"));
  SET_STRING_ELT(state_names, 3, mkChar("initial_Ev"));
  SET_STRING_ELT(state_names, 4, mkChar("offset_Ev"));
  SET_STRING_ELT(state_names, 5, mkChar("na"));
  SET_STRING_ELT(state_names, 6, mkChar("nh"));
  SET_STRING_ELT(state_names, 7, mkChar("ft"));
  SET_STRING_ELT(state_names, 8, mkChar("eta"));
  SET_STRING_ELT(state_names, 9, mkChar("rA"));
  SET_STRING_ELT(state_names, 10, mkChar("rT"));
  SET_STRING_ELT(state_names, 11, mkChar("rD"));
  SET_STRING_ELT(state_names, 12, mkChar("rU"));
  SET_STRING_ELT(state_names, 13, mkChar("rP"));
  SET_STRING_ELT(state_names, 14, mkChar("dCM"));
  SET_STRING_ELT(state_names, 15, mkChar("uCA"));
  SET_STRING_ELT(state_names, 16, mkChar("dCA"));
  SET_STRING_ELT(state_names, 17, mkChar("dB"));
  SET_STRING_ELT(state_names, 18, mkChar("uB"));
  SET_STRING_ELT(state_names, 19, mkChar("dID"));
  SET_STRING_ELT(state_names, 20, mkChar("uD"));
  SET_STRING_ELT(state_names, 21, mkChar("phi0"));
  SET_STRING_ELT(state_names, 22, mkChar("phi1"));
  SET_STRING_ELT(state_names, 23, mkChar("IC0"));
  SET_STRING_ELT(state_names, 24, mkChar("kC"));
  SET_STRING_ELT(state_names, 25, mkChar("b0"));
  SET_STRING_ELT(state_names, 26, mkChar("b1"));
  SET_STRING_ELT(state_names, 27, mkChar("kB"));
  SET_STRING_ELT(state_names, 28, mkChar("IB0"));
  SET_STRING_ELT(state_names, 29, mkChar("aD"));
  SET_STRING_ELT(state_names, 30, mkChar("fD0"));
  SET_STRING_ELT(state_names, 31, mkChar("gammaD"));
  SET_STRING_ELT(state_names, 32, mkChar("d1"));
  SET_STRING_ELT(state_names, 33, mkChar("ID0"));
  SET_STRING_ELT(state_names, 34, mkChar("kD"));
  SET_STRING_ELT(state_names, 35, mkChar("dE"));
  SET_STRING_ELT(state_names, 36, mkChar("pi"));
  SET_STRING_ELT(state_names, 37, mkChar("ssa0"));
  SET_STRING_ELT(state_names, 38, mkChar("ssa1"));
  SET_STRING_ELT(state_names, 39, mkChar("ssa2"));
  SET_STRING_ELT(state_names, 40, mkChar("ssa3"));
  SET_STRING_ELT(state_names, 41, mkChar("ssb1"));
  SET_STRING_ELT(state_names, 42, mkChar("ssb2"));
  SET_STRING_ELT(state_names, 43, mkChar("ssb3"));
  SET_STRING_ELT(state_names, 44, mkChar("theta_c"));
  SET_STRING_ELT(state_names, 45, mkChar("init_Sv"));
  SET_STRING_ELT(state_names, 46, mkChar("init_Ev"));
  SET_STRING_ELT(state_names, 47, mkChar("init_Iv"));
  SET_STRING_ELT(state_names, 48, mkChar("cU"));
  SET_STRING_ELT(state_names, 49, mkChar("cD"));
  SET_STRING_ELT(state_names, 50, mkChar("cT"));
  SET_STRING_ELT(state_names, 51, mkChar("gamma1"));
  SET_STRING_ELT(state_names, 52, mkChar("omega"));
  SET_STRING_ELT(state_names, 53, mkChar("delayGam"));
  SET_STRING_ELT(state_names, 54, mkChar("delayMos"));
  SET_STRING_ELT(state_names, 55, mkChar("dLL"));
  SET_STRING_ELT(state_names, 56, mkChar("dPL"));
  SET_STRING_ELT(state_names, 57, mkChar("dEL"));
  SET_STRING_ELT(state_names, 58, mkChar("muLL"));
  SET_STRING_ELT(state_names, 59, mkChar("muPL"));
  SET_STRING_ELT(state_names, 60, mkChar("muEL"));
  SET_STRING_ELT(state_names, 61, mkChar("gammaL"));
  SET_STRING_ELT(state_names, 62, mkChar("mv0"));
  SET_STRING_ELT(state_names, 63, mkChar("tau1"));
  SET_STRING_ELT(state_names, 64, mkChar("tau2"));
  SET_STRING_ELT(state_names, 65, mkChar("p10"));
  SET_STRING_ELT(state_names, 66, mkChar("p2"));
  SET_STRING_ELT(state_names, 67, mkChar("beta_larval0"));
  SET_STRING_ELT(state_names, 68, mkChar("init_PL"));
  SET_STRING_ELT(state_names, 69, mkChar("init_LL"));
  SET_STRING_ELT(state_names, 70, mkChar("init_EL"));
  SET_STRING_ELT(state_names, 71, mkChar("ITN_IRS_on"));
  SET_STRING_ELT(state_names, 72, mkChar("num_int"));
  SET_STRING_ELT(state_names, 73, mkChar("itn_cov"));
  SET_STRING_ELT(state_names, 74, mkChar("irs_cov"));
  SET_STRING_ELT(state_names, 75, mkChar("IRS_interval"));
  SET_STRING_ELT(state_names, 76, mkChar("ITN_interval"));
  SET_STRING_ELT(state_names, 77, mkChar("chi"));
  SET_STRING_ELT(state_names, 78, mkChar("Q0"));
  SET_STRING_ELT(state_names, 79, mkChar("bites_Bed"));
  SET_STRING_ELT(state_names, 80, mkChar("bites_Indoors"));
  SET_STRING_ELT(state_names, 81, mkChar("r_ITN0"));
  SET_STRING_ELT(state_names, 82, mkChar("d_ITN0"));
  SET_STRING_ELT(state_names, 83, mkChar("d_IRS0"));
  SET_STRING_ELT(state_names, 84, mkChar("r_IRS0"));
  SET_STRING_ELT(state_names, 85, mkChar("r_ITN1"));
  SET_STRING_ELT(state_names, 86, mkChar("irs_loss"));
  SET_STRING_ELT(state_names, 87, mkChar("itn_loss"));
  SET_STRING_ELT(state_names, 88, mkChar("age59"));
  SET_STRING_ELT(state_names, 89, mkChar("age05"));
  SET_STRING_ELT(state_names, 90, mkChar("dim_age_rate"));
  SET_STRING_ELT(state_names, 91, mkChar("age_rate"));
  SET_STRING_ELT(state_names, 92, mkChar("dim_het_wt"));
  SET_STRING_ELT(state_names, 93, mkChar("het_wt"));
  SET_STRING_ELT(state_names, 94, mkChar("dim_init_S"));
  SET_STRING_ELT(state_names, 95, mkChar("dim_init_S_1"));
  SET_STRING_ELT(state_names, 96, mkChar("dim_init_S_2"));
  SET_STRING_ELT(state_names, 97, mkChar("dim_init_S_3"));
  SET_STRING_ELT(state_names, 98, mkChar("dim_init_S_12"));
  SET_STRING_ELT(state_names, 99, mkChar("init_S"));
  SET_STRING_ELT(state_names, 100, mkChar("dim_S"));
  SET_STRING_ELT(state_names, 101, mkChar("dim_S_1"));
  SET_STRING_ELT(state_names, 102, mkChar("dim_S_2"));
  SET_STRING_ELT(state_names, 103, mkChar("dim_S_3"));
  SET_STRING_ELT(state_names, 104, mkChar("dim_S_12"));
  SET_STRING_ELT(state_names, 105, mkChar("initial_S"));
  SET_STRING_ELT(state_names, 106, mkChar("offset_S"));
  SET_STRING_ELT(state_names, 107, mkChar("dim_init_T"));
  SET_STRING_ELT(state_names, 108, mkChar("dim_init_T_1"));
  SET_STRING_ELT(state_names, 109, mkChar("dim_init_T_2"));
  SET_STRING_ELT(state_names, 110, mkChar("dim_init_T_3"));
  SET_STRING_ELT(state_names, 111, mkChar("dim_init_T_12"));
  SET_STRING_ELT(state_names, 112, mkChar("init_T"));
  SET_STRING_ELT(state_names, 113, mkChar("dim_T"));
  SET_STRING_ELT(state_names, 114, mkChar("dim_T_1"));
  SET_STRING_ELT(state_names, 115, mkChar("dim_T_2"));
  SET_STRING_ELT(state_names, 116, mkChar("dim_T_3"));
  SET_STRING_ELT(state_names, 117, mkChar("dim_T_12"));
  SET_STRING_ELT(state_names, 118, mkChar("initial_T"));
  SET_STRING_ELT(state_names, 119, mkChar("offset_T"));
  SET_STRING_ELT(state_names, 120, mkChar("dim_init_D"));
  SET_STRING_ELT(state_names, 121, mkChar("dim_init_D_1"));
  SET_STRING_ELT(state_names, 122, mkChar("dim_init_D_2"));
  SET_STRING_ELT(state_names, 123, mkChar("dim_init_D_3"));
  SET_STRING_ELT(state_names, 124, mkChar("dim_init_D_12"));
  SET_STRING_ELT(state_names, 125, mkChar("init_D"));
  SET_STRING_ELT(state_names, 126, mkChar("dim_D"));
  SET_STRING_ELT(state_names, 127, mkChar("dim_D_1"));
  SET_STRING_ELT(state_names, 128, mkChar("dim_D_2"));
  SET_STRING_ELT(state_names, 129, mkChar("dim_D_3"));
  SET_STRING_ELT(state_names, 130, mkChar("dim_D_12"));
  SET_STRING_ELT(state_names, 131, mkChar("initial_D"));
  SET_STRING_ELT(state_names, 132, mkChar("offset_D"));
  SET_STRING_ELT(state_names, 133, mkChar("dim_init_A"));
  SET_STRING_ELT(state_names, 134, mkChar("dim_init_A_1"));
  SET_STRING_ELT(state_names, 135, mkChar("dim_init_A_2"));
  SET_STRING_ELT(state_names, 136, mkChar("dim_init_A_3"));
  SET_STRING_ELT(state_names, 137, mkChar("dim_init_A_12"));
  SET_STRING_ELT(state_names, 138, mkChar("init_A"));
  SET_STRING_ELT(state_names, 139, mkChar("dim_A"));
  SET_STRING_ELT(state_names, 140, mkChar("dim_A_1"));
  SET_STRING_ELT(state_names, 141, mkChar("dim_A_2"));
  SET_STRING_ELT(state_names, 142, mkChar("dim_A_3"));
  SET_STRING_ELT(state_names, 143, mkChar("dim_A_12"));
  SET_STRING_ELT(state_names, 144, mkChar("initial_A"));
  SET_STRING_ELT(state_names, 145, mkChar("offset_A"));
  SET_STRING_ELT(state_names, 146, mkChar("dim_init_U"));
  SET_STRING_ELT(state_names, 147, mkChar("dim_init_U_1"));
  SET_STRING_ELT(state_names, 148, mkChar("dim_init_U_2"));
  SET_STRING_ELT(state_names, 149, mkChar("dim_init_U_3"));
  SET_STRING_ELT(state_names, 150, mkChar("dim_init_U_12"));
  SET_STRING_ELT(state_names, 151, mkChar("init_U"));
  SET_STRING_ELT(state_names, 152, mkChar("dim_U"));
  SET_STRING_ELT(state_names, 153, mkChar("dim_U_1"));
  SET_STRING_ELT(state_names, 154, mkChar("dim_U_2"));
  SET_STRING_ELT(state_names, 155, mkChar("dim_U_3"));
  SET_STRING_ELT(state_names, 156, mkChar("dim_U_12"));
  SET_STRING_ELT(state_names, 157, mkChar("initial_U"));
  SET_STRING_ELT(state_names, 158, mkChar("offset_U"));
  SET_STRING_ELT(state_names, 159, mkChar("dim_init_P"));
  SET_STRING_ELT(state_names, 160, mkChar("dim_init_P_1"));
  SET_STRING_ELT(state_names, 161, mkChar("dim_init_P_2"));
  SET_STRING_ELT(state_names, 162, mkChar("dim_init_P_3"));
  SET_STRING_ELT(state_names, 163, mkChar("dim_init_P_12"));
  SET_STRING_ELT(state_names, 164, mkChar("init_P"));
  SET_STRING_ELT(state_names, 165, mkChar("dim_P"));
  SET_STRING_ELT(state_names, 166, mkChar("dim_P_1"));
  SET_STRING_ELT(state_names, 167, mkChar("dim_P_2"));
  SET_STRING_ELT(state_names, 168, mkChar("dim_P_3"));
  SET_STRING_ELT(state_names, 169, mkChar("dim_P_12"));
  SET_STRING_ELT(state_names, 170, mkChar("initial_P"));
  SET_STRING_ELT(state_names, 171, mkChar("offset_P"));
  SET_STRING_ELT(state_names, 172, mkChar("dim_Y"));
  SET_STRING_ELT(state_names, 173, mkChar("dim_Y_1"));
  SET_STRING_ELT(state_names, 174, mkChar("dim_Y_2"));
  SET_STRING_ELT(state_names, 175, mkChar("dim_Y_3"));
  SET_STRING_ELT(state_names, 176, mkChar("dim_Y_12"));
  SET_STRING_ELT(state_names, 177, mkChar("Y"));
  SET_STRING_ELT(state_names, 178, mkChar("dim_clin_inc"));
  SET_STRING_ELT(state_names, 179, mkChar("dim_clin_inc_1"));
  SET_STRING_ELT(state_names, 180, mkChar("dim_clin_inc_2"));
  SET_STRING_ELT(state_names, 181, mkChar("dim_clin_inc_3"));
  SET_STRING_ELT(state_names, 182, mkChar("dim_clin_inc_12"));
  SET_STRING_ELT(state_names, 183, mkChar("clin_inc"));
  SET_STRING_ELT(state_names, 184, mkChar("dim_x_I"));
  SET_STRING_ELT(state_names, 185, mkChar("x_I"));
  SET_STRING_ELT(state_names, 186, mkChar("dim_init_ICM"));
  SET_STRING_ELT(state_names, 187, mkChar("dim_init_ICM_1"));
  SET_STRING_ELT(state_names, 188, mkChar("dim_init_ICM_2"));
  SET_STRING_ELT(state_names, 189, mkChar("dim_init_ICM_3"));
  SET_STRING_ELT(state_names, 190, mkChar("dim_init_ICM_12"));
  SET_STRING_ELT(state_names, 191, mkChar("init_ICM"));
  SET_STRING_ELT(state_names, 192, mkChar("dim_ICM"));
  SET_STRING_ELT(state_names, 193, mkChar("dim_ICM_1"));
  SET_STRING_ELT(state_names, 194, mkChar("dim_ICM_2"));
  SET_STRING_ELT(state_names, 195, mkChar("dim_ICM_3"));
  SET_STRING_ELT(state_names, 196, mkChar("dim_ICM_12"));
  SET_STRING_ELT(state_names, 197, mkChar("initial_ICM"));
  SET_STRING_ELT(state_names, 198, mkChar("offset_ICM"));
  SET_STRING_ELT(state_names, 199, mkChar("dim_init_ICA"));
  SET_STRING_ELT(state_names, 200, mkChar("dim_init_ICA_1"));
  SET_STRING_ELT(state_names, 201, mkChar("dim_init_ICA_2"));
  SET_STRING_ELT(state_names, 202, mkChar("dim_init_ICA_3"));
  SET_STRING_ELT(state_names, 203, mkChar("dim_init_ICA_12"));
  SET_STRING_ELT(state_names, 204, mkChar("init_ICA"));
  SET_STRING_ELT(state_names, 205, mkChar("dim_ICA"));
  SET_STRING_ELT(state_names, 206, mkChar("dim_ICA_1"));
  SET_STRING_ELT(state_names, 207, mkChar("dim_ICA_2"));
  SET_STRING_ELT(state_names, 208, mkChar("dim_ICA_3"));
  SET_STRING_ELT(state_names, 209, mkChar("dim_ICA_12"));
  SET_STRING_ELT(state_names, 210, mkChar("initial_ICA"));
  SET_STRING_ELT(state_names, 211, mkChar("offset_ICA"));
  SET_STRING_ELT(state_names, 212, mkChar("dim_IC"));
  SET_STRING_ELT(state_names, 213, mkChar("dim_IC_1"));
  SET_STRING_ELT(state_names, 214, mkChar("dim_IC_2"));
  SET_STRING_ELT(state_names, 215, mkChar("dim_IC_3"));
  SET_STRING_ELT(state_names, 216, mkChar("dim_IC_12"));
  SET_STRING_ELT(state_names, 217, mkChar("IC"));
  SET_STRING_ELT(state_names, 218, mkChar("dim_phi"));
  SET_STRING_ELT(state_names, 219, mkChar("dim_phi_1"));
  SET_STRING_ELT(state_names, 220, mkChar("dim_phi_2"));
  SET_STRING_ELT(state_names, 221, mkChar("dim_phi_3"));
  SET_STRING_ELT(state_names, 222, mkChar("dim_phi_12"));
  SET_STRING_ELT(state_names, 223, mkChar("phi"));
  SET_STRING_ELT(state_names, 224, mkChar("dim_init_IB"));
  SET_STRING_ELT(state_names, 225, mkChar("dim_init_IB_1"));
  SET_STRING_ELT(state_names, 226, mkChar("dim_init_IB_2"));
  SET_STRING_ELT(state_names, 227, mkChar("dim_init_IB_3"));
  SET_STRING_ELT(state_names, 228, mkChar("dim_init_IB_12"));
  SET_STRING_ELT(state_names, 229, mkChar("init_IB"));
  SET_STRING_ELT(state_names, 230, mkChar("dim_IB"));
  SET_STRING_ELT(state_names, 231, mkChar("dim_IB_1"));
  SET_STRING_ELT(state_names, 232, mkChar("dim_IB_2"));
  SET_STRING_ELT(state_names, 233, mkChar("dim_IB_3"));
  SET_STRING_ELT(state_names, 234, mkChar("dim_IB_12"));
  SET_STRING_ELT(state_names, 235, mkChar("initial_IB"));
  SET_STRING_ELT(state_names, 236, mkChar("offset_IB"));
  SET_STRING_ELT(state_names, 237, mkChar("dim_b"));
  SET_STRING_ELT(state_names, 238, mkChar("dim_b_1"));
  SET_STRING_ELT(state_names, 239, mkChar("dim_b_2"));
  SET_STRING_ELT(state_names, 240, mkChar("dim_b_3"));
  SET_STRING_ELT(state_names, 241, mkChar("dim_b_12"));
  SET_STRING_ELT(state_names, 242, mkChar("b"));
  SET_STRING_ELT(state_names, 243, mkChar("delay_b"));
  SET_STRING_ELT(state_names, 244, mkChar("dim_init_ID"));
  SET_STRING_ELT(state_names, 245, mkChar("dim_init_ID_1"));
  SET_STRING_ELT(state_names, 246, mkChar("dim_init_ID_2"));
  SET_STRING_ELT(state_names, 247, mkChar("dim_init_ID_3"));
  SET_STRING_ELT(state_names, 248, mkChar("dim_init_ID_12"));
  SET_STRING_ELT(state_names, 249, mkChar("init_ID"));
  SET_STRING_ELT(state_names, 250, mkChar("dim_ID"));
  SET_STRING_ELT(state_names, 251, mkChar("dim_ID_1"));
  SET_STRING_ELT(state_names, 252, mkChar("dim_ID_2"));
  SET_STRING_ELT(state_names, 253, mkChar("dim_ID_3"));
  SET_STRING_ELT(state_names, 254, mkChar("dim_ID_12"));
  SET_STRING_ELT(state_names, 255, mkChar("initial_ID"));
  SET_STRING_ELT(state_names, 256, mkChar("offset_ID"));
  SET_STRING_ELT(state_names, 257, mkChar("dim_age"));
  SET_STRING_ELT(state_names, 258, mkChar("age"));
  SET_STRING_ELT(state_names, 259, mkChar("dim_fd"));
  SET_STRING_ELT(state_names, 260, mkChar("fd"));
  SET_STRING_ELT(state_names, 261, mkChar("dim_p_det"));
  SET_STRING_ELT(state_names, 262, mkChar("dim_p_det_1"));
  SET_STRING_ELT(state_names, 263, mkChar("dim_p_det_2"));
  SET_STRING_ELT(state_names, 264, mkChar("dim_p_det_3"));
  SET_STRING_ELT(state_names, 265, mkChar("dim_p_det_12"));
  SET_STRING_ELT(state_names, 266, mkChar("p_det"));
  SET_STRING_ELT(state_names, 267, mkChar("delay_p_det"));
  SET_STRING_ELT(state_names, 268, mkChar("dim_FOI_lag"));
  SET_STRING_ELT(state_names, 269, mkChar("dim_FOI_lag_1"));
  SET_STRING_ELT(state_names, 270, mkChar("dim_FOI_lag_2"));
  SET_STRING_ELT(state_names, 271, mkChar("dim_FOI_lag_3"));
  SET_STRING_ELT(state_names, 272, mkChar("dim_FOI_lag_12"));
  SET_STRING_ELT(state_names, 273, mkChar("FOI_lag"));
  SET_STRING_ELT(state_names, 274, mkChar("delay_FOI_lag"));
  SET_STRING_ELT(state_names, 275, mkChar("dim_FOI"));
  SET_STRING_ELT(state_names, 276, mkChar("dim_FOI_1"));
  SET_STRING_ELT(state_names, 277, mkChar("dim_FOI_2"));
  SET_STRING_ELT(state_names, 278, mkChar("dim_FOI_3"));
  SET_STRING_ELT(state_names, 279, mkChar("dim_FOI_12"));
  SET_STRING_ELT(state_names, 280, mkChar("FOI"));
  SET_STRING_ELT(state_names, 281, mkChar("dim_foi_age"));
  SET_STRING_ELT(state_names, 282, mkChar("foi_age"));
  SET_STRING_ELT(state_names, 283, mkChar("dim_rel_foi"));
  SET_STRING_ELT(state_names, 284, mkChar("rel_foi"));
  SET_STRING_ELT(state_names, 285, mkChar("dim_EIR"));
  SET_STRING_ELT(state_names, 286, mkChar("dim_EIR_1"));
  SET_STRING_ELT(state_names, 287, mkChar("dim_EIR_2"));
  SET_STRING_ELT(state_names, 288, mkChar("dim_EIR_3"));
  SET_STRING_ELT(state_names, 289, mkChar("dim_EIR_12"));
  SET_STRING_ELT(state_names, 290, mkChar("EIR"));
  SET_STRING_ELT(state_names, 291, mkChar("delay_EIR"));
  SET_STRING_ELT(state_names, 292, mkChar("initial_Sv"));
  SET_STRING_ELT(state_names, 293, mkChar("initial_Iv"));
  SET_STRING_ELT(state_names, 294, mkChar("dim_cA"));
  SET_STRING_ELT(state_names, 295, mkChar("dim_cA_1"));
  SET_STRING_ELT(state_names, 296, mkChar("dim_cA_2"));
  SET_STRING_ELT(state_names, 297, mkChar("dim_cA_3"));
  SET_STRING_ELT(state_names, 298, mkChar("dim_cA_12"));
  SET_STRING_ELT(state_names, 299, mkChar("cA"));
  SET_STRING_ELT(state_names, 300, mkChar("delay_cA"));
  SET_STRING_ELT(state_names, 301, mkChar("dim_FOIvijk"));
  SET_STRING_ELT(state_names, 302, mkChar("dim_FOIvijk_1"));
  SET_STRING_ELT(state_names, 303, mkChar("dim_FOIvijk_2"));
  SET_STRING_ELT(state_names, 304, mkChar("dim_FOIvijk_3"));
  SET_STRING_ELT(state_names, 305, mkChar("dim_FOIvijk_12"));
  SET_STRING_ELT(state_names, 306, mkChar("FOIvijk"));
  SET_STRING_ELT(state_names, 307, mkChar("delay_FOIvijk"));
  SET_STRING_ELT(state_names, 308, mkChar("b_lambda"));
  SET_STRING_ELT(state_names, 309, mkChar("initial_PL"));
  SET_STRING_ELT(state_names, 310, mkChar("initial_LL"));
  SET_STRING_ELT(state_names, 311, mkChar("initial_EL"));
  SET_STRING_ELT(state_names, 312, mkChar("dim_cov"));
  SET_STRING_ELT(state_names, 313, mkChar("cov"));
  SET_STRING_ELT(state_names, 314, mkChar("offset_output_cov"));
  SET_STRING_ELT(state_names, 315, mkChar("dim_w"));
  SET_STRING_ELT(state_names, 316, mkChar("w"));
  SET_STRING_ELT(state_names, 317, mkChar("delay_w"));
  SET_STRING_ELT(state_names, 318, mkChar("dim_yy"));
  SET_STRING_ELT(state_names, 319, mkChar("yy"));
  SET_STRING_ELT(state_names, 320, mkChar("delay_yy"));
  SET_STRING_ELT(state_names, 321, mkChar("dim_z"));
  SET_STRING_ELT(state_names, 322, mkChar("z"));
  SET_STRING_ELT(state_names, 323, mkChar("delay_z"));
  SET_STRING_ELT(state_names, 324, mkChar("dim_zhi"));
  SET_STRING_ELT(state_names, 325, mkChar("zhi"));
  SET_STRING_ELT(state_names, 326, mkChar("delay_zhi"));
  SET_STRING_ELT(state_names, 327, mkChar("dim_whi"));
  SET_STRING_ELT(state_names, 328, mkChar("whi"));
  SET_STRING_ELT(state_names, 329, mkChar("delay_whi"));
  SET_STRING_ELT(state_names, 330, mkChar("dim_av_mosq"));
  SET_STRING_ELT(state_names, 331, mkChar("av_mosq"));
  SET_STRING_ELT(state_names, 332, mkChar("delay_av_mosq"));
  SET_STRING_ELT(state_names, 333, mkChar("dim_av_human"));
  SET_STRING_ELT(state_names, 334, mkChar("av_human"));
  SET_STRING_ELT(state_names, 335, mkChar("delay_av_human"));
  SET_STRING_ELT(state_names, 336, mkChar("dim_den"));
  SET_STRING_ELT(state_names, 337, mkChar("den"));
  SET_STRING_ELT(state_names, 338, mkChar("dim_prev0to59"));
  SET_STRING_ELT(state_names, 339, mkChar("dim_prev0to59_1"));
  SET_STRING_ELT(state_names, 340, mkChar("dim_prev0to59_2"));
  SET_STRING_ELT(state_names, 341, mkChar("dim_prev0to59_3"));
  SET_STRING_ELT(state_names, 342, mkChar("dim_prev0to59_12"));
  SET_STRING_ELT(state_names, 343, mkChar("prev0to59"));
  SET_STRING_ELT(state_names, 344, mkChar("dim_clin_inc0to5"));
  SET_STRING_ELT(state_names, 345, mkChar("dim_clin_inc0to5_1"));
  SET_STRING_ELT(state_names, 346, mkChar("dim_clin_inc0to5_2"));
  SET_STRING_ELT(state_names, 347, mkChar("dim_clin_inc0to5_3"));
  SET_STRING_ELT(state_names, 348, mkChar("dim_clin_inc0to5_12"));
  SET_STRING_ELT(state_names, 349, mkChar("clin_inc0to5"));
  SET_STRING_ELT(state_names, 350, mkChar("dim_delay_FOI"));
  SET_STRING_ELT(state_names, 351, mkChar("delay_i_FOI"));
  SET_STRING_ELT(state_names, 352, mkChar("delay_state_FOI"));
  SET_STRING_ELT(state_names, 353, mkChar("dim_delay_FOIv"));
  SET_STRING_ELT(state_names, 354, mkChar("delay_i_FOIv"));
  SET_STRING_ELT(state_names, 355, mkChar("delay_state_FOIv"));
  SET_STRING_ELT(state_names, 356, mkChar("dim_delay_incv"));
  SET_STRING_ELT(state_names, 357, mkChar("delay_i_incv"));
  SET_STRING_ELT(state_names, 358, mkChar("delay_state_incv"));
  SET_STRING_ELT(state_names, 359, mkChar("dim"));
  SET_STRING_ELT(state_names, 360, mkChar("dim_output"));
  setAttrib(state, R_NamesSymbol, state_names);
  UNPROTECT(2);
  return state;
}

// Report back to R information on variable ordering
// The reported information includes position and length of each
// variable, from which offset, etc, can be worked out.
SEXP odin_model_variable_order(SEXP odin_model_ptr) {
  odin_model_pars *odin_model_p = odin_model_get_pointer(odin_model_ptr, 1);
  int *tmp;
  SEXP state_len = PROTECT(allocVector(VECSXP, 16));
  SEXP state_names = PROTECT(allocVector(STRSXP, 16));
  SET_VECTOR_ELT(state_len, 0, R_NilValue);
  SET_STRING_ELT(state_names, 0, mkChar("Sv"));
  SET_VECTOR_ELT(state_len, 1, R_NilValue);
  SET_STRING_ELT(state_names, 1, mkChar("Iv"));
  SET_VECTOR_ELT(state_len, 2, R_NilValue);
  SET_STRING_ELT(state_names, 2, mkChar("EL"));
  SET_VECTOR_ELT(state_len, 3, R_NilValue);
  SET_STRING_ELT(state_names, 3, mkChar("LL"));
  SET_VECTOR_ELT(state_len, 4, R_NilValue);
  SET_STRING_ELT(state_names, 4, mkChar("PL"));
  SET_VECTOR_ELT(state_len, 5, ScalarInteger(odin_model_p->dim_Ev));
  SET_STRING_ELT(state_names, 5, mkChar("Ev"));
  SET_VECTOR_ELT(state_len, 6, allocVector(INTSXP, 3));
  tmp = INTEGER(VECTOR_ELT(state_len, 6));
  tmp[0] = odin_model_p->dim_S_1;
  tmp[1] = odin_model_p->dim_S_2;
  tmp[2] = odin_model_p->dim_S_3;
  SET_STRING_ELT(state_names, 6, mkChar("S"));
  SET_VECTOR_ELT(state_len, 7, allocVector(INTSXP, 3));
  tmp = INTEGER(VECTOR_ELT(state_len, 7));
  tmp[0] = odin_model_p->dim_T_1;
  tmp[1] = odin_model_p->dim_T_2;
  tmp[2] = odin_model_p->dim_T_3;
  SET_STRING_ELT(state_names, 7, mkChar("T"));
  SET_VECTOR_ELT(state_len, 8, allocVector(INTSXP, 3));
  tmp = INTEGER(VECTOR_ELT(state_len, 8));
  tmp[0] = odin_model_p->dim_D_1;
  tmp[1] = odin_model_p->dim_D_2;
  tmp[2] = odin_model_p->dim_D_3;
  SET_STRING_ELT(state_names, 8, mkChar("D"));
  SET_VECTOR_ELT(state_len, 9, allocVector(INTSXP, 3));
  tmp = INTEGER(VECTOR_ELT(state_len, 9));
  tmp[0] = odin_model_p->dim_A_1;
  tmp[1] = odin_model_p->dim_A_2;
  tmp[2] = odin_model_p->dim_A_3;
  SET_STRING_ELT(state_names, 9, mkChar("A"));
  SET_VECTOR_ELT(state_len, 10, allocVector(INTSXP, 3));
  tmp = INTEGER(VECTOR_ELT(state_len, 10));
  tmp[0] = odin_model_p->dim_U_1;
  tmp[1] = odin_model_p->dim_U_2;
  tmp[2] = odin_model_p->dim_U_3;
  SET_STRING_ELT(state_names, 10, mkChar("U"));
  SET_VECTOR_ELT(state_len, 11, allocVector(INTSXP, 3));
  tmp = INTEGER(VECTOR_ELT(state_len, 11));
  tmp[0] = odin_model_p->dim_P_1;
  tmp[1] = odin_model_p->dim_P_2;
  tmp[2] = odin_model_p->dim_P_3;
  SET_STRING_ELT(state_names, 11, mkChar("P"));
  SET_VECTOR_ELT(state_len, 12, allocVector(INTSXP, 3));
  tmp = INTEGER(VECTOR_ELT(state_len, 12));
  tmp[0] = odin_model_p->dim_ICM_1;
  tmp[1] = odin_model_p->dim_ICM_2;
  tmp[2] = odin_model_p->dim_ICM_3;
  SET_STRING_ELT(state_names, 12, mkChar("ICM"));
  SET_VECTOR_ELT(state_len, 13, allocVector(INTSXP, 3));
  tmp = INTEGER(VECTOR_ELT(state_len, 13));
  tmp[0] = odin_model_p->dim_ICA_1;
  tmp[1] = odin_model_p->dim_ICA_2;
  tmp[2] = odin_model_p->dim_ICA_3;
  SET_STRING_ELT(state_names, 13, mkChar("ICA"));
  SET_VECTOR_ELT(state_len, 14, allocVector(INTSXP, 3));
  tmp = INTEGER(VECTOR_ELT(state_len, 14));
  tmp[0] = odin_model_p->dim_IB_1;
  tmp[1] = odin_model_p->dim_IB_2;
  tmp[2] = odin_model_p->dim_IB_3;
  SET_STRING_ELT(state_names, 14, mkChar("IB"));
  SET_VECTOR_ELT(state_len, 15, allocVector(INTSXP, 3));
  tmp = INTEGER(VECTOR_ELT(state_len, 15));
  tmp[0] = odin_model_p->dim_ID_1;
  tmp[1] = odin_model_p->dim_ID_2;
  tmp[2] = odin_model_p->dim_ID_3;
  SET_STRING_ELT(state_names, 15, mkChar("ID"));
  setAttrib(state_len, R_NamesSymbol, state_names);
  UNPROTECT(2);
  return state_len;
}

// Report back to R information on output variable ordering
// Like the variable order above, but for any output vars
SEXP odin_model_output_order(SEXP odin_model_ptr) {
  odin_model_pars *odin_model_p = odin_model_get_pointer(odin_model_ptr, 1);
  SEXP state_len = PROTECT(allocVector(VECSXP, 23));
  SEXP state_names = PROTECT(allocVector(STRSXP, 23));
  SET_VECTOR_ELT(state_len, 0, R_NilValue);
  SET_STRING_ELT(state_names, 0, mkChar("Sout"));
  SET_VECTOR_ELT(state_len, 1, R_NilValue);
  SET_STRING_ELT(state_names, 1, mkChar("Tout"));
  SET_VECTOR_ELT(state_len, 2, R_NilValue);
  SET_STRING_ELT(state_names, 2, mkChar("Dout"));
  SET_VECTOR_ELT(state_len, 3, R_NilValue);
  SET_STRING_ELT(state_names, 3, mkChar("Aout"));
  SET_VECTOR_ELT(state_len, 4, R_NilValue);
  SET_STRING_ELT(state_names, 4, mkChar("Uout"));
  SET_VECTOR_ELT(state_len, 5, R_NilValue);
  SET_STRING_ELT(state_names, 5, mkChar("Pout"));
  SET_VECTOR_ELT(state_len, 6, R_NilValue);
  SET_STRING_ELT(state_names, 6, mkChar("prev"));
  SET_VECTOR_ELT(state_len, 7, R_NilValue);
  SET_STRING_ELT(state_names, 7, mkChar("inc05"));
  SET_VECTOR_ELT(state_len, 8, R_NilValue);
  SET_STRING_ELT(state_names, 8, mkChar("inc"));
  SET_VECTOR_ELT(state_len, 9, R_NilValue);
  SET_STRING_ELT(state_names, 9, mkChar("mu"));
  SET_VECTOR_ELT(state_len, 10, R_NilValue);
  SET_STRING_ELT(state_names, 10, mkChar("beta_larval"));
  SET_VECTOR_ELT(state_len, 11, R_NilValue);
  SET_STRING_ELT(state_names, 11, mkChar("KL"));
  SET_VECTOR_ELT(state_len, 12, R_NilValue);
  SET_STRING_ELT(state_names, 12, mkChar("mv"));
  SET_VECTOR_ELT(state_len, 13, R_NilValue);
  SET_STRING_ELT(state_names, 13, mkChar("Q"));
  SET_VECTOR_ELT(state_len, 14, R_NilValue);
  SET_STRING_ELT(state_names, 14, mkChar("wh"));
  SET_VECTOR_ELT(state_len, 15, R_NilValue);
  SET_STRING_ELT(state_names, 15, mkChar("d_ITN"));
  SET_VECTOR_ELT(state_len, 16, R_NilValue);
  SET_STRING_ELT(state_names, 16, mkChar("r_ITN"));
  SET_VECTOR_ELT(state_len, 17, R_NilValue);
  SET_STRING_ELT(state_names, 17, mkChar("s_ITN"));
  SET_VECTOR_ELT(state_len, 18, R_NilValue);
  SET_STRING_ELT(state_names, 18, mkChar("d_IRS"));
  SET_VECTOR_ELT(state_len, 19, R_NilValue);
  SET_STRING_ELT(state_names, 19, mkChar("r_IRS"));
  SET_VECTOR_ELT(state_len, 20, R_NilValue);
  SET_STRING_ELT(state_names, 20, mkChar("s_IRS"));
  SET_VECTOR_ELT(state_len, 21, R_NilValue);
  SET_STRING_ELT(state_names, 21, mkChar("K0"));
  SET_VECTOR_ELT(state_len, 22, ScalarInteger(odin_model_p->dim_cov));
  SET_STRING_ELT(state_names, 22, mkChar("cov"));
  setAttrib(state_len, R_NamesSymbol, state_names);
  UNPROTECT(2);
  return state_len;
}

odin_model_pars* odin_model_get_pointer(SEXP odin_model_ptr, int closed_error) {
  odin_model_pars *odin_model_p = NULL;
  if (TYPEOF(odin_model_ptr) != EXTPTRSXP) {
    Rf_error("Expected an external pointer");
  }
  odin_model_p = (odin_model_pars*) R_ExternalPtrAddr(odin_model_ptr);
  if (!odin_model_p && closed_error) {
    Rf_error("Pointer has been invalidated");
  }
  return odin_model_p;
}

SEXP get_ds_pars() {
  static DL_FUNC get_deSolve_gparms = NULL;
  if (get_deSolve_gparms == NULL) {
    get_deSolve_gparms = R_GetCCallable("deSolve", "get_deSolve_gparms");
  }
  return get_deSolve_gparms();
}
double fmodr(double x, double y) {
  double tmp = fmod(x, y);
  if (tmp * y < 0) {
    tmp += y;
  }
  return tmp;
}
void lagvalue_dde(double t, int *idx, size_t dim_idx, double *state) {
  typedef void (*lagvalue_type)(double, int*, size_t, double*);
  static lagvalue_type fun = NULL;
  if (fun == NULL) {
    fun = (lagvalue_type)R_GetCCallable("dde", "ylag_vec_int");
  }
  fun(t, idx, dim_idx, state);
}
void lagvalue_ds(double t, int *idx, int dim_idx, double *state) {
  typedef void (*lagvalue_type)(double, int*, int, double*);
  static lagvalue_type fun = NULL;
  if (fun == NULL) {
    fun = (lagvalue_type)R_GetCCallable("deSolve", "lagvalue");
  }
  fun(t, idx, dim_idx, state);
}
int get_user_int(SEXP user, const char *name, int default_value) {
  int ret = default_value;
  SEXP el = get_list_element(user, name);
  if (el != R_NilValue) {
    if (length(el) != 1) {
      Rf_error("Expected scalar integer for %d", name);
    }
    ret = INTEGER(coerceVector(el, INTSXP))[0];
  }
  if (ret == NA_INTEGER) {
    Rf_error("Expected value for %s", name);
  }
  return ret;
}
double get_user_double(SEXP user, const char *name, double default_value) {
  double ret = default_value;
  SEXP el = get_list_element(user, name);
  if (el != R_NilValue) {
    if (length(el) != 1) {
      Rf_error("Expected scalar numeric for %s", name);
    }
    if (TYPEOF(el) == REALSXP) {
      ret = REAL(el)[0];
    } else if (TYPEOF(el) == INTSXP) {
      ret = INTEGER(el)[0];
    } else {
      Rf_error("Expected a numeric value for %s", name);
    }
  }
  if (ISNA(ret)) {
    Rf_error("Expected value for %s", name);
  }
  return ret;
}
void get_user_array(SEXP user, const char *name, bool is_real, void *dest, int nd, ...) {
  SEXP el = get_user_array_check_rank(user, name, nd);
  SEXP r_dim;
  int *dim;

  if (nd == 1) {
    r_dim = PROTECT(ScalarInteger(LENGTH(el)));
  } else {
    r_dim = PROTECT(coerceVector(getAttrib(el, R_DimSymbol), INTSXP));
  }
  dim = INTEGER(r_dim);

  va_list ap;
  va_start(ap, nd);
  for (size_t i = 0; i < (size_t) nd; ++i) {
    int dim_expected = va_arg(ap, int);
    if (dim[i] != dim_expected) {
      va_end(ap); // avoid a leak
      if (nd == 1) {
        Rf_error("Expected length %d value for %s", dim_expected, name);
      } else {
        Rf_error("Incorrect size of dimension %d of %s (expected %d)",
                 i + 1, name, dim_expected);
      }
    }
  }
  va_end(ap);
  UNPROTECT(1);

  get_user_array_copy(el, name, is_real, dest);
}
SEXP get_user_array_check_rank(SEXP user, const char *name, int nd) {
  SEXP el = get_list_element(user, name);
  if (el == R_NilValue) {
    Rf_error("Expected value for %s", name);
  } else {
    if (nd == 1) {
      if (isArray(el)) {
        // this may be too strict as a length-1 dim here will fail
        Rf_error("Expected a vector for %s", name);
      }
    } else {
      SEXP r_dim = getAttrib(el, R_DimSymbol);
      if (r_dim == R_NilValue || LENGTH(r_dim) != nd) {
        if (nd == 2) {
          Rf_error("Expected a matrix for %s", name);
        } else {
          Rf_error("Expected a %dd array for %s", nd, name);
        }
      }
    }
  }
  return el;
}
void get_user_array_copy(SEXP el, const char *name, bool is_real, void *dest) {
  int given_int = TYPEOF(el) == INTSXP;
  size_t n = (size_t) length(el);
  if (is_real) {
    if (given_int) {
      el = PROTECT(coerceVector(el, REALSXP));
    } else if (TYPEOF(el) != REALSXP) {
      Rf_error("Expected a numeric value for %s", name);
    }
    memcpy(dest, REAL(el), n * sizeof(double));
  } else {
    if (TYPEOF(el) == REALSXP) {
      el = PROTECT(coerceVector(el, INTSXP));
    } else if (TYPEOF(el) != INTSXP) {
      Rf_error("Expected a numeric value for %s", name);
    }
    memcpy(dest, INTEGER(el), n * sizeof(int));
  }
  if (given_int == is_real) {
    UNPROTECT(1);
  }
}
void odin_set_dim(SEXP target, int nd, ...) {
  SEXP r_dim = PROTECT(allocVector(INTSXP, nd));
  int *dim = INTEGER(r_dim);

  va_list ap;
  va_start(ap, nd);
  for (size_t i = 0; i < (size_t)nd; ++i) {
    dim[i] = va_arg(ap, int);
  }
  va_end(ap);

  setAttrib(target, R_DimSymbol, r_dim);
  UNPROTECT(1);
}
SEXP get_list_element(SEXP list, const char *name) {
  SEXP ret = R_NilValue, names = getAttrib(list, R_NamesSymbol);
  for (int i = 0; i < length(list); ++i) {
    if(strcmp(CHAR(STRING_ELT(names, i)), name) == 0) {
      ret = VECTOR_ELT(list, i);
      break;
    }
  }
  return ret;
}
double odin_sum1(double *x, int from_i, int to_i) {
  double tot = 0.0;
  for (int i = from_i; i <= to_i; ++i) {
    tot += x[i];
  }
  return tot;
}
double odin_sum3(double *x, int from_i, int to_i, int from_j, int to_j, int from_k, int to_k, int dim_x_1, int dim_x_12) {
  double tot = 0.0;
  for (int k = from_k; k <= to_k; ++k) {
    int kk = k * dim_x_12;
    for (int j = from_j; j <= to_j; ++j) {
      int jj = j * dim_x_1 + kk;
      for (int i = from_i; i <= to_i; ++i) {
        tot += x[i + jj];
      }
    }
  }
  return tot;
}
